# 05.1 - DeployHQ Professional Setup

**Configure professional-grade deployment pipeline using DeployHQ service**

## üéØ Purpose

Set up professional-grade deployment pipeline using DeployHQ service for enterprise-level Laravel application deployment with advanced build optimization and zero-downtime deployment capabilities.

## ‚ö° Quick Reference

- **Time Required**: ~45 minutes (includes external service setup)
- **Prerequisites**: Git repository, server access, DeployHQ account
- **Critical Path**: Account setup ‚Üí Project configuration ‚Üí Build pipeline ‚Üí Deployment settings

---

## üìã Phase 1: DeployHQ Account and Project Setup

### 1.1 DeployHQ Service Registration

```bash
echo "üè≠ DeployHQ Professional Setup Guide"
echo "==================================="
echo ""
echo "Step 1: Account Creation"
echo "----------------------"
echo "1. Visit: https://www.deployhq.com"
echo "2. Sign up for professional account"
echo "3. Choose plan: Professional or Enterprise"
echo "4. Complete account verification"
echo ""
echo "üí∞ DeployHQ Pricing Plans:"
echo "   ‚Ä¢ Starter: $15/month (5 projects, basic features)"
echo "   ‚Ä¢ Professional: $25/month (15 projects, advanced features)"
echo "   ‚Ä¢ Enterprise: $50/month (unlimited projects, enterprise features)"
echo ""
echo "‚úÖ Benefits of DeployHQ Professional:"
echo "   ‚Ä¢ Professional build infrastructure"
echo "   ‚Ä¢ Zero-downtime deployment"
echo "   ‚Ä¢ Advanced rollback capabilities"
echo "   ‚Ä¢ Build artifact caching"
echo "   ‚Ä¢ Multi-environment management"
echo "   ‚Ä¢ Deployment notifications"
echo "   ‚Ä¢ Performance monitoring"
echo ""
echo "‚è≥ Please complete account setup before continuing..."
read -p "Press Enter after creating DeployHQ account..."
```

### 1.2 Create DeployHQ Project

```bash
echo "üì¶ Creating DeployHQ Project Configuration"
echo "========================================="
echo ""
echo "Step 2: Project Creation in DeployHQ Dashboard"
echo "---------------------------------------------"
echo ""
echo "1. Login to DeployHQ dashboard"
echo "2. Click 'New Project'"
echo "3. Project Configuration:"
echo ""
echo "   Project Name: [Your Laravel App Name]"
echo "   Repository URL: $(git config remote.origin.url)"
echo "   Branch: main (primary), staging, production"
echo "   Repository Type: Git"
echo ""
echo "4. Repository Access Setup:"
echo "   - If private repo: Add DeployHQ SSH key to GitHub"
echo "   - Public key location: DeployHQ Dashboard ‚Üí Project Settings ‚Üí Repository"
echo "   - Add key to GitHub: Settings ‚Üí Deploy Keys ‚Üí Add Deploy Key"
echo ""
echo "5. Save project and note project ID"
echo ""
echo "‚è≥ Please complete project creation before continuing..."
read -p "Press Enter after creating DeployHQ project..."
```

### 1.3 Configure Repository Access

Create repository access documentation:

```bash
# Create documentation for repository access setup
mkdir -p Admin-Local/server_deployment/configs
cat > Admin-Local/server_deployment/configs/deployhq_repository_setup.md << 'EOF'
# DeployHQ Repository Access Configuration

## GitHub Repository Integration

### Public Repository (Easier Setup)
- Repository URL: Use HTTPS format
- No additional authentication required
- DeployHQ automatically accesses public repos

### Private Repository (Secure Setup)
1. Get DeployHQ SSH public key from project settings
2. Add to GitHub repository: Settings ‚Üí Deploy Keys
3. Grant read access to repository
4. Use SSH format: git@github.com:username/repository.git

## Branch Configuration

### Environment Mapping
- `main` branch ‚Üí Staging deployment
- `staging` branch ‚Üí Staging deployment (if separate)  
- `production` branch ‚Üí Production deployment

### Auto-Deploy Settings
- Enable automatic deployment on push
- Configure environment-specific builds
- Set deployment approval requirements (production)

## Webhook Integration
- DeployHQ automatically configures GitHub webhooks
- Verify webhook is active in GitHub repository settings
- Test webhook delivery after setup

EOF

echo "‚úÖ Repository access documentation created"
echo ""
echo "üìã Repository Setup Checklist:"
echo "   [ ] Repository connected to DeployHQ"
echo "   [ ] SSH keys configured (if private repo)"
echo "   [ ] Webhooks active and tested"
echo "   [ ] Branch permissions configured"
```

**‚úÖ Expected Result:**
- DeployHQ project created and configured
- Repository access established  
- Webhook integration active
- Ready for build pipeline configuration

---

## üìã Phase 2: Build Pipeline Configuration

### 2.1 Environment Requirements Analysis

```bash
# Analyze current project requirements
echo "üîç Analyzing Project Environment Requirements"
echo "==========================================="
echo ""

# Check current PHP version requirement
if [ -f "composer.json" ]; then
    PHP_REQUIREMENT=$(grep -o '"php": "[^"]*"' composer.json | cut -d'"' -f4 2>/dev/null || echo ">=8.0")
    echo "üìã PHP Requirement from composer.json: $PHP_REQUIREMENT"
else
    echo "‚ö†Ô∏è No composer.json found"
    PHP_REQUIREMENT=">=8.2"
fi

# Check Node.js requirement
if [ -f "package.json" ]; then
    NODE_REQUIREMENT=$(grep -o '"node": "[^"]*"' package.json | cut -d'"' -f4 2>/dev/null || echo ">=18.0")
    echo "üìã Node.js Requirement from package.json: $NODE_REQUIREMENT"
    
    # Check for package manager preference
    if [ -f "yarn.lock" ]; then
        PACKAGE_MANAGER="yarn"
        echo "üìã Package Manager: Yarn (yarn.lock detected)"
    elif [ -f "pnpm-lock.yaml" ]; then
        PACKAGE_MANAGER="pnpm"
        echo "üìã Package Manager: PNPM (pnpm-lock.yaml detected)"
    else
        PACKAGE_MANAGER="npm"
        echo "üìã Package Manager: NPM (default)"
    fi
else
    echo "‚ÑπÔ∏è No package.json found - no frontend build required"
    NODE_REQUIREMENT="none"
    PACKAGE_MANAGER="none"
fi

# Check Laravel version
if [ -f "artisan" ]; then
    LARAVEL_VERSION=$(php artisan --version 2>/dev/null | grep -o '[0-9.]*' | head -1 || echo "unknown")
    echo "üìã Laravel Version: $LARAVEL_VERSION"
else
    echo "‚ö†Ô∏è No Laravel artisan found"
    LARAVEL_VERSION="unknown"
fi

# Check server PHP version requirement
echo ""
echo "üñ•Ô∏è Server Environment Analysis:"
echo "   Current PHP: $(php -r 'echo PHP_VERSION;')"
echo "   Required PHP: $PHP_REQUIREMENT"
echo "   Current Node.js: $(node --version 2>/dev/null || echo 'Not installed')"
echo "   Required Node.js: $NODE_REQUIREMENT"
echo "   Package Manager: $PACKAGE_MANAGER"
echo ""

# Create environment compatibility report
cat > Admin-Local/server_deployment/configs/environment_requirements.md << EOF
# Environment Requirements Analysis

## Project Requirements
- **Laravel Version**: $LARAVEL_VERSION
- **PHP Requirement**: $PHP_REQUIREMENT
- **Node.js Requirement**: $NODE_REQUIREMENT
- **Package Manager**: $PACKAGE_MANAGER

## DeployHQ Build Environment Configuration

### Required Language Versions
- **PHP**: 8.2 (matches Laravel 10+ requirements)
- **Node.js**: 18.x LTS (for modern frontend builds)
- **Composer**: 2.x (latest stable)

### Cache Configuration
- **Composer Cache**: ~/.composer/cache
- **NPM/Yarn Cache**: ~/.npm or ~/.yarn
- **Vendor Directory**: vendor (for faster builds)

### SSH Security
- **GitHub.com**: Required for repository access
- **GitLab.com**: If using GitLab repositories
- **Custom Git Hosts**: Add as needed

## Compatibility Check

### PHP Extensions Required by Laravel
$(php -m | grep -E "(openssl|pdo|mbstring|tokenizer|xml|ctype|json|bcmath|curl|fileinfo|gd|zip)" | sed 's/^/- /' || echo "- Run 'php -m' to check extensions")

### Node.js Features Used
$([ -f "package.json" ] && echo "- Frontend asset compilation required" || echo "- No frontend build needed")
$([ -f "vite.config.js" ] && echo "- Vite build system detected" || echo "")
$([ -f "webpack.mix.js" ] && echo "- Laravel Mix build system detected" || echo "")
$([ -f "tailwind.config.js" ] && echo "- Tailwind CSS configuration detected" || echo "")

EOF

echo "‚úÖ Environment requirements analysis completed"
echo "üìÅ Report saved to: Admin-Local/server_deployment/configs/environment_requirements.md"
```

### 2.2 Create Build Commands Documentation

```bash
# Create comprehensive build configuration
cat > Admin-Local/server_deployment/configs/deployhq_build_commands.md << 'EOF'
# DeployHQ Build Pipeline Configuration

## Build Environment Requirements

### System Dependencies
- PHP 8.2 with required extensions
- Composer 2.x
- Node.js 18.x with npm
- Git for repository operations

### Build Optimization Settings
- Memory limit: 512M
- Max execution time: 300 seconds
- Build timeout: 20 minutes

## Build Pipeline Configuration

### Multiple Build Commands Setup

#### Build Command 1: "Build Frontend Assets"
```bash
# Runtime: Node.js 18.x LTS
# Purpose: Compile React/Vue/Laravel Mix assets

# Install dependencies (production only for faster builds)
npm ci --only=production --no-audit --no-fund

# Build production assets
npm run build

# Verify build output exists
if [ -d "public/build" ] || [ -d "public/dist" ]; then
  echo "‚úÖ Frontend build successful"
  du -sh public/build/* 2>/dev/null || du -sh public/dist/* 2>/dev/null
else
  echo "‚ö†Ô∏è No build output detected"
  exit 1
fi

# Clean up node_modules to reduce deployment size
rm -rf node_modules
echo "üßπ Node modules cleaned"
```

#### Build Command 2: "Optimize Laravel"
```bash
# Runtime: PHP 8.3 or 8.2
# Purpose: Install and optimize PHP dependencies

# Set memory limit for Composer
export COMPOSER_MEMORY_LIMIT=-1

# Install production dependencies with optimization
composer install \
  --no-dev \
  --optimize-autoloader \
  --no-interaction \
  --no-progress \
  --prefer-dist

# Generate optimized autoloader
composer dump-autoload --optimize --classmap-authoritative

# Verify Composer installation
composer validate --no-check-publish

echo "‚úÖ Laravel optimization complete"
```

#### Build Command 3: "Laravel Cache Optimization" (Optional)
```bash
# Runtime: PHP 8.3 or 8.2
# Purpose: Pre-cache Laravel configurations

# Create temporary environment for caching
cp .env.example .env.temp
echo "APP_KEY=$(openssl rand -base64 32)" >> .env.temp
mv .env.temp .env

# Cache Laravel configurations
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Generate optimized class map
php artisan optimize

# Remove temporary environment file
rm .env

echo "‚úÖ Laravel caching complete"
```

### 4. Laravel Application Optimization
```bash
# Create temporary environment for optimization
cp .env.example .env.build
echo "APP_KEY=$(openssl rand -base64 32)" >> .env.build
mv .env.build .env

# Cache Laravel configurations
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Generate optimized class map
php artisan optimize

# Remove temporary environment file
rm .env

# Verify optimization
echo "üìä Optimization verification:"
ls -la bootstrap/cache/
```

### 5. Security and Cleanup
```bash
# Remove development files
rm -f .env.example
rm -f .env.testing
rm -rf tests/
rm -rf .github/workflows/test.yml

# Remove sensitive files
rm -f composer.lock.backup
rm -f package-lock.json.backup

# Set proper file permissions
find . -type f -exec chmod 644 {} \;
find . -type d -exec chmod 755 {} \;

# Verify final package
echo "üì¶ Final package contents:"
du -sh * | sort -hr | head -10
```

## Build Quality Verification

### Quality Checks
```bash
# Verify PHP syntax
find . -name "*.php" -exec php -l {} \; | grep -v "No syntax errors"

# Check Composer dependencies
composer validate --no-check-publish

# Verify Laravel can boot
php artisan --version

echo "‚úÖ Build quality verification complete"
```

### Performance Optimization
```bash
# OPcache preloading preparation
if [ -f "config/opcache.php" ]; then
  php artisan opcache:compile
fi

# Generate route manifest for faster routing
php artisan route:cache --verbose

echo "‚ö° Performance optimization complete"
```

EOF

echo "‚úÖ Build commands documentation created"
```

### 2.2 Configure DeployHQ Build Environment

```bash
echo "üîß DeployHQ Build Environment Configuration"
echo "=========================================="
echo ""
echo "Step 3: Configure Build Environment in DeployHQ Dashboard"
echo "-------------------------------------------------------"
echo ""
echo "üìã PHASE 1: Language Versions Configuration"
echo ""
echo "1. Navigate to: Project ‚Üí Build Pipeline ‚Üí Build Configuration"
echo ""
echo "2. Configure Language Versions:"
echo "   üîß PHP Version: Click 'Change Version' ‚Üí Select 8.2"
echo "   üîß Node.js Version: Click 'Change Version' ‚Üí Select 18.x (latest LTS)"
echo "   üîß Ruby Version: Keep default (if needed for Jekyll/Sass)"
echo "   üîß Python Version: Keep default (if needed for build tools)"
echo ""
echo "3. Configure Package Managers:"
echo "   üì¶ Composer: Click 'Change Version' ‚Üí Select 2.x (latest)"
echo "   üì¶ NPM: Automatically matches Node.js version"
echo "   üì¶ Yarn: Configure if using Yarn instead of NPM"
echo ""
echo "üìã PHASE 2: Build Cache Configuration"
echo ""
echo "4. Setup Build Cache Files:"
echo "   Click 'Build Cache Files' ‚Üí 'New Cached File'"
echo ""
echo "   Cache Entry 1:"
echo "   üìÇ Name: Composer Cache"
echo "   üìÇ Path: ~/.composer/cache"
echo ""
echo "   Cache Entry 2:"
echo "   üìÇ Name: NPM Cache"
echo "   üìÇ Path: ~/.npm"
echo ""
echo "   Cache Entry 3:"
echo "   üìÇ Name: Vendor Directory"
echo "   üìÇ Path: vendor"
echo ""
echo "üìã PHASE 3: SSH Security Configuration"
echo ""
echo "5. Configure Known Hosts for SSH:"
echo "   Click 'Build Known Hosts' ‚Üí 'New Known Host'"
echo ""
echo "   Host 1:"
echo "   üîë Host: github.com"
echo "   üîë Key: ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=="
echo ""
echo "   Host 2 (if using GitLab):"
echo "   üîë Host: gitlab.com"
echo "   üîë Key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDIwn5pGh1QcDDP68pTy4j6JOO84FWGG8k8f2Z6JzJ5g+O1"
echo ""
echo "‚è≥ Please configure build environment in DeployHQ..."
read -p "Press Enter after configuring build environment..."
```

### 2.3 Configure DeployHQ Build Commands

```bash
echo "üìù DeployHQ Build Commands Configuration"
echo "======================================"
echo ""
echo "Step 4: Configure Build Commands in DeployHQ Dashboard"
echo "----------------------------------------------------"
echo ""
echo "1. Navigate to: Project ‚Üí Build Pipeline ‚Üí Build Commands"
echo ""
echo "2. Build Settings:"
echo "   ‚úÖ Memory Limit: 512M"
echo "   ‚úÖ Build Timeout: 20 minutes"
echo "   ‚úÖ Build Environment: Use configured versions above"
echo ""
echo "3. Copy build commands from:"
echo "   üìÑ Admin-Local/server_deployment/configs/deployhq_build_commands.md"
echo ""
echo "4. Paste into DeployHQ build commands section"
echo ""
echo "5. Build Triggers:"
echo "   ‚úÖ Automatic build on push"
echo "   ‚úÖ Manual build trigger available"
echo "   ‚úÖ Environment-specific builds"
echo ""
echo "‚è≥ Please configure build commands in DeployHQ..."
read -p "Press Enter after configuring build commands..."
```

### 2.4 Verify Build Environment Configuration

```bash
echo "‚úÖ DeployHQ Build Environment Verification"
echo "========================================"
echo ""
echo "üìã Environment Configuration Checklist:"
echo ""
echo "‚úÖ Language Versions (in DeployHQ Build Configuration):"
echo "   [ ] PHP 8.2 selected and matches project requirements"
echo "   [ ] Node.js 18.x LTS selected for frontend builds"
echo "   [ ] Composer 2.x configured for dependency management"
echo "   [ ] Package manager (NPM/Yarn) matches project lock files"
echo ""
echo "‚úÖ Build Cache Configuration:"
echo "   [ ] Composer cache (~/.composer/cache) configured"
echo "   [ ] NPM cache (~/.npm) configured"
echo "   [ ] Vendor directory cache configured"
echo "   [ ] Additional project-specific caches added"
echo ""
echo "‚úÖ SSH Security Configuration:"
echo "   [ ] GitHub.com known host added"
echo "   [ ] GitLab.com known host added (if using GitLab)"
echo "   [ ] Custom Git hosts configured (if any)"
echo "   [ ] SSH keys properly configured for repository access"
echo ""
echo "‚úÖ Build Commands Configuration:"
echo "   [ ] Build commands documented and added to DeployHQ"
echo "   [ ] Memory limit set to 512M or higher"
echo "   [ ] Build timeout set to 20 minutes or appropriate"
echo "   [ ] Environment-specific build variations configured"
echo ""
echo "üîç Test Configuration:"
echo "   1. Trigger a test build in DeployHQ"
echo "   2. Monitor build logs for version confirmations"
echo "   3. Verify cache files are being used"
echo "   4. Confirm SSH connections work properly"
echo "   5. Check build artifacts are generated correctly"
echo ""

# Create verification script
cat > Admin-Local/server_deployment/scripts/verify_deployhq_environment.sh << 'EOF'
#!/bin/bash
# DeployHQ Environment Verification Script

echo "üîç DeployHQ Environment Verification"
echo "=================================="

# Check environment requirements file
if [ -f "Admin-Local/server_deployment/configs/environment_requirements.md" ]; then
    echo "‚úÖ Environment requirements documented"
    
    # Extract requirements
    REQUIRED_PHP=$(grep "PHP Requirement" Admin-Local/server_deployment/configs/environment_requirements.md | cut -d':' -f2 | xargs)
    REQUIRED_NODE=$(grep "Node.js Requirement" Admin-Local/server_deployment/configs/environment_requirements.md | cut -d':' -f2 | xargs)
    PACKAGE_MANAGER=$(grep "Package Manager" Admin-Local/server_deployment/configs/environment_requirements.md | cut -d':' -f2 | xargs)
    
    echo "üìã Project Requirements Summary:"
    echo "   PHP: $REQUIRED_PHP"
    echo "   Node.js: $REQUIRED_NODE"
    echo "   Package Manager: $PACKAGE_MANAGER"
else
    echo "‚ùå Environment requirements not documented"
    echo "Run the environment analysis step first"
fi

echo ""
echo "üìù DeployHQ Configuration Checklist:"
echo ""
echo "Manual verification required in DeployHQ dashboard:"
echo "1. Build Pipeline ‚Üí Build Configuration"
echo "2. Verify language versions match requirements above"
echo "3. Confirm cache files are configured"
echo "4. Check known hosts for SSH security"
echo "5. Test build with current configuration"
echo ""
echo "üöÄ Test Build Command for DeployHQ:"
echo "   git commit --allow-empty -m 'test: trigger DeployHQ build verification'"
echo "   git push origin main"

EOF

chmod +x Admin-Local/server_deployment/scripts/verify_deployhq_environment.sh

echo "‚úÖ Build environment verification script created"
echo "üìÅ Location: Admin-Local/server_deployment/scripts/verify_deployhq_environment.sh"
echo ""
echo "üîß Next Steps:"
echo "   1. Complete DeployHQ build environment configuration"
echo "   2. Run verification script: bash Admin-Local/server_deployment/scripts/verify_deployhq_environment.sh"
echo "   3. Test build configuration with empty commit"
echo "   4. Proceed to server configuration (Phase 3)"
```

**‚úÖ Expected Result:**
- Environment requirements analyzed and documented
- DeployHQ build environment configured to match project needs
- Build cache and SSH security properly configured
- Verification script ready for testing
- Professional deployment structure prepared

---

## üìã Phase 3: Server Configuration for DeployHQ

### 3.1 Configure Server Access for DeployHQ

```bash
echo "üîë Server Access Configuration for DeployHQ"
echo "==========================================="
echo ""
echo "Step 4: Server Configuration in DeployHQ Dashboard"
echo "-------------------------------------------------"
echo ""
echo "1. Navigate to: Project Settings ‚Üí Servers"
echo "2. Add New Server:"
echo ""
echo "   Server Name: [Your App Name] Production"
echo "   Protocol: SSH/SFTP"
echo "   Hostname: [Your Server IP]"
echo "   Port: [SSH Port - usually 22 or 65002]"
echo "   Username: [Your SSH Username]"
echo ""
echo "3. SSH Key Configuration:"
echo "   üìÑ Upload your private SSH key"
echo "   üîí Key file location: ~/.ssh/your_server_key"
echo ""
echo "4. Deployment Path Configuration:"
echo "   üìÅ Path: /home/username/domains/yourapp.com/releases/%RELEASE%"
echo "   üîÑ %RELEASE% will be replaced with timestamp"
echo ""
echo "5. Test Connection:"
echo "   ‚úÖ Use 'Test Connection' button in DeployHQ"
echo "   ‚úÖ Verify SSH access works"
echo ""

# Display SSH key setup instructions
echo "üìã SSH Key Setup Instructions:"
echo "1. Generate SSH key pair (if needed):"
echo "   ssh-keygen -t rsa -b 4096 -C \"deployhq@yourapp.com\""
echo ""
echo "2. Add public key to server:"
echo "   ssh-copy-id -i ~/.ssh/your_key.pub user@server"
echo ""
echo "3. Upload private key to DeployHQ"
echo ""
echo "‚è≥ Please configure server access in DeployHQ..."
read -p "Press Enter after configuring server settings..."
```

### 3.2 Create Deployment Scripts for DeployHQ

```bash
# Create DeployHQ-specific deployment configurations
cat > Admin-Local/server_deployment/configs/deployhq_deployment_commands.md << 'EOF'
# DeployHQ Deployment Commands Configuration

## Pre-deployment Commands (SSH Before Commands)
*Professional SSH command sequence executed before deployment*

### A01: System Preflight Checks
```bash
#!/bin/bash
# A01: System Pre-flight Checks
# Execution: Every deployment
# Purpose: Validate server environment and requirements
# Timeout: 5 minutes

echo "=== System Pre-flight Checks ==="

REQUIRED_COMMANDS=("php" "git" "composer" "curl" "find" "sed" "grep" "date" "touch" "rm" "ln" "mkdir" "chmod" "du" "tail" "xargs" "wc" "awk" "df")
FAILED_CHECKS=0

for cmd in "${REQUIRED_COMMANDS[@]}"; do
  if ! command -v "$cmd" &> /dev/null; then
    echo "‚ö†Ô∏è WARNING: Required command '$cmd' not found."
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
  else
    echo "‚úÖ Command '$cmd' found"
  fi
done

if command -v php &> /dev/null; then
  PHP_VERSION=$(php -r "echo PHP_VERSION;")
  if ! php -r "exit(version_compare(PHP_VERSION, '8.0.0', '>=') ? 0 : 1);" &> /dev/null; then
    echo "‚ö†Ô∏è WARNING: PHP version $PHP_VERSION < 8.0.0"
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
  else
    echo "‚úÖ PHP version $PHP_VERSION meets requirements"
  fi
fi

MIN_DISK_KB=1048576
AVAILABLE_DISK_KB=$(df -k "$(pwd)" 2>/dev/null | awk 'NR==2 {print $4}' || echo "999999999")
if [ "$AVAILABLE_DISK_KB" -lt "$MIN_DISK_KB" ]; then
  echo "‚ö†Ô∏è WARNING: Low disk space available"
  FAILED_CHECKS=$((FAILED_CHECKS + 1))
else
  echo "‚úÖ Sufficient disk space available"
fi

if [ "$FAILED_CHECKS" -ne 0 ]; then
  echo "‚ö†Ô∏è Pre-flight completed with $FAILED_CHECKS warning(s)"
else
  echo "‚úÖ All pre-flight checks passed"
fi

exit 0
```

### A02: Backup Current Release
```bash
#!/bin/bash
# A02: Backup Current Release
# Execution: Every deployment
# Purpose: Backup current release files and prepare backup directories
# Timeout: 5 minutes

echo "=== Backup Current Release ==="

DEPLOY_BASE="$(pwd | sed 's|/releases/.*||')"
SHARED_PATH="$DEPLOY_BASE/shared"
CURRENT_PATH="$DEPLOY_BASE/current"

# Create backup directory structure
BACKUP_ROOT="$SHARED_PATH/backups"
DEPLOYMENT_TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
CURRENT_BACKUP_DIR="$BACKUP_ROOT/deploy_production_${DEPLOYMENT_TIMESTAMP}"

echo "Creating backup directories..."
mkdir -p "$BACKUP_ROOT" || { echo "‚ùå Failed to create backup root"; exit 1; }
mkdir -p "$CURRENT_BACKUP_DIR" || { echo "‚ùå Failed to create deployment backup dir"; exit 1; }

# Backup current release files (if current release exists)
if [ -L "$CURRENT_PATH" ] && [ -d "$CURRENT_PATH" ]; then
  echo "üîÑ Backing up current release files..."
  CURRENT_RELEASE=$(basename "$(readlink "$CURRENT_PATH")")
  BACKUP_NAME="release_${CURRENT_RELEASE}_backup_$(date +%Y%m%d_%H%M%S)"
  
  cd "$DEPLOY_BASE/releases" || exit 1
  if tar -czf "$CURRENT_BACKUP_DIR/$BACKUP_NAME.tar.gz" "$CURRENT_RELEASE" 2>/dev/null; then
    BACKUP_SIZE=$(du -sh "$CURRENT_BACKUP_DIR/$BACKUP_NAME.tar.gz" | cut -f1)
    echo "‚úÖ Current release backed up: $BACKUP_NAME.tar.gz ($BACKUP_SIZE)"
  else
    echo "‚ö†Ô∏è Failed to create release backup, continuing..."
  fi
else
  echo "‚ÑπÔ∏è No current release to backup (first deployment)"
fi

# Handle public_html backup (universal detection)
cd "$DEPLOY_BASE" || exit 1
if [ -d "public_html" ] && [ ! -L "public_html" ]; then
  echo "üîÑ Backing up existing public_html directory..."
  BACKUP_NAME="public_html.backup.$(date +%Y%m%d_%H%M%S)"
  mv public_html "$CURRENT_BACKUP_DIR/$BACKUP_NAME"
  echo "‚úÖ public_html backed up to: $CURRENT_BACKUP_DIR/$BACKUP_NAME"
fi

echo "‚úÖ Backup system initialized: $CURRENT_BACKUP_DIR"
```

### A03: Database Backup
```bash
#!/bin/bash
# A03: Database Backup
# Execution: Every deployment
# Purpose: Create database backup before deployment
# Timeout: 10 minutes

echo "=== Database Backup ==="

if [ -f "../shared/.env" ]; then
  source "../shared/.env"
  
  if [ -n "$DB_DATABASE" ] && [ -n "$DB_USERNAME" ]; then
    BACKUP_FILE="../shared/backups/database_backup_$(date +%Y%m%d_%H%M%S).sql"
    
    echo "üîÑ Creating database backup..."
    if mysqldump -h"${DB_HOST:-localhost}" -u"$DB_USERNAME" -p"$DB_PASSWORD" "$DB_DATABASE" > "$BACKUP_FILE" 2>/dev/null; then
      BACKUP_SIZE=$(du -sh "$BACKUP_FILE" | cut -f1)
      echo "‚úÖ Database backup created: $(basename $BACKUP_FILE) ($BACKUP_SIZE)"
    else
      echo "‚ö†Ô∏è Database backup failed, continuing deployment..."
    fi
  else
    echo "‚ÑπÔ∏è Database credentials not found, skipping backup"
  fi
else
  echo "‚ÑπÔ∏è Environment file not found, skipping database backup"
fi
```

### A04: Enter Maintenance Mode
```bash
#!/bin/bash
# A04: Enter Maintenance Mode
# Execution: Every deployment
# Purpose: Put application in maintenance mode during deployment
# Timeout: 2 minutes

echo "=== Enter Maintenance Mode ==="

if [ -f "../current/artisan" ]; then
  cd ../current || exit 1
  
  echo "üîÑ Putting application into maintenance mode..."
  if php artisan down --render="maintenance" --secret="deploying" 2>/dev/null; then
    echo "‚úÖ Application is now in maintenance mode"
  else
    echo "‚ö†Ô∏è Failed to enter maintenance mode, continuing..."
  fi
else
  echo "‚ÑπÔ∏è No current application found (first deployment)"
fi
```

## Post-deployment Commands
*Run after deployment to activate new release*

```bash
# Link shared resources
echo "üîó Linking shared resources..."
ln -nfs ../shared/.env .env
rm -rf storage
ln -nfs ../shared/storage storage

# Set proper file permissions
echo "üîí Setting file permissions..."
find . -type f -exec chmod 644 {} \;
find . -type d -exec chmod 755 {} \;
chmod -R 775 storage bootstrap/cache 2>/dev/null || true

# Run database migrations
echo "üóÑÔ∏è Running database migrations..."
php artisan migrate --force --no-interaction

# Clear and rebuild cache
echo "‚ôªÔ∏è Rebuilding application cache..."
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Create storage link for public access
echo "üñºÔ∏è Creating storage link..."
php artisan storage:link

# Optimize application for production
echo "‚ö° Optimizing application..."
php artisan optimize

# Atomic symlink switch to new release
echo "üîÑ Switching to new release..."
cd ..
ln -nfs releases/%RELEASE% current

# Setup public_html symlink (first deployment only)
if [ ! -L public_html ]; then
  echo "üåê Setting up public_html symlink..."
  rm -rf public_html
  ln -s current/public public_html
fi

# Cleanup old releases (keep last 3)
echo "üßπ Cleaning up old releases..."
cd releases/
ls -t | tail -n +4 | xargs rm -rf 2>/dev/null || true

# Deployment verification
echo "‚úÖ Deployment verification..."
cd ../current
php artisan --version
php artisan about | head -5

echo "üéâ Deployment completed successfully!"
echo "üìä Release: %RELEASE%"
echo "üåê Site: https://yourapp.com"
```

## Rollback Commands
*For emergency rollback situations*

```bash
# Quick rollback to previous release
cd /path/to/your/app

# Find previous release
PREVIOUS_RELEASE=$(ls -t releases/ | head -2 | tail -1)

if [ -n "$PREVIOUS_RELEASE" ]; then
  echo "üîÑ Rolling back to: $PREVIOUS_RELEASE"
  ln -nfs releases/$PREVIOUS_RELEASE current
  echo "‚úÖ Rollback completed"
else
  echo "‚ùå No previous release found for rollback"
fi
```

EOF

echo "‚úÖ Deployment commands documentation created"
```

### 3.3 Configure DeployHQ Deployment Settings

```bash
echo "‚öôÔ∏è DeployHQ Deployment Settings Configuration"
echo "============================================"
echo ""
echo "Step 5: Configure Deployment Settings in DeployHQ"
echo "------------------------------------------------"
echo ""
echo "1. Navigate to: Project Settings ‚Üí Deployment"
echo ""
echo "2. Shared Directories (preserve between deployments):"
echo "   üìÅ storage"
echo ""
echo "3. Shared Files (preserve between deployments):"
echo "   üìÑ .env"
echo ""
echo "4. Copy Pre-deployment Commands from:"
echo "   üìÑ Admin-Local/server_deployment/configs/deployhq_deployment_commands.md"
echo "   Section: Pre-deployment Commands"
echo ""
echo "5. Copy Post-deployment Commands from:"
echo "   üìÑ Admin-Local/server_deployment/configs/deployhq_deployment_commands.md"
echo "   Section: Post-deployment Commands"
echo ""
echo "6. Deployment Options:"
echo "   ‚úÖ Zero-downtime deployment: Enabled"
echo "   ‚úÖ Keep releases: 3"
echo "   ‚úÖ Deployment notifications: Enabled"
echo "   ‚úÖ Manual approval for production: Enabled"
echo ""
echo "‚è≥ Please configure deployment settings in DeployHQ..."
read -p "Press Enter after configuring deployment settings..."
```

**‚úÖ Expected Result:**
- Server access configured in DeployHQ
- Deployment commands properly set
- Shared resources configuration active
- Zero-downtime deployment enabled

---

## üìã Phase 4: Testing and Verification

### 4.1 Test DeployHQ Configuration

```bash
# Commit configuration files
git add Admin-Local/server_deployment/configs/deployhq_*.md

git commit -m "feat: add comprehensive DeployHQ professional configuration

- Complete build pipeline with optimization
- Multi-environment deployment setup  
- Advanced monitoring and notifications
- Zero-downtime deployment with rollback
- Professional deployment management
- Enterprise-grade security configuration"

echo "‚úÖ Configuration files committed to repository"
echo ""
echo "üöÄ DeployHQ Test Deployment Process:"
echo "   1. Push to repository to trigger build"
echo "   2. Monitor build progress in DeployHQ dashboard"
echo "   3. Verify deployment to staging environment"
echo "   4. Test application functionality"
echo "   5. Approve production deployment (if ready)"
echo ""

# Test repository push
read -p "üöÄ Ready to trigger test deployment? (y/n): " trigger_deploy

if [ "$trigger_deploy" = "y" ]; then
    echo "üöÄ Triggering DeployHQ test deployment..."
    git push origin main
    
    echo ""
    echo "‚úÖ Push completed!"
    echo "üìä Monitor deployment progress:"
    echo "   1. Check DeployHQ dashboard for build status"
    echo "   2. Build should complete in 5-10 minutes"
    echo "   3. Deployment should complete in 2-3 minutes"
    echo "   4. Test site at: https://your-staging-url.com"
    echo ""
    echo "üîç Verification steps:"
    echo "   - Site loads correctly"
    echo "   - No deployment errors"
    echo "   - Database migrations applied"
    echo "   - Performance is optimal"
else
    echo "‚ÑπÔ∏è Test deployment skipped"
    echo "   Run 'git push origin main' when ready to test"
fi
```

### 4.2 DeployHQ Configuration Checklist

```bash
echo "üìã DeployHQ Professional Setup Verification"
echo "==========================================="
echo ""
echo "‚úÖ Account and Project Setup:"
echo "   [ ] DeployHQ professional account created"
echo "   [ ] Laravel project configured in DeployHQ"
echo "   [ ] Repository access established"
echo "   [ ] Webhooks active and tested"
echo ""
echo "‚úÖ Build Pipeline Configuration:"
echo "   [ ] Environment requirements analyzed and documented"
echo "   [ ] PHP 8.2 build environment configured in DeployHQ"
echo "   [ ] Node.js 18.x LTS configured for frontend builds"
echo "   [ ] Composer 2.x configured for dependency management"
echo "   [ ] Build cache files configured (Composer, NPM, Vendor)"
echo "   [ ] SSH known hosts configured for security"
echo "   [ ] Build commands documented and added to DeployHQ"
echo "   [ ] Build environment verification completed"
echo ""
echo "‚úÖ Server and Deployment Setup:"
echo "   [ ] SSH server access configured"
echo "   [ ] Deployment paths properly set"
echo "   [ ] Shared resources configuration"
echo "   [ ] Zero-downtime deployment enabled"
echo "   [ ] Automatic cleanup configured"
echo ""
echo "üéØ Professional Features Active:"
echo "   ‚ö° Zero-downtime deployment"
echo "   üîÑ Automatic rollback on failure"
echo "   üìä Build and deployment monitoring"
echo "   üîí Enterprise security standards"
echo "   üèóÔ∏è Professional build infrastructure"
echo "   üì± Multi-platform notifications"
```

**‚úÖ Final Expected State:**
- DeployHQ professional account active
- Complete build and deployment pipeline configured
- Multi-environment setup operational
- Professional monitoring and notifications active
- Enterprise-grade security and optimization features enabled

---

## üéØ Success Indicators

### ‚úÖ Setup Complete When You Have:
- **Professional Account**: DeployHQ enterprise features active
- **Build Pipeline**: Optimized professional build process
- **Zero Downtime**: Atomic deployment with instant rollback
- **Multi-Environment**: Staging and production workflows
- **Monitoring**: Real-time build and deployment tracking
- **Security**: Enterprise-grade security configurations
- **Documentation**: Comprehensive setup and operation guides

## üìã Next Steps

‚úÖ **04.1 Complete** - DeployHQ professional setup configured  
üîÑ **Continue to**: [04.2 - Professional Build and Deployment](./04.2-Professional-Build-Deployment.md)  
üéØ **Optional**: Configure additional monitoring integrations  
üìä **Enterprise**: Set up advanced reporting and analytics

---

**üéâ Congratulations!**

Your DeployHQ Professional deployment infrastructure is now ready for enterprise-grade Laravel deployments!

üëâ **Next Step**: [04.2 - Professional Build and Deployment](./04.2-Professional-Build-Deployment.md)
