- 1- version 1- Zerodown Flow
    
    # Master Zero-Downtime Deployment Flow for Laravel (with and without JS)
    
    You raise excellent points about the numbering and sequencing. Let me provide you with a **complete, professional zero-downtime deployment pipeline** that addresses all your concerns and pitfalls, using standardized numbering similar to your DeployHQ spec.
    
    ## **Complete Zero-Downtime Deployment Flow**
    
    ## **Phase 1: ðŸ–¥ï¸ Prepare Build Environment**
    
    **1.1 - Pre-Build Environment Preparation**
    
    - **Objectives:**
        - Wait for available deployment slot/runner
        - Validate deployment permissions and access
        - Check repository connectivity and branch availability
        - Verify build environment prerequisites
    - **Commands:**
        
        `bash*# Queue management for build slots# Git connectivity checks# Build environment validation*`
        
    
    **1.2 - Build Environment Setup**
    
    - **Objectives:**
        - Initialize clean build environment
        - Set up correct PHP version (matching production)
        - Set up correct Node.js version (matching production)
        - Set up correct Composer version (matching production)
        - Configure build environment variables
    - **Commands:**
        
        `bash*# Version alignment checks*
        composer --version  *# Ensure matches production*
        node --version       *# Ensure matches production*
        php --version        *# Ensure matches production*`
        
    
    **1.3 - Repository Preparation**
    
    - **Objectives:**
        - Clone/checkout target commit/branch
        - Fetch repository metadata
        - Validate commit integrity
    - **Commands:**
        
        `bashgit clone --depth=1 --branch=$BRANCH $REPOSITORY $BUILD_DIR
        cd $BUILD_DIR
        git checkout $TARGET_COMMIT`
        
    
    ---
    
    ## **Phase 2: ðŸ—ï¸ Build Application**
    
    **2.1 - Cache Restoration**
    
    - **Objectives:**
        - Restore cached dependencies (vendor/, node_modules/)
        - Speed up build process
        - Maintain consistency with lock files
    - **Commands:**
        
        `bash*# Restore cached directories from previous builds# Only if composer.lock and package-lock.json unchanged*`
        
    
    **2.2 - Dependency Installation**
    
    - **Objectives:**
        - Install PHP dependencies with exact versions
        - Install Node.js dependencies with exact versions
        - Use production-optimized flags
    - **Commands:**
        
        `bash*# PHP dependencies (production)*
        composer install --no-dev --optimize-autoloader --no-scripts --prefer-dist
        
        *# Node.js dependencies (if app has JS)*
        npm ci --production=false  *# Install dev deps for build*`
        
    
    **2.3 - Asset Compilation & Optimization**
    
    - **Objectives:**
        - Compile frontend assets (if applicable)
        - Optimize CSS/JS files
        - Generate production-ready assets
    - **Commands:**
        
        `bash*# For Laravel with JS/CSS*
        npm run production
        *# OR*
        npm run build
        
        *# Clear any dev dependencies post-build*
        rm -rf node_modules
        npm ci --production=true  *# Reinstall only production deps*`
        
    
    **2.4 - Laravel Optimizations**
    
    - **Objectives:**
        - Cache Laravel configurations
        - Optimize autoloader
        - Pre-compile views (if desired)
    - **Commands:**
        
        `bashphp artisan config:cache
        php artisan route:cache
        php artisan view:cache  *# Optional*
        composer dump-autoload --optimize --classmap-authoritative`
        
    
    **2.5 - Build Validation**
    
    - **Objectives:**
        - Run tests (optional but recommended)
        - Validate build integrity
        - Check for missing dependencies
    - **Commands:**
        
        `bash*# Optional: Run tests*
        php artisan test --parallel
        
        *# Validate critical files exist*
        [ -f "bootstrap/app.php" ] || exit 1
        [ -f "artisan" ] || exit 1`
        
    
    ---
    
    ## **Phase 3: ðŸ“¦ Package & Transfer**
    
    **3.1 - Build Artifact Preparation**
    
    - **Objectives:**
        - Create deployment manifest
        - Package built application
        - Calculate checksums for changed files
    - **Commands:**
        
        `bash*# Create manifest of files to deploy# Exclude .git, tests, dev files*
        tar --exclude='.git' --exclude='tests' --exclude='node_modules' \
            -czf release.tar.gz .`
        
    
    **3.2 - Server Connection**
    
    - **Objectives:**
        - Establish SSH connection to production server
        - Validate server connectivity
        - Check disk space and permissions
    - **Commands:**
        
        `bash*# SSH connection validation# Disk space check# Permission verification*`
        
    
    **3.3 - Release Directory Creation**
    
    - **Objectives:**
        - Create new timestamped release directory
        - Ensure proper permissions
    - **Commands:**
        
        `bashRELEASE_ID=$(date +%Y%m%d%H%M%S)
        RELEASE_PATH="$DEPLOY_PATH/releases/$RELEASE_ID"
        mkdir -p "$RELEASE_PATH"
        chmod 755 "$RELEASE_PATH"`
        
    
    **3.4 - File Transfer**
    
    - **Objectives:**
        - Transfer only changed/new files
        - Maintain file permissions
        - Optimize transfer speed
    - **Commands:**
        
        `bash*# Extract build artifact to release directory*
        tar -xzf release.tar.gz -C "$RELEASE_PATH"
        
        *# Set proper permissions*
        chown -R www-data:www-data "$RELEASE_PATH"
        find "$RELEASE_PATH" -type f -exec chmod 644 {} \;
        find "$RELEASE_PATH" -type d -exec chmod 755 {} \;
        chmod +x "$RELEASE_PATH/artisan"`
        
    
    ---
    
    ## **Phase 4: ðŸ”— Configure Release**
    
    **4.1 - Shared Resources Linking**
    
    - **Objectives:**
        - Link persistent data (storage/, uploads/)
        - Link environment configuration
        - Link cached data directories
    - **Commands:**
        
        `bash*# Create shared directories if they don't exist*
        mkdir -p "$DEPLOY_PATH/shared/storage/app/public"
        mkdir -p "$DEPLOY_PATH/shared/storage/logs"
        mkdir -p "$DEPLOY_PATH/shared/storage/framework/cache"
        mkdir -p "$DEPLOY_PATH/shared/storage/framework/sessions"
        mkdir -p "$DEPLOY_PATH/shared/storage/framework/views"
        
        *# Remove default directories and create symlinks*
        rm -rf "$RELEASE_PATH/storage"
        rm -f "$RELEASE_PATH/.env"
        
        ln -nfs "$DEPLOY_PATH/shared/storage" "$RELEASE_PATH/storage"
        ln -nfs "$DEPLOY_PATH/shared/.env" "$RELEASE_PATH/.env"
        
        *# Special handling for shared hosting*
        if [ "$SHARED_HOSTING" = "true" ]; then
          *# Create storage directory in public_html if needed*
          mkdir -p "$PUBLIC_PATH/storage"
          *# Link to actual storage location*
          ln -nfs "$DEPLOY_PATH/shared/storage/app/public" "$PUBLIC_PATH/storage"
        fi`
        
    
    **4.2 - Configuration Upload**
    
    - **Objectives:**
        - Upload environment-specific configs
        - Set proper environment variables
        - Configure application settings
    - **Commands:**
        
        `bash*# Upload .env file to shared location# Set proper permissions on config files*
        chmod 600 "$DEPLOY_PATH/shared/.env"`
        
    
    ---
    
    ## **Phase 5: ðŸš€ Pre-Release Hooks (User SSH Commands - Phase A)**
    
    **5.1 - Maintenance Mode (Optional)**
    
    - **Objectives:**
        - Put application in maintenance mode if needed
        - Display user-friendly maintenance page
    - **Commands:**
        
        `bashcd "$DEPLOY_PATH/current" && php artisan down --render="errors::503" --secret="$DEPLOY_SECRET"`
        
    
    **5.2 - Pre-Release Custom Commands**
    
    - **Objectives:**
        - Run user-defined pre-release scripts
        - Create backups
        - Perform pre-checks
    - **Commands:**
        
        `bash*# User-defined commands run here# Examples:# - Database backups# - Cache warmup preparations# - External service notifications*`
        
    
    ---
    
    ## **Phase 6: ðŸ”„ Mid-Release Hooks (User SSH Commands - Phase B)**
    
    **6.1 - Database Migrations (Zero-Downtime)**
    
    - **Objectives:**
        - Run database migrations safely
        - Maintain backward compatibility
        - Handle schema changes without downtime
    - **Commands:**
        
        `bashcd "$RELEASE_PATH"
        
        *# Zero-downtime migration strategy# 1. Add new columns (don't remove old ones yet)# 2. Deploy code that works with both old and new schema# 3. In next deployment, remove old columns*
        
        php artisan migrate --force`
        
    
    **6.2 - Application Cache Preparation**
    
    - **Objectives:**
        - Prepare application caches
        - Pre-warm critical data
        - Optimize for first requests
    - **Commands:**
        
        `bashcd "$RELEASE_PATH"
        
        *# Clear and rebuild caches*
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        
        *# Optional: Pre-warm application cache# php artisan cache:warmup (if you have such command)*`
        
    
    **6.3 - Health Checks**
    
    - **Objectives:**
        - Verify application can start correctly
        - Check database connectivity
        - Validate critical services
    - **Commands:**
        
        `bashcd "$RELEASE_PATH"
        
        *# Basic health checks*
        php artisan --version
        php artisan migrate:status
        
        *# Custom health checks# php artisan health:check (if you have such command)*`
        
    
    ---
    
    ## **Phase 7: âš¡ Atomic Release Switch**
    
    **7.1 - Atomic Symlink Update**
    
    - **Objectives:**
        - Instantly switch to new release
        - Ensure atomic operation (zero-downtime)
        - Enable instant rollback capability
    - **Commands:**
        
        `bash*# Atomic symlink switch - THE zero-downtime moment*
        ln -nfs "$RELEASE_PATH" "$DEPLOY_PATH/current"
        
        *# For shared hosting with public_html root*
        if [ "$SHARED_HOSTING" = "true" ]; then
          *# If public_html is a symlink to Laravel's public folder*
          ln -nfs "$RELEASE_PATH/public" "$PUBLIC_PATH"
        fi`
        
    
    ---
    
    ## **Phase 8: ðŸŽ¯ Post-Release Hooks (User SSH Commands - Phase C)**
    
    **8.1 - Cache Invalidation**
    
    - **Objectives:**
        - Clear OPcache for new code
        - Clear application caches if needed
        - Refresh CDN caches
    - **Commands:**
        
        `bash*# Clear PHP OPcache (critical for zero-downtime)# Method 1: Use cachetool*
        php cachetool.phar opcache:reset --fcgi=/var/run/php-fpm/www.sock
        
        *# Method 2: Call opcache_reset via web request*
        curl -s "$APP_URL/opcache-clear?token=$DEPLOY_SECRET"
        
        *# Method 3: Reload PHP-FPM (if acceptable)# sudo systemctl reload php8.1-fpm*`
        
    
    **8.2 - Service Restarts**
    
    - **Objectives:**
        - Restart background workers
        - Reload web server configs if needed
        - Restart queue workers with new code
    - **Commands:**
        
        `bashcd "$DEPLOY_PATH/current"
        
        *# Restart queue workers gracefully*
        php artisan queue:restart
        
        *# If using Horizon*
        php artisan horizon:terminate
        
        *# Reload web server (if needed)# sudo systemctl reload nginx*`
        
    
    **8.3 - Post-Deployment Validation**
    
    - **Objectives:**
        - Verify deployment success
        - Run smoke tests
        - Check application health
    - **Commands:**
        
        `bash*# Basic smoke tests*
        curl -f -s "$APP_URL/health" > /dev/null
        
        *# Application-specific tests*
        cd "$DEPLOY_PATH/current"
        php artisan health:check --production`
        
    
    **8.4 - Exit Maintenance Mode**
    
    - **Objectives:**
        - Remove maintenance mode
        - Restore full application access
    - **Commands:**
        
        `bashcd "$DEPLOY_PATH/current"
        php artisan up`
        
    
    ---
    
    ## **Phase 9: ðŸ§¹ Cleanup**
    
    **9.1 - Old Release Cleanup**
    
    - **Objectives:**
        - Remove old releases (keep last N releases)
        - Free up disk space
        - Maintain rollback capability
    - **Commands:**
        
        `bash*# Keep only last 5 releases*
        cd "$DEPLOY_PATH/releases"
        ls -1t | tail -n +6 | xargs -r rm -rf`
        
    
    **9.2 - Cache Storage Cleanup**
    
    - **Objectives:**
        - Clean up build caches
        - Remove temporary files
        - Optimize storage usage
    - **Commands:**
        
        `bash*# Clean up build artifacts*
        rm -f "$BUILD_DIR/release.tar.gz"
        
        *# Clean up old cached builds if applicable*`
        
    
    ---
    
    ## **Phase 10: ðŸ“Š Finalization & Notifications**
    
    **10.1 - Deployment Logging**
    
    - **Objectives:**
        - Log deployment details
        - Record deployment metadata
        - Update deployment history
    - **Commands:**
        
        `bashecho "Deployment completed: $RELEASE_ID" >> "$DEPLOY_PATH/deployment.log"
        echo "Git commit: $(git rev-parse HEAD)" >> "$DEPLOY_PATH/deployment.log"
        echo "Timestamp: $(date)" >> "$DEPLOY_PATH/deployment.log"`
        
    
    **10.2 - Notifications & Webhooks**
    
    - **Objectives:**
        - Send deployment notifications
        - Trigger webhooks
        - Update monitoring systems
    - **Commands:**
        
        `bash*# Send notifications (Slack, email, etc.)# Trigger webhooks# Update deployment tracking systems*`
        
    
    ---
    
    ## **Critical Pitfalls & Solutions**
    
    ## **1. Composer/NPM Version Mismatches**
    
    `bash*# Solution: Version alignment check*
    echo "Local Composer: $(composer --version)"
    echo "Server Composer: $(ssh $SERVER 'composer --version')"
    echo "Build Composer: $(composer --version)"
    
    *# Force specific versions*
    alias composer="php8.1 /usr/local/bin/composer2"`
    
    ## **2. Lock File Management**
    
    `bash*# Always commit lock files*
    git add composer.lock package-lock.json
    *# Use exact versions in production*
    composer install --no-dev  *# Uses lock file versions*
    npm ci                      *# Uses lock file versions*`
    
    ## **3. OPcache Invalidation**[packagist+2](https://packagist.org/packages/maximkou/laravel-opcache-clear)
    
    `bash*# Critical: Clear OPcache after deployment*
    php cachetool.phar opcache:reset --fcgi=/var/run/php-fpm/www.sock
    
    *# Or create an authenticated endpoint# Route: POST /admin/opcache-clear*
    // In controller:
    if (request('token') === config('app.deploy_secret')) {
        opcache_reset();
        return response()->json(['status' => 'cleared']);
    }`
    
    ## **4. Shared Hosting Symlink Issues**[dev+3](https://dev.to/vumanhtrung/creating-symbolic-link-in-a-shared-hosting-using-php-5a01)
    
    `bash*# Solution 1: Direct storage path (no symlinks)# In config/filesystems.php*
    'public' => [
        'driver' => 'local',
        'root' => public_path('storage'),  *# Instead of storage_path('app/public')*
        'url' => env('APP_URL').'/storage',
        'visibility' => 'public',
    ],
    
    *# Solution 2: Manual symlink creation*
    ln -s /home/username/laravel/storage/app/public /home/username/public_html/storage
    
    *# Solution 3: PHP symlink script*
    <?php
    $target = '/home/username/laravel/storage/app/public';
    $link = '/home/username/public_html/storage';
    symlink($target, $link);
    echo 'Symlink created successfully';
    ?>`
    
    ## **5. Public_html Root Setup**[hayhost+1](https://hayhost.am/knowledgebase/64/-How-to-Redirect-all-Requests-to-the-publicor-folder-in-Laravel.html?language=chinese)
    
    `bash*# Method 1: Symlink public_html to Laravel's public*
    rm -rf public_html
    ln -s /home/username/laravel/public public_html
    
    *# Method 2: Move Laravel public contents to public_html# Then update index.php paths*
    require_once __DIR__.'/../laravel/vendor/autoload.php';
    $app = require_once __DIR__.'/../laravel/bootstrap/app.php';`
    
    ## **6. Zero-Downtime Database Migrations**[data-sleek+1](https://data-sleek.com/blog/how-to-accomplish-zero-downtime-database-migration-easily-and-effectively/)
    
    `bash*# Phase 1: Add new columns (keep old ones)*
    Schema::table('users', function (Blueprint $table) {
        $table->string('new_email')->nullable();  *# Don't remove 'email' yet*
    });
    
    *# Phase 2: Deploy code that uses both columns# Phase 3: Remove old columns in next deployment*
    Schema::table('users', function (Blueprint $table) {
        $table->dropColumn('email');  *# Now safe to remove*
    });`
    
    ## **7. Build Environment Fallback**
    
    `bash*# When build server is down, build locally*
    if ! ping -c 1 build-server; then
        echo "Building locally..."
        composer install --no-dev --optimize-autoloader
        npm run production
        tar -czf release.tar.gz --exclude='.git' --exclude='node_modules' .
    fi`
    
    ## **8. Queue Worker Management**
    
    `bash*# Ensure workers use new code*
    php artisan queue:restart
    
    *# For Supervisor*
    sudo supervisorctl restart laravel-worker:*
    
    *# For Horizon*
    php artisan horizon:terminate  *# Will auto-restart with new code*`
    
    ---
    
    ## **Directory Structure (Post-Deployment)**
    
    `text/var/www/app/
    â”œâ”€â”€ current â†’ releases/20250820092100/
    â”œâ”€â”€ releases/
    â”‚   â”œâ”€â”€ 20250820091500/
    â”‚   â”œâ”€â”€ 20250820092000/
    â”‚   â””â”€â”€ 20250820092100/  # Latest
    â”œâ”€â”€ shared/
    â”‚   â”œâ”€â”€ .env
    â”‚   â””â”€â”€ storage/
    â”‚       â”œâ”€â”€ app/public/  # User uploads
    â”‚       â”œâ”€â”€ logs/
    â”‚       â””â”€â”€ framework/
    â””â”€â”€ deployment.log`
    
    This master deployment flow ensures **true zero-downtime** by using atomic symlink switches, proper cache invalidation, shared resource management, and comprehensive error handling for all the pitfalls you mentioned.[linkedin+2](https://www.linkedin.com/pulse/zero-downtime-deployment-strategies-laravel-abdullah-shakir-pi3mf)
    
    1. https://packagist.org/packages/maximkou/laravel-opcache-clear
    2. https://bobcares.com/blog/clear-php-opcache-without-restarting-php-fpm/
    3. https://ma.ttias.be/how-to-clear-php-opcache/
    4. https://dev.to/vumanhtrung/creating-symbolic-link-in-a-shared-hosting-using-php-5a01
    5. https://laracasts.com/discuss/channels/laravel/shared-hosting-deployment-symlink-and-404-errors
    6. https://stackoverflow.com/questions/64501547/laravel-create-symlink-in-custom-public-path
    7. https://hayhost.am/knowledgebase/64/-How-to-Redirect-all-Requests-to-the-publicor-folder-in-Laravel.html?language=chinese
    8. https://dev.to/hazzazbinfaiz/linking-publichtml-to-laravel-public-directory-in-shared-hosting-5ce2
    9. https://data-sleek.com/blog/how-to-accomplish-zero-downtime-database-migration-easily-and-effectively/
    10. https://ivelum.com/blog/zero-downtime-db-migrations/
    11. https://www.linkedin.com/pulse/zero-downtime-deployment-strategies-laravel-abdullah-shakir-pi3mf
    12. https://github.com/marketplace/actions/laravel-zero-downtime-deployment
    13. https://ejmastnak.com/tutorials/deploy-laravel-2/redeployment/
    14. https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/45810103/50e66f0b-b74e-4582-a952-6925ee95cb14/DeployHQ-Based-ZeroDown.md
    15. https://www.reddit.com/r/laravel/comments/1cr8psl/zero_downtime_deployment_for_laravel/
    16. https://moldstud.com/articles/p-speed-up-your-laravel-deployment-best-practices-revealed
    17. https://www.flagsmith.com/blog/automated-testing-zero-downtime-deployments
    18. https://www.engineyard.com/blog/composer-its-all-about-the-lock-file/
    19. https://dev.to/anashussain284/automate-your-laravel-deployments-with-envoy-4fk0
    20. https://www.examcollection.com/blog/foundations-of-a-silent-threat-in-shared-hosting-symlink-attacks/
    21. https://stackoverflow.com/questions/21721495/how-to-deploy-correctly-when-using-composers-develop-production-switch
    22. https://dev.to/codedsalis/fix-laravel-storagelink-issue-when-symlink-is-disabled-on-a-shared-hosting-52n4
    23. https://getcomposer.org/doc/01-basic-usage.md
    24. https://stackoverflow.com/questions/78348381/laravel-symlink-symbolic-link-to-storage-not-working-in-production-shared-host
    25. https://dev.to/ankitvermaonline/link-to-storage-folder-not-working-on-shared-hosting-hostinger-cpanel-hpanel-fix-bhb
    26. https://www.youtube.com/watch?v=R3C8Yy1RbEI
    27. https://nickfan.github.io/envoy-deployscript/
    28. https://www.reddit.com/r/laravel/comments/h7zm2z/images_not_being_saved_to_public_folder_with/
    29. https://serversforhackers.com/c/deploying-with-envoy-cast
    30. https://laravel.com/docs/12.x/envoy
    31. https://github.com/papertank/envoy-deploy
    32. https://stackoverflow.com/questions/14902231/laravel-hook-into-eloquent-pre-and-post-save-for-every-model
    33. https://docs.envoyer.io/projects/deployment-hooks
    34. https://www.reddit.com/r/laravel/comments/zsnk0h/what_are_your_deployment_steps_for_continuous/
    35. https://laracasts.com/series/envoyer/episodes/4
    36. https://blog.laravel.com/envoyer-refreshed-deployment-steps
    37. https://www.reddit.com/r/PHP/comments/1abggtv/proper_way_to_clear_the_opcache_after_code/
    38. https://laracasts.com/discuss/channels/laravel/deployment-of-laravel-10-project-on-shared-hosting-symlink-problem
    39. https://forum.hestiacp.com/t/deploy-laravel-10-to-public-html-as-a-root/14598