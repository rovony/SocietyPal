Running SSH command 1. Phase-A-Prep: Server Environment Validation & Setup

Executing 1. Phase-A-Prep: Server Environment Validation & Setup [#!/bin/bash set -e # Phase-A-Prep: Server Environment Validation & Setup # Purpose: Validate server environment, provide clear instructions for fixes # Run: FIRST - before any other scripts (Pre-Deployment Commands - Before Upload) # Action: DETECT, REPORT, and INSTRUCT - ensures server readiness # Version 3.0 - PRODUCTION READY (Enhanced with /home/u227177893/domains/staging.societypal.com/deploy variable only) echo "=== Phase-A-Prep: Server Environment Validation & Setup ===" # ENHANCED: Define all variables relative to /home/u227177893/domains/staging.societypal.com/deploy (only available DeployHQ variable) # /home/u227177893/domains/staging.societypal.com/deploy = Base server path we're deploying to (e.g., /home/user/domains/site.com/deploy) DEPLOY_PATH="/home/u227177893/domains/staging.societypal.com/deploy" SHARED_PATH="$DEPLOY_PATH/shared" CURRENT_PATH="$DEPLOY_PATH/current" DOMAIN_ROOT=$(dirname "$DEPLOY_PATH") echo "? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):" echo " Base Deploy Path: $DEPLOY_PATH" echo " Shared Path: $SHARED_PATH" echo " Domain Root: $DOMAIN_ROOT" # Initialize variables using enhanced path detection PREP_REPORT="$DOMAIN_ROOT/deployment-prep-report.md" PHASE_A_ISSUES=0 RECOMMENDATIONS_PROVIDED=0 echo "? Starting server environment validation..." echo "? Prep Report: $PREP_REPORT" # Initialize prep report cat > "$PREP_REPORT" << EOF # ? Deployment Preparation Report **Domain:** $(basename "$DOMAIN_ROOT") **Started:** $(date '+%Y-%m-%d %H:%M:%S') **Status:** ? In Progress --- ## ? Phase A: Server Environment Validation **Focus:** Server readiness, hosting panel instructions, manual recommendations EOF # A-Prep-01: Critical PHP Extensions Check (Enhanced from existing scripts) echo "=== Critical PHP Extensions Analysis ===" # Focus only on extensions that cause immediate failures CRITICAL_EXTENSIONS=("pdo" "pdo_mysql" "openssl" "mbstring" "curl") CRITICAL_MISSING=() NICE_TO_HAVE_MISSING=() # Check critical extensions for ext in "${CRITICAL_EXTENSIONS[@]}"; do if ! php -m | grep -qi "^$ext$"; then CRITICAL_MISSING+=("$ext") PHASE_A_ISSUES=$((PHASE_A_ISSUES + 1)) echo "❌ CRITICAL: $ext extension missing" else echo "✅ $ext extension available" fi done # Check nice-to-have extensions (won't block deployment) NICE_TO_HAVE=("zip" "bcmath" "fileinfo" "xml" "ctype" "json" "tokenizer") for ext in "${NICE_TO_HAVE[@]}"; do if ! php -m | grep -qi "^$ext$"; then NICE_TO_HAVE_MISSING+=("$ext") echo "⚠️ RECOMMENDED: $ext extension missing (optional)" fi done # A-Prep-02: Smart Composer 2 Detection & Recommendations echo "=== Smart Composer 2 Detection & Recommendations ===" COMPOSER_STATUS="✅ OPTIMAL" COMPOSER_RECOMMENDATION="" # Smart Composer 2 Detection Logic if command -v composer2 &> /dev/null; then COMPOSER2_VERSION=$(composer2 --version 2>/dev/null | grep -oE 'version [0-9]+\.[0-9]+' | cut -d' ' -f2) echo "✅ OPTIMAL: composer2 available server-wide ($COMPOSER2_VERSION)" COMPOSER_STATUS="✅ OPTIMAL (server-wide)" COMPOSER_RECOMMENDATION="Use existing: \`composer2 install --optimize-autoloader\` # Dev dependencies included as needed" elif composer --version 2>/dev/null | grep -q "version 2\."; then COMPOSER_VERSION=$(composer --version | grep -oE 'version [0-9]+\.[0-9]+' | cut -d' ' -f2) echo "✅ GOOD: composer (v2) available server-wide ($COMPOSER_VERSION)" COMPOSER_STATUS="✅ GOOD (server-wide v2)" COMPOSER_RECOMMENDATION="Use existing: \`composer install --optimize-autoloader\` # Dev dependencies included as needed" elif command -v composer &> /dev/null; then COMPOSER_VERSION=$(composer --version 2>/dev/null | grep -oE 'version [0-9]+\.[0-9]+' | cut -d' ' -f2 || echo "unknown") echo "⚠️ LEGACY: composer v1.x detected ($COMPOSER_VERSION)" echo "ℹ️ Laravel 9+ requires Composer 2.x for optimal performance" COMPOSER_STATUS="⚠️ LEGACY VERSION" COMPOSER_RECOMMENDATION="**Upgrade needed:** Install Composer 2 per-domain (required for proper dependency resolution)" PHASE_A_ISSUES=$((PHASE_A_ISSUES + 1)) else echo "❌ MISSING: No Composer installation found" COMPOSER_STATUS="❌ NOT FOUND" COMPOSER_RECOMMENDATION="**Installation required:** Install Composer 2 per-domain" PHASE_A_ISSUES=$((PHASE_A_ISSUES + 1)) fi # Domain-specific installation path recommendation if [ "$COMPOSER_STATUS" = "⚠️ LEGACY VERSION" ] || [ "$COMPOSER_STATUS" = "❌ NOT FOUND" ]; then echo "? Recommended installation location: $DOMAIN_ROOT/composer2" echo "ℹ️ This will be accessible from all releases and deployments" fi # A-Prep-03: Enhanced Shared Directory Structure Analysis echo "=== Enhanced Shared Directory Structure Analysis ===" SHARED_BASE="$SHARED_PATH" SHARED_STRUCTURE_STATUS="✅ OPTIMAL" # Check for additional shared directories that might be beneficial RECOMMENDED_DIRS=( "logs/apache2" "logs/php" "cache/sessions" "cache/views" "public/.well-known/acme-challenge" "storage/debugbar" "storage/clockwork" ) MISSING_OPTIONAL_DIRS=() for dir in "${RECOMMENDED_DIRS[@]}"; do FULL_PATH="$SHARED_BASE/$dir" if [ -d "$FULL_PATH" ]; then echo "✅ Optional: shared/$dir (present)" else echo "ℹ️ Optional: shared/$dir (could be added)" MISSING_OPTIONAL_DIRS+=("$dir") fi done if [ ${#MISSING_OPTIONAL_DIRS[@]} -gt 0 ]; then echo "? ${#MISSING_OPTIONAL_DIRS[@]} optional directories could be created for enhanced functionality" SHARED_STRUCTURE_STATUS="✅ GOOD (optional dirs available)" else echo "✅ All optional shared directories already present" fi # A-Prep-04: PHP Configuration Analysis echo "=== PHP Configuration Analysis ===" PHP_VERSION=$(php -v | head -1 | cut -d' ' -f2 | cut -d'-' -f1) echo "? PHP Version: $PHP_VERSION" # Check PHP version compatibility with modern Laravel PHP_STATUS="✅ EXCELLENT" if [[ "$PHP_VERSION" =~ ^8\.[2-3] ]]; then echo "✅ PHP $PHP_VERSION - Excellent for Laravel 10+" elif [[ "$PHP_VERSION" =~ ^8\.[0-1] ]]; then echo "✅ PHP $PHP_VERSION - Good for Laravel 9+" PHP_STATUS="✅ GOOD" elif [[ "$PHP_VERSION" =~ ^7\. ]]; then echo "⚠️ PHP $PHP_VERSION - Legacy version" PHP_STATUS="⚠️ LEGACY" PHASE_A_ISSUES=$((PHASE_A_ISSUES + 1)) else echo "❌ PHP $PHP_VERSION - Unsupported" PHP_STATUS="❌ UNSUPPORTED" PHASE_A_ISSUES=$((PHASE_A_ISSUES + 1)) fi # Check critical PHP settings MEMORY_LIMIT=$(php -r "echo ini_get('memory_limit');") MAX_EXECUTION_TIME=$(php -r "echo ini_get('max_execution_time');") echo "? Memory Limit: $MEMORY_LIMIT" echo "? Max Execution Time: ${MAX_EXECUTION_TIME}s" PHP_CONFIG_STATUS="✅ OPTIMAL" if [[ "$MEMORY_LIMIT" =~ ^[0-9]+M$ ]]; then MEMORY_MB=$(echo "$MEMORY_LIMIT" | sed 's/M//') if [ "$MEMORY_MB" -lt 256 ]; then echo "⚠️ Memory limit may be low for Laravel applications" PHP_CONFIG_STATUS="⚠️ LOW MEMORY" PHASE_A_ISSUES=$((PHASE_A_ISSUES + 1)) fi fi # A-Prep-05: Server Capabilities Check echo "=== Server Capabilities Analysis ===" # Check for essential server tools SERVER_TOOLS_STATUS="✅ COMPLETE" MISSING_TOOLS=() # Essential tools for Laravel deployment TOOLS=("curl" "git" "mysql") for tool in "${TOOLS[@]}"; do if command -v "$tool" &> /dev/null; then VERSION=$(eval "$tool --version 2>/dev/null | head -1" || echo "available") echo "✅ $tool: $VERSION" else echo "❌ $tool: Missing" MISSING_TOOLS+=("$tool") PHASE_A_ISSUES=$((PHASE_A_ISSUES + 1)) fi done if [ ${#MISSING_TOOLS[@]} -gt 0 ]; then SERVER_TOOLS_STATUS="❌ INCOMPLETE" fi # Check Node.js (optional for frontend builds) if command -v node &> /dev/null; then NODE_VERSION=$(node --version) echo "✅ Node.js: $NODE_VERSION (for frontend builds)" else echo "ℹ️ Node.js: Not available (only needed for frontend builds)" fi # Update prep report with Phase A results cat >> "$PREP_REPORT" << EOF ### ? Critical Extensions Status $([ ${#CRITICAL_MISSING[@]} -eq 0 ] && echo "✅ **All critical extensions present**" || echo "❌ **Missing critical extensions:** ${CRITICAL_MISSING[*]}") $([ ${#NICE_TO_HAVE_MISSING[@]} -eq 0 ] && echo "✅ **All recommended extensions present**" || echo "⚠️ **Missing recommended:** ${NICE_TO_HAVE_MISSING[*]} (optional)") ### ?️ Composer Environment **Status:** $COMPOSER_STATUS **Recommendation:** $COMPOSER_RECOMMENDATION ### ? PHP Configuration **Version:** $PHP_VERSION ($PHP_STATUS) **Memory:** $MEMORY_LIMIT **Config:** $PHP_CONFIG_STATUS ### ?️ Server Tools **Status:** $SERVER_TOOLS_STATUS $([ ${#MISSING_TOOLS[@]} -gt 0 ] && echo "**Missing:** ${MISSING_TOOLS[*]}" || echo "**Available:** curl, git, mysql ✅") ### ? Shared Infrastructure **Structure:** $SHARED_STRUCTURE_STATUS $([ ${#MISSING_OPTIONAL_DIRS[@]} -gt 0 ] && echo "**Optional directories available:** ${#MISSING_OPTIONAL_DIRS[@]} could be added" || echo "**All recommended directories present**") EOF # Generate specific action items based on findings cat >> "$PREP_REPORT" << EOF ### ? Action Items Required: EOF ACTION_ITEMS=0 # Critical extensions action items if [ ${#CRITICAL_MISSING[@]} -gt 0 ]; then cat >> "$PREP_REPORT" << EOF **? CRITICAL - Enable PHP Extensions:** 1. **Login to your hosting control panel** 2. **Navigate to:** PHP Settings → Extensions (or PHP Selector) 3. **Enable these extensions:** ${CRITICAL_MISSING[*]} 4. **Save changes** and wait 1-2 minutes for activation 5. **Verify with:** \`php -m | grep -E '(${CRITICAL_MISSING[*]// /|})'\` EOF ACTION_ITEMS=$((ACTION_ITEMS + 1)) fi # Composer installation instructions if [ "$COMPOSER_STATUS" = "⚠️ LEGACY VERSION" ] || [ "$COMPOSER_STATUS" = "❌ NOT FOUND" ]; then cat >> "$PREP_REPORT" << EOF **? REQUIRED - Install Composer 2 (Per-Domain):** 1. **Navigate to domain root:** \`cd $DOMAIN_ROOT/\` 2. **Download Composer 2:** \`curl -sS https://getcomposer.org/installer | php\` 3. **Rename for clarity:** \`mv composer.phar composer2\` 4. **Make executable:** \`chmod +x composer2\` 5. **Test installation:** \`./composer2 --version\` 6. **Usage from releases:** \`../../composer2 install --no-dev --optimize-autoloader\` **Alternative (if you have sudo access):** 1. **System-wide install:** \`sudo curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer2\` EOF ACTION_ITEMS=$((ACTION_ITEMS + 1)) fi # Server tools action items if [ ${#MISSING_TOOLS[@]} -gt 0 ]; then cat >> "$PREP_REPORT" << EOF **?️ REQUIRED - Install Server Tools:** - **Missing tools:** ${MISSING_TOOLS[*]} - **Contact your hosting provider** to install these essential tools - **Alternative:** Some hosting providers have these in non-standard locations EOF ACTION_ITEMS=$((ACTION_ITEMS + 1)) fi # PHP upgrade recommendation if [ "$PHP_STATUS" = "⚠️ LEGACY" ] || [ "$PHP_STATUS" = "❌ UNSUPPORTED" ]; then cat >> "$PREP_REPORT" << EOF **? RECOMMENDED - Upgrade PHP:** - **Current:** PHP $PHP_VERSION - **Recommended:** PHP 8.1+ for Laravel 9+, PHP 8.2+ for Laravel 10+ - **Action:** Update via hosting control panel → PHP Settings EOF ACTION_ITEMS=$((ACTION_ITEMS + 1)) fi # Optional shared directories if [ ${#MISSING_OPTIONAL_DIRS[@]} -gt 0 ]; then cat >> "$PREP_REPORT" << EOF **? OPTIONAL - Enhanced Shared Directories:** Create additional shared directories for enhanced functionality: \`\`\`bash cd $SHARED_PATH $(for dir in "${MISSING_OPTIONAL_DIRS[@]}"; do echo "mkdir -p $dir && chmod 775 $dir"; done) \`\`\` EOF ACTION_ITEMS=$((ACTION_ITEMS + 1)) fi # Summary status PHASE_A_STATUS="✅ READY" if [ $PHASE_A_ISSUES -gt 0 ]; then PHASE_A_STATUS="❌ NEEDS ATTENTION ($PHASE_A_ISSUES issues)" fi if [ $ACTION_ITEMS -eq 0 ]; then cat >> "$PREP_REPORT" << EOF ✅ **No critical actions required** - server environment is ready! EOF fi cat >> "$PREP_REPORT" << EOF **Phase A Status:** $PHASE_A_STATUS **Recommendations Provided:** $ACTION_ITEMS **Manual Actions Required:** $ACTION_ITEMS EOF # Display summary echo "" echo "=== Phase A Summary ===" echo "? Server Status: $PHASE_A_STATUS" echo "? Recommendations Provided: $ACTION_ITEMS" echo "? Manual Actions Required: $ACTION_ITEMS" echo "? Prep Report: $PREP_REPORT" if [ $PHASE_A_ISSUES -eq 0 ]; then echo "✅ Server environment is ready for Laravel deployment!" echo "? Proceeding to Phase A deployment commands..." else echo "⚠️ $PHASE_A_ISSUES server issues detected" echo "? Check prep report for specific action items" echo "ℹ️ Some issues can be resolved during deployment, others need hosting provider assistance" fi echo "✅ Phase-A-Prep completed successfully" # Log results for deployment history if [ -d "$SHARED_PATH" ]; then echo "[$(date '+%Y-%m-%d %H:%M:%S')] Phase-A-Prep: Status=$PHASE_A_STATUS | Issues=$PHASE_A_ISSUES | Recommendations=$ACTION_ITEMS" >> "$SHARED_PATH/prep-history.log" fi # Exit successfully (don't block deployment even if issues found) exit 0]

=== Phase-A-Prep: Server Environment Validation & Setup ===
? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):
   Base Deploy Path: /home/u227177893/domains/staging.societypal.com/deploy
   Shared Path: /home/u227177893/domains/staging.societypal.com/deploy/shared
   Domain Root: /home/u227177893/domains/staging.societypal.com
? Starting server environment validation...
? Prep Report: /home/u227177893/domains/staging.societypal.com/deployment-prep-report.md
=== Critical PHP Extensions Analysis ===
✅ pdo extension available
✅ pdo_mysql extension available
✅ openssl extension available
✅ mbstring extension available
✅ curl extension available
=== Smart Composer 2 Detection & Recommendations ===
✅ OPTIMAL: composer2 available server-wide (2.5)
=== Enhanced Shared Directory Structure Analysis ===
ℹ️ Optional: shared/logs/apache2 (could be added)
ℹ️ Optional: shared/logs/php (could be added)
ℹ️ Optional: shared/cache/sessions (could be added)
ℹ️ Optional: shared/cache/views (could be added)
ℹ️ Optional: shared/public/.well-known/acme-challenge (could be added)
ℹ️ Optional: shared/storage/debugbar (could be added)
ℹ️ Optional: shared/storage/clockwork (could be added)
? 7 optional directories could be created for enhanced functionality
=== PHP Configuration Analysis ===
? PHP Version: 8.2.28
✅ PHP 8.2.28 - Excellent for Laravel 10+
? Memory Limit: 6144M
? Max Execution Time: 0s
=== Server Capabilities Analysis ===
✅ curl: curl 7.76.1 (x86_64-redhat-linux-gnu) libcurl/7.76.1 OpenSSL/3.2.2 zlib/1.2.11 brotli/1.0.9 libidn2/2.3.0 libpsl/0.21.1 (+libidn2/2.3.0) libssh/0.10.4/openssl/zlib nghttp2/1.43.0
✅ git: git version 2.43.5
✅ mysql: mysql  Ver 15.1 Distrib 10.11.10-MariaDB, for Linux (x86_64) using  EditLine wrapper
ℹ️ Node.js: Not available (only needed for frontend builds)

=== Phase A Summary ===
? Server Status: ✅ READY
? Recommendations Provided: 1
? Manual Actions Required: 1
? Prep Report: /home/u227177893/domains/staging.societypal.com/deployment-prep-report.md
✅ Server environment is ready for Laravel deployment!
? Proceeding to Phase A deployment commands...
✅ Phase-A-Prep completed successfully
Time taken to run 1. Phase-A-Prep: Server Environment Validation & Setup: 1.76 seconds


Running SSH command 2. Phase A: Pre-Deployment Commands (Before Upload)

Executing 2. Phase A: Pre-Deployment Commands (Before Upload) [#!/bin/bash set -e # Phase A: Pre-Deployment Commands (Before Upload) # Purpose: System checks, backups, maintenance mode, environment preparation # Version 3 - PRODUCTION READY (Enhanced with /home/u227177893/domains/staging.societypal.com/deploy variable only) echo "=== Phase A: Pre-Deployment Setup (V3) ===" # ENHANCED: Define all variables relative to /home/u227177893/domains/staging.societypal.com/deploy (only available DeployHQ variable) # /home/u227177893/domains/staging.societypal.com/deploy = Base server path we're deploying to (e.g., /home/user/domains/site.com/deploy) DEPLOY_PATH="/home/u227177893/domains/staging.societypal.com/deploy" SHARED_PATH="$DEPLOY_PATH/shared" CURRENT_PATH="$DEPLOY_PATH/current" echo "? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):" echo " Base Deploy Path: $DEPLOY_PATH" echo " Shared Path: $SHARED_PATH" echo " Current Path: $CURRENT_PATH" # A01: System Pre-flight Checks echo "=== System Pre-flight Checks ===" php --version || { echo "❌ PHP not found"; exit 1; } # Check for Composer (informational only - dependencies handled by build process) if command -v composer2 &> /dev/null; then composer2 --version echo "✅ Composer 2 available (dependencies pre-built)" elif composer --version | grep -q "version 2\."; then composer --version echo "✅ Composer 2 detected (dependencies pre-built)" else composer --version 2>/dev/null || echo "ℹ️ Composer not required (dependencies pre-built)" echo "ℹ️ Dependencies handled by build process - no server-side installation needed" fi node --version 2>/dev/null || echo "ℹ️ Node not required" # Check disk space AVAILABLE_DISK=$(df -k "$DEPLOY_PATH" 2>/dev/null | awk 'NR==2 {print $4}') if [ "$AVAILABLE_DISK" -lt 524288 ]; then # 512MB minimum echo "❌ Insufficient disk space" exit 1 fi # A02: Create Universal Shared Structure (COMPREHENSIVE) echo "=== Initialize Universal Shared Structure ===" # Core Laravel directories (standard) mkdir -p "$SHARED_PATH/storage/{app/public,framework/{cache/data,sessions,views},logs}" mkdir -p "$SHARED_PATH/bootstrap/cache" mkdir -p "$SHARED_PATH/backups" mkdir -p "$SHARED_PATH/public/.well-known" # For SSL certificates # 1. User Content Variations Pattern (UNIVERSAL COVERAGE) echo "Creating user content directories..." mkdir -p "$SHARED_PATH/public/upload" # Covers: upload mkdir -p "$SHARED_PATH/public/uploads" # Covers: uploads mkdir -p "$SHARED_PATH/public/uploaded" # Covers: uploaded mkdir -p "$SHARED_PATH/public/user-upload" # Covers: user-upload mkdir -p "$SHARED_PATH/public/user-uploads" # Covers: user-uploads mkdir -p "$SHARED_PATH/public/media" # Covers: media mkdir -p "$SHARED_PATH/public/medias" # Covers: medias mkdir -p "$SHARED_PATH/public/avatar" # Covers: avatar mkdir -p "$SHARED_PATH/public/avatars" # Covers: avatars mkdir -p "$SHARED_PATH/public/clientAvatar" # Covers: clientAvatar mkdir -p "$SHARED_PATH/public/attachment" # Covers: attachment mkdir -p "$SHARED_PATH/public/attachments" # Covers: attachments mkdir -p "$SHARED_PATH/public/document" # Covers: document mkdir -p "$SHARED_PATH/public/documents" # Covers: documents mkdir -p "$SHARED_PATH/public/file" # Covers: file mkdir -p "$SHARED_PATH/public/files" # Covers: files mkdir -p "$SHARED_PATH/public/images" # Covers: images (user-generated) # 2. User Generated Content (DYNAMIC CONTENT) echo "Creating generated content directories..." mkdir -p "$SHARED_PATH/public/qrcode" # Generated QR codes mkdir -p "$SHARED_PATH/public/qrcodes" # Generated QR codes (plural) mkdir -p "$SHARED_PATH/public/barcode" # Generated barcodes mkdir -p "$SHARED_PATH/public/barcodes" # Generated barcodes (plural) mkdir -p "$SHARED_PATH/public/certificate" # Generated certificates mkdir -p "$SHARED_PATH/public/certificates" # Generated certificates (plural) mkdir -p "$SHARED_PATH/public/report" # Generated reports mkdir -p "$SHARED_PATH/public/reports" # Generated reports (plural) mkdir -p "$SHARED_PATH/public/temp" # Temporary files mkdir -p "$SHARED_PATH/public/temporary" # Temporary files (alternative) # 3. CodeCanyon Application Specific (PRESERVATION PATTERNS) echo "Creating CodeCanyon-specific directories..." mkdir -p "$SHARED_PATH/storage/app" # For modules_statuses.json (CRITICAL!) mkdir -p "$SHARED_PATH/Modules" # Custom modules (root level) mkdir -p "$SHARED_PATH/public/favicon" # Custom favicons # Set proper permissions for all shared directories echo "Setting permissions for shared directories..." chmod -R 775 "$SHARED_PATH/storage" chmod -R 775 "$SHARED_PATH/bootstrap/cache" chmod 755 "$SHARED_PATH/backups" chmod 755 "$SHARED_PATH/public/.well-known" # User content permissions (writable) chmod -R 775 "$SHARED_PATH/public/upload"* chmod -R 775 "$SHARED_PATH/public/user-upload"* chmod -R 775 "$SHARED_PATH/public/media"* chmod -R 775 "$SHARED_PATH/public/avatar"* chmod -R 775 "$SHARED_PATH/public/attachment"* chmod -R 775 "$SHARED_PATH/public/document"* chmod -R 775 "$SHARED_PATH/public/file"* chmod -R 775 "$SHARED_PATH/public/images" # Generated content permissions (writable) chmod -R 775 "$SHARED_PATH/public/qrcode"* chmod -R 775 "$SHARED_PATH/public/barcode"* chmod -R 775 "$SHARED_PATH/public/certificate"* chmod -R 775 "$SHARED_PATH/public/report"* chmod -R 775 "$SHARED_PATH/public/temp"* # CodeCanyon specific permissions chmod -R 775 "$SHARED_PATH/storage/app" # CRITICAL for modules_statuses.json chmod -R 775 "$SHARED_PATH/Modules" chmod 755 "$SHARED_PATH/public/favicon" echo "✅ Shared structure ready for DeployHQ symlinks" # A03: Backup Current Production (if exists) echo "=== Backup Current Release ===" if [ -L "$CURRENT_PATH" ] && [ -d "$CURRENT_PATH" ]; then TIMESTAMP=$(date +"%Y%m%d_%H%M%S") BACKUP_DIR="$SHARED_PATH/backups/release_${TIMESTAMP}" mkdir -p "$BACKUP_DIR" # Quick backup of critical files only cd "$CURRENT_PATH" tar -czf "$BACKUP_DIR/app_backup.tar.gz" \ --exclude='vendor' \ --exclude='node_modules' \ --exclude='storage' \ --exclude='bootstrap/cache' \ app config database resources routes 2>/dev/null || true echo "✅ Backup created: $BACKUP_DIR" # Keep only last 5 backups cd "$SHARED_PATH/backups" ls -t | tail -n +6 | xargs rm -rf 2>/dev/null || true fi # A04: Database Backup (ENHANCED VERSION - FIXED from deployment report) echo "=== Database Backup ===" if [ -f "$SHARED_PATH/.env" ]; then echo "Parsing .env file for database credentials..." # Use PHP to safely parse .env file (more reliable than bash) cat > /tmp/parse_env_v2.php << 'EOF' <?php if (empty($argv[1]) || !is_file($argv[1])) { exit(1); } $lines = file($argv[1], FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES); $env = []; foreach ($lines as $line) { $line = trim($line); if (empty($line) || strpos($line, '#') === 0) { continue; } if (strpos($line, '=') === false) { continue; } list($name, $value) = explode('=', $line, 2); $name = trim($name); $value = trim($value); // Remove quotes if present if (preg_match('/^"(.*)"$/', $value, $matches)) { $value = $matches[1]; } elseif (preg_match('/^\'(.*)\'$/', $value, $matches)) { $value = $matches[1]; } $env[$name] = $value; } // Output only the variables we need echo "DB_CONNECTION=" . ($env['DB_CONNECTION'] ?? 'mysql') . "\n"; echo "DB_HOST=" . ($env['DB_HOST'] ?? 'localhost') . "\n"; echo "DB_PORT=" . ($env['DB_PORT'] ?? '3306') . "\n"; echo "DB_DATABASE=" . ($env['DB_DATABASE'] ?? '') . "\n"; echo "DB_USERNAME=" . ($env['DB_USERNAME'] ?? '') . "\n"; echo "DB_PASSWORD=" . ($env['DB_PASSWORD'] ?? '') . "\n"; EOF # Parse the .env file and extract variables ENV_VARS=$(php /tmp/parse_env_v2.php "$SHARED_PATH/.env" 2>/dev/null) rm -f /tmp/parse_env_v2.php if [ -n "$ENV_VARS" ]; then # Load the variables into the current shell eval "$ENV_VARS" echo "Database configuration:" echo " Host: $DB_HOST" echo " Port: $DB_PORT" echo " Database: $DB_DATABASE" echo " Username: $DB_USERNAME" if [ -n "$DB_DATABASE" ] && [ -n "$DB_USERNAME" ]; then BACKUP_FILE="$SHARED_PATH/backups/db_$(date +%Y%m%d_%H%M%S).sql.gz" echo "Creating database backup..." # Test database connection first (ENHANCED from deployment report) if command -v mysql &> /dev/null; then # Test connection with timeout if timeout 10 mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USERNAME" -p"$DB_PASSWORD" -e "SELECT 1;" 2>/dev/null; then echo "✅ Database connection test passed" # Create backup with better error handling if mysqldump -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USERNAME" -p"$DB_PASSWORD" \ --single-transaction --routines --triggers --add-drop-table \ "$DB_DATABASE" 2>/dev/null | gzip > "$BACKUP_FILE"; then if [ -f "$BACKUP_FILE" ] && [ -s "$BACKUP_FILE" ]; then BACKUP_SIZE=$(du -sh "$BACKUP_FILE" | cut -f1) echo "✅ Database backed up: $BACKUP_FILE ($BACKUP_SIZE)" # Set secure permissions on backup chmod 600 "$BACKUP_FILE" else echo "⚠️ Database backup failed or empty" rm -f "$BACKUP_FILE" 2>/dev/null fi else echo "⚠️ mysqldump failed - check credentials and permissions" rm -f "$BACKUP_FILE" 2>/dev/null fi else echo "⚠️ Cannot connect to database - skipping backup" echo "ℹ️ This may be normal for first deployment or if database is not ready" fi else echo "⚠️ mysql client not available - skipping database backup" echo "ℹ️ Install mysql-client package if database backups are needed" fi else echo "⚠️ Incomplete database configuration in .env" echo "ℹ️ Ensure DB_DATABASE and DB_USERNAME are set" fi else echo "⚠️ Failed to parse .env file" echo "ℹ️ Check .env file syntax and permissions" fi else echo "ℹ️ No .env file found - skipping database backup" echo "ℹ️ This is normal for first deployment" fi # A05: Enter Maintenance Mode (ENHANCED VERSION) echo "=== Enter Maintenance Mode ===" # Create maintenance flag for all hosting types touch "$DEPLOY_PATH/.maintenance" # Try Laravel maintenance if current release exists if [ -f "$CURRENT_PATH/artisan" ]; then cd "$CURRENT_PATH" # Enhanced error handling for artisan down command if php artisan down --render="errors::503" 2>/dev/null; then echo "✅ Laravel maintenance mode activated" else echo "⚠️ Laravel maintenance mode failed, using maintenance flag only" echo "ℹ️ This may be due to missing dependencies (will be fixed in Phase B)" fi else echo "ℹ️ No current release (first deployment) - using maintenance flag only" fi echo "✅ Phase A completed successfully" ]

=== Phase A: Pre-Deployment Setup (V3) ===
? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):
   Base Deploy Path: /home/u227177893/domains/staging.societypal.com/deploy
   Shared Path: /home/u227177893/domains/staging.societypal.com/deploy/shared
   Current Path: /home/u227177893/domains/staging.societypal.com/deploy/current
=== System Pre-flight Checks ===
PHP 8.2.28 (cli) (built: Mar 12 2025 00:00:00) (NTS)
Copyright (c) The PHP Group
Zend Engine v4.2.28, Copyright (c) Zend Technologies
    with Zend OPcache v8.2.28, Copyright (c), by Zend Technologies
Composer version 2.5.5 2023-03-21 11:50:05
✅ Composer 2 available (dependencies pre-built)
ℹ️ Node not required
=== Initialize Universal Shared Structure ===
Creating user content directories...
Creating generated content directories...
Creating CodeCanyon-specific directories...
Setting permissions for shared directories...
✅ Shared structure ready for DeployHQ symlinks
=== Backup Current Release ===
✅ Backup created: /home/u227177893/domains/staging.societypal.com/deploy/shared/backups/release_20250820_030151
=== Database Backup ===
Parsing .env file for database credentials...
Database configuration:
  Host: 127.0.0.1
  Port: 3306
  Database: u227177893_s_zaj_socpal_d
  Username: u227177893_s_zaj_socpal_u
Creating database backup...
+---+
| 1 |
+---+
| 1 |
+---+
✅ Database connection test passed
✅ Database backed up: /home/u227177893/domains/staging.societypal.com/deploy/shared/backups/db_20250820_030151.sql.gz (20K)
=== Enter Maintenance Mode ===

   INFO  Application is now in maintenance mode.  

✅ Laravel maintenance mode activated
✅ Phase A completed successfully
Time taken to run 2. Phase A: Pre-Deployment Commands (Before Upload): 1.52 seconds


Preparing release directory

Making release directory /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010

Copying previous release into /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010


Transferring changed files



Show file destinations?
Uploading storage/framework/views/fd3978159e07e4526a8b2da57e05725e.php

Uploading storage/framework/views/cbd3b3cf87cde6e62b83ad658e1a8ed4.php


Uploading config files

Uploading /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/.env


Linking files from shared path to release

Symlinking prep-history.log to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/prep-history.log

Symlinking backups to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/backups

Symlinking bootstrap/cache to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/bootstrap/cache

Symlinking .env to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/.env

Symlinking Modules to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/Modules

Symlinking storage to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/storage

Symlinking public/favicon to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/favicon

Symlinking public/avatars to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/avatars

Symlinking public/documents to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/documents

Symlinking public/clientAvatar to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/clientAvatar

Symlinking public/barcodes to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/barcodes

Symlinking public/attachments to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/attachments

Symlinking public/.well-known to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/.well-known

Symlinking public/attachment to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/attachment

Symlinking public/temporary to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/temporary

Symlinking public/user-upload to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/user-upload

Symlinking public/qrcodes to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/qrcodes

Symlinking public/document to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/document

Symlinking public/barcode to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/barcode

Symlinking public/temp to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/temp

Symlinking public/files to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/files

Symlinking public/user-uploads to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/user-uploads

Symlinking public/report to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/report

Symlinking public/certificate to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/certificate

Symlinking public/file to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/file

Symlinking public/uploads to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/uploads

Symlinking public/images to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/images

Symlinking public/certificates to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/certificates

Symlinking public/avatar to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/avatar

Symlinking public/qrcode to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/qrcode

Symlinking public/medias to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/medias

Symlinking public/media to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/media

Symlinking public/reports to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/reports

Symlinking public/uploaded to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/uploaded

Symlinking public/upload to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/upload

Symlinking deployments.log to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/deployments.log


Running SSH command 3. Phase B-First: Symlink Fallback Verification (After Upload, Before Release)

Executing 3. Phase B-First: Symlink Fallback Verification (After Upload, Before Release) [#!/bin/bash set -e # Phase B-First: Symlink Fallback Verification (After Upload, Before Release) # Purpose: Verify and create missing core Laravel symlinks that DeployHQ might not create # Timing: After file upload, before current symlink switch - RUNS BEFORE Phase B # Version 3.0 - PRODUCTION READY (Enhanced with /home/u227177893/domains/staging.societypal.com/deploy variable only) echo "=== Phase B-First: Symlink Fallback Verification ===" # ENHANCED: Define all variables relative to /home/u227177893/domains/staging.societypal.com/deploy (only available DeployHQ variable) # /home/u227177893/domains/staging.societypal.com/deploy = Base server path we're deploying to (e.g., /home/user/domains/site.com/deploy) DEPLOY_PATH="/home/u227177893/domains/staging.societypal.com/deploy" SHARED_PATH="$DEPLOY_PATH/shared" CURRENT_PATH="$DEPLOY_PATH/current" # Detect current release directory (most recent in releases/) if [ -d "$DEPLOY_PATH/releases" ]; then LATEST_RELEASE=$(ls -1t "$DEPLOY_PATH/releases" | head -1) RELEASE_PATH="$DEPLOY_PATH/releases/$LATEST_RELEASE" else echo "❌ No releases directory found" exit 1 fi cd "$RELEASE_PATH" echo "? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):" echo " Base Deploy Path: $DEPLOY_PATH" echo " Current Release: $RELEASE_PATH" echo " Shared Path: $SHARED_PATH" # A-Post-01: Verify Core Laravel Symlinks echo "=== Verifying Core Laravel Symlinks ===" # Check if storage symlink exists and is correct if [ ! -L "storage" ] || [ ! -e "storage" ]; then echo "⚠️ Storage symlink missing or broken - creating fallback symlink" rm -rf storage 2>/dev/null || true ln -sf "$SHARED_PATH/storage" storage echo "✅ Created storage → shared/storage symlink" else STORAGE_TARGET=$(readlink storage) echo "✅ Storage symlink exists: storage → $STORAGE_TARGET" fi # Check if bootstrap/cache symlink exists and is correct if [ ! -L "bootstrap/cache" ] || [ ! -e "bootstrap/cache" ]; then echo "⚠️ Bootstrap cache symlink missing or broken - creating fallback symlink" rm -rf bootstrap/cache 2>/dev/null || true ln -sf "$SHARED_PATH/bootstrap/cache" bootstrap/cache echo "✅ Created bootstrap/cache → shared/bootstrap/cache symlink" else BOOTSTRAP_TARGET=$(readlink bootstrap/cache) echo "✅ Bootstrap cache symlink exists: bootstrap/cache → $BOOTSTRAP_TARGET" fi # A-Post-02: Verify .env Symlink (Critical) echo "=== Verifying Environment Symlink ===" # CRITICAL: Don't create .env symlink if uploaded .env exists # Let PhaseB handle moving uploaded .env to shared first if [ -f ".env" ] && [ ! -L ".env" ]; then echo "✅ Uploaded .env file found - leaving for PhaseB to handle" echo " PhaseB will move this to shared and create proper symlink" elif [ ! -L ".env" ] || [ ! -e ".env" ]; then # Only create symlink if shared/.env already exists if [ -f "$SHARED_PATH/.env" ]; then echo "⚠️ .env symlink missing but shared/.env exists - creating symlink" rm -rf .env 2>/dev/null || true ln -sf "$SHARED_PATH/.env" .env echo "✅ Created .env → shared/.env symlink" else echo "ℹ️ No .env symlink and no shared/.env - PhaseB will handle this" fi else ENV_TARGET=$(readlink .env) echo "✅ .env symlink exists: .env → $ENV_TARGET" fi # A-Post-03: Verify Modules Symlink (CodeCanyon) echo "=== Verifying Modules Symlink ===" if [ -d "$SHARED_PATH/Modules" ]; then if [ ! -L "Modules" ] || [ ! -e "Modules" ]; then echo "⚠️ Modules symlink missing or broken - creating fallback symlink" rm -rf Modules 2>/dev/null || true ln -sf "$SHARED_PATH/Modules" Modules echo "✅ Created Modules → shared/Modules symlink" else MODULES_TARGET=$(readlink Modules) echo "✅ Modules symlink exists: Modules → $MODULES_TARGET" fi else echo "ℹ️ No shared Modules directory found - skipping" fi # A-Post-04: Verify Backups Symlink echo "=== Verifying Backups Symlink ===" if [ ! -L "backups" ] || [ ! -e "backups" ]; then echo "⚠️ Backups symlink missing or broken - creating fallback symlink" rm -rf backups 2>/dev/null || true ln -sf "$SHARED_PATH/backups" backups echo "✅ Created backups → shared/backups symlink" else BACKUPS_TARGET=$(readlink backups) echo "✅ Backups symlink exists: backups → $BACKUPS_TARGET" fi # A-Post-05: Initialize Storage Structure (if needed) echo "=== Initializing Storage Structure ===" if [ -L "storage" ] && [ -e "storage" ]; then # Only create structure if storage is properly symlinked mkdir -p "$SHARED_PATH/storage/{app/public,framework/{cache/data,sessions,views},logs}" chmod -R 775 "$SHARED_PATH/storage" echo "✅ Storage structure initialized" else echo "❌ Storage symlink not working - structure initialization skipped" fi # A-Post-06: Final Verification Report echo "=== Symlink Verification Summary ===" SYMLINK_ISSUES=0 # Check all critical symlinks for LINK in storage bootstrap/cache .env backups; do if [ -L "$LINK" ] && [ -e "$LINK" ]; then TARGET=$(readlink "$LINK") echo "✅ $LINK → $TARGET" else echo "❌ $LINK: BROKEN OR MISSING" SYMLINK_ISSUES=$((SYMLINK_ISSUES + 1)) fi done # Check Modules if it should exist if [ -d "$SHARED_PATH/Modules" ]; then if [ -L "Modules" ] && [ -e "Modules" ]; then MODULES_TARGET=$(readlink Modules) echo "✅ Modules → $MODULES_TARGET" else echo "❌ Modules: BROKEN OR MISSING" SYMLINK_ISSUES=$((SYMLINK_ISSUES + 1)) fi fi if [ $SYMLINK_ISSUES -eq 0 ]; then echo "? All critical symlinks verified successfully!" else echo "⚠️ $SYMLINK_ISSUES symlink issues detected - may need manual intervention" fi echo "✅ Phase B-First symlink verification completed successfully" ]

=== Phase B-First: Symlink Fallback Verification ===
? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):
   Base Deploy Path: /home/u227177893/domains/staging.societypal.com/deploy
   Current Release: /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010
   Shared Path: /home/u227177893/domains/staging.societypal.com/deploy/shared
=== Verifying Core Laravel Symlinks ===
✅ Storage symlink exists: storage → ../../shared/storage
✅ Bootstrap cache symlink exists: bootstrap/cache → ../../../shared/bootstrap/cache
=== Verifying Environment Symlink ===
✅ .env symlink exists: .env → ../../shared/.env
=== Verifying Modules Symlink ===
✅ Modules symlink exists: Modules → ../../shared/Modules
=== Verifying Backups Symlink ===
✅ Backups symlink exists: backups → ../../shared/backups
=== Initializing Storage Structure ===
✅ Storage structure initialized
=== Symlink Verification Summary ===
✅ storage → ../../shared/storage
✅ bootstrap/cache → ../../../shared/bootstrap/cache
✅ .env → ../../shared/.env
✅ backups → ../../shared/backups
✅ Modules → ../../shared/Modules
? All critical symlinks verified successfully!
✅ Phase B-First symlink verification completed successfully
Time taken to run 3. Phase B-First: Symlink Fallback Verification (After Upload, Before Release): 0.34 seconds


Running SSH command 4. Phase-B-Prep: Application Compatibility & Configuration

Executing 4. Phase-B-Prep: Application Compatibility & Configuration [#!/bin/bash set -e # Phase-B-Prep: Application Compatibility & Configuration # Purpose: Validate Laravel application, smart database testing, configuration validation # Run: AFTER file upload, BEFORE release activation (SSH Commands - After Upload, Before Release) # Action: VALIDATE app readiness, TEST configurations, PREPARE for activation # Version 2.0 - PRODUCTION READY (Enhanced with root cause fixes) echo "=== Phase-B-Prep: Application Compatibility & Configuration ===" # ENHANCED: Define all variables relative to /home/u227177893/domains/staging.societypal.com/deploy (only available DeployHQ variable) # /home/u227177893/domains/staging.societypal.com/deploy = Base server path we're deploying to (e.g., /home/user/domains/site.com/deploy) DEPLOY_PATH="/home/u227177893/domains/staging.societypal.com/deploy" SHARED_PATH="$DEPLOY_PATH/shared" CURRENT_PATH="$DEPLOY_PATH/current" # Detect current release directory (most recent in releases/) if [ -d "$DEPLOY_PATH/releases" ]; then LATEST_RELEASE=$(ls -1t "$DEPLOY_PATH/releases" | head -1) RELEASE_PATH="$DEPLOY_PATH/releases/$LATEST_RELEASE" else echo "❌ No releases directory found" exit 1 fi cd "$RELEASE_PATH" # Initialize variables using /home/u227177893/domains/staging.societypal.com/deploy as base DOMAIN_ROOT=$(dirname "$DEPLOY_PATH") PREP_REPORT="$DOMAIN_ROOT/deployment-prep-report.md" PHASE_B_ISSUES=0 RECOMMENDATIONS_PROVIDED=0 echo "? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):" echo " Base Deploy Path: $DEPLOY_PATH" echo " Current Release: $RELEASE_PATH" echo " Shared Path: $SHARED_PATH" echo " Current Path: $CURRENT_PATH" echo " Domain Root: $DOMAIN_ROOT" echo "? Starting application compatibility validation..." echo "? Release Path: $(pwd)" # Update prep report for Phase B cat >> "$PREP_REPORT" << EOF --- ## ? Phase B: Application Compatibility & Configuration **Focus:** Laravel readiness, database validation, configuration testing **Release:** $(basename "$(pwd)") EOF # B-Prep-01: Laravel Framework Validation echo "=== Laravel Framework Validation ===" LARAVEL_STATUS="❌ NOT DETECTED" LARAVEL_VERSION="Unknown" if [ -f "artisan" ]; then echo "✅ Laravel artisan file detected" # Test artisan without exec() dependency (shared hosting friendly) if [ -f "vendor/autoload.php" ] && [ -f "bootstrap/app.php" ]; then # Try to get Laravel version from composer.json if [ -f "composer.json" ] && command -v jq >/dev/null 2>&1; then LARAVEL_VERSION=$(jq -r '.require."laravel/framework" // "Not specified"' composer.json 2>/dev/null) elif [ -f "composer.json" ]; then LARAVEL_VERSION=$(grep -o '"laravel/framework":\s*"[^"]*"' composer.json | cut -d'"' -f4 2>/dev/null || echo "Detected") fi # Alternative: Check Laravel version from Application class if [ "$LARAVEL_VERSION" = "Unknown" ] || [ "$LARAVEL_VERSION" = "Not specified" ]; then LARAVEL_VERSION=$(grep -r "VERSION.*=" vendor/laravel/framework/src/Illuminate/Foundation/Application.php 2>/dev/null | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1 || echo "Detected") fi LARAVEL_STATUS="✅ DETECTED" echo "✅ Laravel framework: $LARAVEL_VERSION" else echo "❌ Laravel dependencies missing (vendor/autoload.php or bootstrap/app.php)" LARAVEL_STATUS="❌ INCOMPLETE" PHASE_B_ISSUES=$((PHASE_B_ISSUES + 1)) fi else echo "❌ No artisan file - not a Laravel application" PHASE_B_ISSUES=$((PHASE_B_ISSUES + 1)) fi # B-Prep-02: Dependencies Validation echo "=== Dependencies Validation ===" DEPENDENCIES_STATUS="✅ COMPLETE" VENDOR_SIZE="0" if [ -d "vendor" ]; then VENDOR_SIZE=$(du -sh vendor 2>/dev/null | cut -f1) VENDOR_FILES=$(find vendor -name "*.php" 2>/dev/null | wc -l) echo "✅ Vendor directory: $VENDOR_SIZE ($VENDOR_FILES PHP files)" # Check for critical Laravel dependencies (ENHANCED with path fixes) CRITICAL_PACKAGES=("laravel/framework" "symfony/console" "illuminate/support") MISSING_PACKAGES=() echo "? Verifying critical Laravel packages..." for package in "${CRITICAL_PACKAGES[@]}"; do PACKAGE_PATH="vendor/$(echo "$package" | tr '/' '/')" # Enhanced check with multiple validation methods if [ -d "$PACKAGE_PATH" ] && [ -f "$PACKAGE_PATH/composer.json" ]; then echo "✅ $package: Available and valid" elif [ -d "$PACKAGE_PATH" ]; then echo "⚠️ $package: Directory exists but may be incomplete" # Try to verify package integrity if [ -f "$PACKAGE_PATH/src" ] || [ -f "$PACKAGE_PATH/ServiceProvider.php" ] || [ -f "$PACKAGE_PATH/Support" ]; then echo " ✅ Package structure verified" else echo " ❌ Package structure incomplete" MISSING_PACKAGES+=("$package") PHASE_B_ISSUES=$((PHASE_B_ISSUES + 1)) fi else echo "❌ $package: Missing completely" MISSING_PACKAGES+=("$package") PHASE_B_ISSUES=$((PHASE_B_ISSUES + 1)) fi done # SMART FALLBACK: Only if build artifacts completely failed to transfer if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then echo "❌ Critical packages missing: ${MISSING_PACKAGES[*]}" echo "⚠️ This indicates a build process failure - dependencies should be pre-installed" # Check if this is a complete build failure (no vendor at all) vs partial failure VENDOR_FILE_COUNT=$(find vendor -name "*.php" 2>/dev/null | wc -l) if [ "$VENDOR_FILE_COUNT" -lt 100 ]; then echo "? EMERGENCY FALLBACK: Vendor directory appears empty/corrupted - attempting build replication" echo "? This should only happen if build artifacts failed to transfer" # Replicate the exact build process logic COMPOSER_CMD="composer" if command -v composer2 &> /dev/null; then COMPOSER_CMD="composer2" fi # Step 1: Install production dependencies first (like build process) echo "? Step 1: Installing production dependencies..." if $COMPOSER_CMD install --no-dev --optimize-autoloader --no-interaction; then echo "✅ Production dependencies installed" # Step 2: Smart detection (replicate build logic) echo "? Step 2: Checking if dev dependencies needed..." NEEDS_DEV=false # Check for Faker in database files (key detection from build) if [ -d "database" ] && grep -r "Faker\\\\" database/ 2>/dev/null >/dev/null; then NEEDS_DEV=true echo " ✅ Faker detected in database files (needed for production)" fi # If dev deps needed, install them (like build process) if [ "$NEEDS_DEV" = "true" ]; then echo "? Step 3: Installing dev dependencies (needed for production)..." if $COMPOSER_CMD install --optimize-autoloader --no-interaction; then echo "✅ Dev dependencies added (Faker included)" DEPENDENCIES_STATUS="✅ EMERGENCY REBUILD" else echo "❌ Dev dependency installation failed" DEPENDENCIES_STATUS="❌ REBUILD FAILED" fi else echo "✅ Production-only dependencies sufficient" DEPENDENCIES_STATUS="✅ EMERGENCY REBUILD" fi else echo "❌ Emergency fallback failed" DEPENDENCIES_STATUS="❌ REBUILD FAILED" fi else echo "? Build artifacts partially present - manual intervention required" echo "? Do not run composer install - it would destroy existing build artifacts" DEPENDENCIES_STATUS="❌ BUILD FAILURE" fi fi if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then DEPENDENCIES_STATUS="❌ INCOMPLETE" fi else echo "❌ No vendor directory found" DEPENDENCIES_STATUS="❌ MISSING" PHASE_B_ISSUES=$((PHASE_B_ISSUES + 1)) fi # B-Prep-03: Smart Environment Configuration Analysis (ENHANCED) echo "=== Smart Environment Configuration Analysis ===" ENV_CONFIG_STATUS="❌ NOT CONFIGURED" ENV_FILE_PATH="" DB_CONFIG_COMPLETE="false" # ENHANCED: Wait for .env symlink to be established (fixes timing issue) echo "? Waiting for environment configuration to be ready..." MAX_WAIT=30 WAIT_COUNT=0 while [ $WAIT_COUNT -lt $MAX_WAIT ]; do # Check multiple .env locations with enhanced detection if [ -L ".env" ] && [ -e ".env" ]; then ENV_FILE_PATH=".env" echo "✅ Found .env symlink: $(readlink .env)" break elif [ -f ".env" ] && [ ! -L ".env" ]; then ENV_FILE_PATH=".env" echo "✅ Found .env file (not symlinked)" break elif [ -f "$SHARED_PATH/.env" ]; then ENV_FILE_PATH="$SHARED_PATH/.env" echo "✅ Found shared .env file" break else sleep 1 WAIT_COUNT=$((WAIT_COUNT + 1)) echo " Waiting for .env... ($WAIT_COUNT/$MAX_WAIT)" fi done if [ -z "$ENV_FILE_PATH" ]; then echo "❌ No .env file found after waiting (neither local nor shared)" echo "? Debug: Checking available files..." ls -la .env* 2>/dev/null || echo " No .env* files found" ls -la "$SHARED_PATH"/.env* 2>/dev/null || echo " No shared .env* files found" PHASE_B_ISSUES=$((PHASE_B_ISSUES + 1)) fi if [ -n "$ENV_FILE_PATH" ]; then echo "✅ Environment file: $ENV_FILE_PATH" ENV_CONFIG_STATUS="✅ FOUND" # Smart environment validation (check completeness before testing) REQUIRED_ENV_VARS=("APP_KEY" "APP_URL" "DB_CONNECTION" "DB_HOST" "DB_DATABASE" "DB_USERNAME") MISSING_ENV_VARS=() EMPTY_ENV_VARS=() for var in "${REQUIRED_ENV_VARS[@]}"; do if grep -q "^${var}=" "$ENV_FILE_PATH" 2>/dev/null; then VALUE=$(grep "^${var}=" "$ENV_FILE_PATH" | cut -d'=' -f2- | tr -d '"' | tr -d "'" | xargs) if [ -n "$VALUE" ] && [ "$VALUE" != "null" ]; then echo "✅ $var: Configured" else echo "⚠️ $var: Empty value" EMPTY_ENV_VARS+=("$var") fi else echo "❌ $var: Missing" MISSING_ENV_VARS+=("$var") PHASE_B_ISSUES=$((PHASE_B_ISSUES + 1)) fi done # Check if database configuration is complete for testing DB_REQUIRED=("DB_CONNECTION" "DB_HOST" "DB_DATABASE" "DB_USERNAME") DB_COMPLETE_COUNT=0 for var in "${DB_REQUIRED[@]}"; do if grep -q "^${var}=.\+" "$ENV_FILE_PATH" 2>/dev/null; then VALUE=$(grep "^${var}=" "$ENV_FILE_PATH" | cut -d'=' -f2- | tr -d '"' | tr -d "'" | xargs) if [ -n "$VALUE" ] && [ "$VALUE" != "null" ]; then DB_COMPLETE_COUNT=$((DB_COMPLETE_COUNT + 1)) fi fi done if [ $DB_COMPLETE_COUNT -eq ${#DB_REQUIRED[@]} ]; then DB_CONFIG_COMPLETE="true" echo "✅ Database configuration: Complete for testing" else echo "⚠️ Database configuration: Incomplete ($DB_COMPLETE_COUNT/${#DB_REQUIRED[@]} required vars)" fi fi # B-Prep-04: Smart Database Connection Testing echo "=== Smart Database Connection Testing ===" DB_CONNECTION_STATUS="⚠️ UNTESTED" DB_TEST_METHOD="None" if [ "$DB_CONFIG_COMPLETE" = "true" ] && [ -n "$ENV_FILE_PATH" ]; then # Extract database credentials safely DB_CONNECTION=$(grep "^DB_CONNECTION=" "$ENV_FILE_PATH" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs) DB_HOST=$(grep "^DB_HOST=" "$ENV_FILE_PATH" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs) DB_PORT=$(grep "^DB_PORT=" "$ENV_FILE_PATH" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs) DB_DATABASE=$(grep "^DB_DATABASE=" "$ENV_FILE_PATH" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs) DB_USERNAME=$(grep "^DB_USERNAME=" "$ENV_FILE_PATH" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs) DB_PASSWORD=$(grep "^DB_PASSWORD=" "$ENV_FILE_PATH" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs) # Default port if not specified DB_PORT=${DB_PORT:-3306} echo "? Testing: $DB_CONNECTION database on $DB_HOST:$DB_PORT" # Method 1: Direct MySQL client test (most reliable for shared hosting) if command -v mysql >/dev/null 2>&1; then echo "? Testing with MySQL client..." if timeout 10 mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USERNAME" -p"$DB_PASSWORD" -e "SELECT 1 as test;" "$DB_DATABASE" >/dev/null 2>&1; then DB_CONNECTION_STATUS="✅ CONNECTED (MySQL client)" DB_TEST_METHOD="MySQL CLI" echo "✅ Database connection: Success via MySQL client" else echo "❌ Database connection: Failed via MySQL client" DB_CONNECTION_STATUS="❌ FAILED (MySQL client)" DB_TEST_METHOD="MySQL CLI" PHASE_B_ISSUES=$((PHASE_B_ISSUES + 1)) fi # Method 2: PHP PDO test (fallback, works without exec() restrictions) else echo "? Testing with PHP PDO..." PDO_TEST_SCRIPT="<?php try { \$dsn = 'mysql:host=$DB_HOST;port=$DB_PORT;dbname=$DB_DATABASE'; \$pdo = new PDO(\$dsn, '$DB_USERNAME', '$DB_PASSWORD', [ PDO::ATTR_TIMEOUT => 5, PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION ]); \$stmt = \$pdo->query('SELECT 1 as test'); if (\$stmt->fetch()) { echo 'PDO_SUCCESS'; } else { echo 'PDO_QUERY_FAILED'; } } catch (Exception \$e) { echo 'PDO_ERROR: ' . \$e->getMessage(); } ?>" PDO_RESULT=$(echo "$PDO_TEST_SCRIPT" | php 2>/dev/null) if echo "$PDO_RESULT" | grep -q "PDO_SUCCESS"; then DB_CONNECTION_STATUS="✅ CONNECTED (PHP PDO)" DB_TEST_METHOD="PHP PDO" echo "✅ Database connection: Success via PHP PDO" else echo "❌ Database connection: $PDO_RESULT" DB_CONNECTION_STATUS="❌ FAILED (PHP PDO)" DB_TEST_METHOD="PHP PDO" PHASE_B_ISSUES=$((PHASE_B_ISSUES + 1)) fi fi else echo "ℹ️ Database connection test skipped (incomplete configuration)" DB_TEST_METHOD="Skipped - incomplete config" fi # B-Prep-05: Laravel Cache & Session Configuration Analysis echo "=== Cache & Session Configuration Analysis ===" CACHE_CONFIG_STATUS="✅ OPTIMAL" SESSION_CONFIG_STATUS="✅ OPTIMAL" if [ -n "$ENV_FILE_PATH" ]; then # Analyze cache configuration CACHE_DRIVER=$(grep "^CACHE_DRIVER=" "$ENV_FILE_PATH" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs) CACHE_DRIVER=${CACHE_DRIVER:-file} SESSION_DRIVER=$(grep "^SESSION_DRIVER=" "$ENV_FILE_PATH" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs) SESSION_DRIVER=${SESSION_DRIVER:-file} echo "? Cache driver: $CACHE_DRIVER" echo "? Session driver: $SESSION_DRIVER" # Check for potentially problematic Redis configuration on shared hosting if [ "$CACHE_DRIVER" = "redis" ] || [ "$SESSION_DRIVER" = "redis" ]; then echo "⚠️ Redis configuration detected - may not be available on shared hosting" echo "ℹ️ Auto-fixes will be applied in Phase C if Redis is unavailable" CACHE_CONFIG_STATUS="⚠️ REDIS (unverified)" SESSION_CONFIG_STATUS="⚠️ REDIS (unverified)" else echo "✅ File-based cache/session configuration (shared hosting compatible)" fi else echo "ℹ️ Cache/session analysis skipped (no .env file)" fi # B-Prep-06: Application Permissions Validation echo "=== Application Permissions Validation ===" PERMISSIONS_STATUS="✅ SECURE" PERMISSION_ISSUES=() # Check critical Laravel directories CRITICAL_DIRS=("storage" "bootstrap/cache") for dir in "${CRITICAL_DIRS[@]}"; do if [ -e "$dir" ]; then if [ -w "$dir" ]; then echo "✅ $dir: Writable" else echo "❌ $dir: Not writable" PERMISSION_ISSUES+=("$dir") PHASE_B_ISSUES=$((PHASE_B_ISSUES + 1)) fi else echo "⚠️ $dir: Missing (will be created by symlinks)" fi done if [ ${#PERMISSION_ISSUES[@]} -gt 0 ]; then PERMISSIONS_STATUS="❌ ISSUES FOUND" fi # Update prep report with Phase B results cat >> "$PREP_REPORT" << EOF ### ?️ Laravel Application **Framework:** $LARAVEL_STATUS $([ "$LARAVEL_VERSION" != "Unknown" ] && echo "($LARAVEL_VERSION)" || echo "") **Dependencies:** $DEPENDENCIES_STATUS $([ -n "$VENDOR_SIZE" ] && echo "($VENDOR_SIZE)" || echo "") **Permissions:** $PERMISSIONS_STATUS ### ⚙️ Configuration Analysis **Environment File:** $ENV_CONFIG_STATUS **Database Config:** $([ "$DB_CONFIG_COMPLETE" = "true" ] && echo "✅ Complete" || echo "⚠️ Incomplete") **Cache Driver:** $CACHE_DRIVER ($CACHE_CONFIG_STATUS) **Session Driver:** $SESSION_DRIVER ($SESSION_CONFIG_STATUS) ### ?️ Database Connection Test **Status:** $DB_CONNECTION_STATUS **Method:** $DB_TEST_METHOD $([ "$DB_CONNECTION_STATUS" = "❌ FAILED (MySQL client)" ] || [ "$DB_CONNECTION_STATUS" = "❌ FAILED (PHP PDO)" ] && echo "**Issue:** Cannot connect to database - check credentials" || echo "**Result:** Connection validated successfully") EOF # Generate Phase B specific action items PHASE_B_ACTIONS=0 cat >> "$PREP_REPORT" << EOF ### ? Application Action Items: EOF # Laravel dependency issues if [ "$DEPENDENCIES_STATUS" = "❌ MISSING" ] || [ "$DEPENDENCIES_STATUS" = "❌ INCOMPLETE" ]; then cat >> "$PREP_REPORT" << EOF **? CRITICAL - Build Process Issue:** 1. **Re-deploy with proper build:** Dependencies should be pre-installed by build process 2. **Check build logs:** Verify build process completed successfully 3. **Do not run composer install on server:** This will destroy pre-built dependencies EOF PHASE_B_ACTIONS=$((PHASE_B_ACTIONS + 1)) fi # Environment configuration issues if [ ${#MISSING_ENV_VARS[@]} -gt 0 ] || [ ${#EMPTY_ENV_VARS[@]} -gt 0 ]; then cat >> "$PREP_REPORT" << EOF **⚙️ REQUIRED - Fix Environment Configuration:** $([ ${#MISSING_ENV_VARS[@]} -gt 0 ] && echo "- **Add missing variables:** ${MISSING_ENV_VARS[*]}") $([ ${#EMPTY_ENV_VARS[@]} -gt 0 ] && echo "- **Set empty variables:** ${EMPTY_ENV_VARS[*]}") - **Edit:** \`.env\` file in your deployment - **Generate APP_KEY:** \`php artisan key:generate\` (if APP_KEY is missing) EOF PHASE_B_ACTIONS=$((PHASE_B_ACTIONS + 1)) fi # Database connection issues if [[ "$DB_CONNECTION_STATUS" =~ "FAILED" ]]; then cat >> "$PREP_REPORT" << EOF **?️ CRITICAL - Fix Database Connection:** 1. **Verify database exists** in your hosting control panel 2. **Check credentials** in \`.env\` file match hosting panel settings: - DB_HOST (often 'localhost' or specific server) - DB_DATABASE (exact database name) - DB_USERNAME (database user with access) - DB_PASSWORD (correct password) 3. **Test manually:** \`mysql -h[HOST] -u[USER] -p[PASS] [DATABASE]\` EOF PHASE_B_ACTIONS=$((PHASE_B_ACTIONS + 1)) fi # Permission issues if [ ${#PERMISSION_ISSUES[@]} -gt 0 ]; then cat >> "$PREP_REPORT" << EOF **? REQUIRED - Fix Permissions:** - **Directories with issues:** ${PERMISSION_ISSUES[*]} - **Fix command:** \`chmod -R 775 ${PERMISSION_ISSUES[*]}\` - **Note:** These may be resolved by Phase B symlink creation EOF PHASE_B_ACTIONS=$((PHASE_B_ACTIONS + 1)) fi # Summary status PHASE_B_STATUS="✅ READY FOR RELEASE" if [ $PHASE_B_ISSUES -gt 0 ]; then PHASE_B_STATUS="❌ NEEDS FIXES ($PHASE_B_ISSUES issues)" fi if [ $PHASE_B_ACTIONS -eq 0 ]; then cat >> "$PREP_REPORT" << EOF ✅ **No application issues found** - ready for release activation! EOF fi cat >> "$PREP_REPORT" << EOF **Phase B Status:** $PHASE_B_STATUS **Recommendations Provided:** $PHASE_B_ACTIONS **Manual Actions Required:** $PHASE_B_ACTIONS EOF # Display summary echo "" echo "=== Phase B Summary ===" echo "? Application Status: $PHASE_B_STATUS" echo "? Recommendations Provided: $PHASE_B_ACTIONS" echo "? Manual Actions Required: $PHASE_B_ACTIONS" echo "? Prep Report: $PREP_REPORT" if [ $PHASE_B_ISSUES -eq 0 ]; then echo "✅ Laravel application is ready for release activation!" echo "? Proceeding to Phase B deployment commands..." else echo "⚠️ $PHASE_B_ISSUES application issues detected" echo "? Check prep report for specific action items" echo "ℹ️ Some issues may be resolved by Phase B deployment commands" fi echo "✅ Phase-B-Prep completed successfully" # Log results for deployment history DEPLOY_PATH="/home/u227177893/domains/staging.societypal.com/deploy" if [ -d "/home/u227177893/domains/staging.societypal.com/deploy/shared" ]; then echo "[$(date '+%Y-%m-%d %H:%M:%S')] Phase-B-Prep: Status=$PHASE_B_STATUS | Issues=$PHASE_B_ISSUES | Recommendations=$PHASE_B_ACTIONS | DB=$DB_CONNECTION_STATUS" >> "/home/u227177893/domains/staging.societypal.com/deploy/shared/prep-history.log" fi # Exit successfully (don't block deployment) exit 0]

=== Phase-B-Prep: Application Compatibility & Configuration ===
? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):
   Base Deploy Path: /home/u227177893/domains/staging.societypal.com/deploy
   Current Release: /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010
   Shared Path: /home/u227177893/domains/staging.societypal.com/deploy/shared
   Current Path: /home/u227177893/domains/staging.societypal.com/deploy/current
   Domain Root: /home/u227177893/domains/staging.societypal.com
? Starting application compatibility validation...
? Release Path: /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010
=== Laravel Framework Validation ===
✅ Laravel artisan file detected
✅ Laravel framework: ^12.0
=== Dependencies Validation ===
✅ Vendor directory: 205M (12036 PHP files)
? Verifying critical Laravel packages...
✅ laravel/framework: Available and valid
✅ symfony/console: Available and valid
❌ illuminate/support: Missing completely
❌ Critical packages missing: illuminate/support
⚠️ This indicates a build process failure - dependencies should be pre-installed
? Build artifacts partially present - manual intervention required
? Do not run composer install - it would destroy existing build artifacts
=== Smart Environment Configuration Analysis ===
? Waiting for environment configuration to be ready...
✅ Found .env symlink: ../../shared/.env
✅ Environment file: .env
✅ APP_KEY: Configured
✅ APP_URL: Configured
✅ DB_CONNECTION: Configured
✅ DB_HOST: Configured
✅ DB_DATABASE: Configured
✅ DB_USERNAME: Configured
✅ Database configuration: Complete for testing
=== Smart Database Connection Testing ===
? Testing: mysql database on 127.0.0.1:3306
? Testing with MySQL client...
❌ Database connection: Failed via MySQL client
=== Cache & Session Configuration Analysis ===
? Cache driver: file
? Session driver: file
✅ File-based cache/session configuration (shared hosting compatible)
=== Application Permissions Validation ===
✅ storage: Writable
✅ bootstrap/cache: Writable

=== Phase B Summary ===
? Application Status: ❌ NEEDS FIXES (2 issues)
? Recommendations Provided: 2
? Manual Actions Required: 2
? Prep Report: /home/u227177893/domains/staging.societypal.com/deployment-prep-report.md
⚠️ 2 application issues detected
? Check prep report for specific action items
ℹ️ Some issues may be resolved by Phase B deployment commands
✅ Phase-B-Prep completed successfully
Time taken to run 4. Phase-B-Prep: Application Compatibility & Configuration: 0.8 seconds


Running SSH command 5. Phase B: Pre-Release Commands (After Upload, Before Release)

Executing 5. Phase B: Pre-Release Commands (After Upload, Before Release) [#!/bin/bash set -e # Phase B: Pre-Release Commands (After Upload, Before Release) # Purpose: Configure release, set security, link shared resources # Note: DeployHQ has already uploaded files to /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010 # Version 3 - PRODUCTION READY (Enhanced with root cause fixes) echo "=== Phase B: Pre-Release Configuration (V3) ===" # ENHANCED: Define all variables relative to /home/u227177893/domains/staging.societypal.com/deploy (only available DeployHQ variable) # /home/u227177893/domains/staging.societypal.com/deploy = Base server path we're deploying to (e.g., /home/user/domains/site.com/deploy) DEPLOY_PATH="/home/u227177893/domains/staging.societypal.com/deploy" SHARED_PATH="$DEPLOY_PATH/shared" CURRENT_PATH="$DEPLOY_PATH/current" # Detect current release directory (most recent in releases/) if [ -d "$DEPLOY_PATH/releases" ]; then LATEST_RELEASE=$(ls -1t "$DEPLOY_PATH/releases" | head -1) RELEASE_PATH="$DEPLOY_PATH/releases/$LATEST_RELEASE" else echo "❌ No releases directory found" exit 1 fi cd "$RELEASE_PATH" echo "? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):" echo " Base Deploy Path: $DEPLOY_PATH" echo " Current Release: $RELEASE_PATH" echo " Shared Path: $SHARED_PATH" echo " Current Path: $CURRENT_PATH" # B01: Environment Setup (ENHANCED VERSION) echo "=== Environment Configuration ===" # DeployHQ has uploaded .env to release - handle it properly if [ ! -f "$SHARED_PATH/.env" ]; then # First deployment: move uploaded .env to shared echo "? DEBUG: Checking for uploaded .env file..." echo " Release path: $RELEASE_PATH" echo " Shared path: $SHARED_PATH" ls -la "$RELEASE_PATH"/.env* 2>/dev/null || echo " No .env* files found" if [ -f "$RELEASE_PATH/.env" ]; then echo "✅ Found uploaded .env file - moving to shared" mv "$RELEASE_PATH/.env" "$SHARED_PATH/.env" echo "✅ Moved uploaded .env to shared (first deployment)" elif [ -f "$RELEASE_PATH/.env.example" ]; then echo "⚠️ WARNING: No uploaded .env found, using .env.example as fallback" echo " This suggests DeployHQ config issue - .env should be uploaded!" cp "$RELEASE_PATH/.env.example" "$SHARED_PATH/.env" echo "⚠️ Created .env from example - configure database!" else echo "❌ No .env file found - this may cause issues" fi # Generate APP_KEY if missing if [ -f "$SHARED_PATH/.env" ]; then if ! grep -q "^APP_KEY=base64:" "$SHARED_PATH/.env"; then KEY=$(php -r 'echo "base64:".base64_encode(random_bytes(32));') sed -i "s|^APP_KEY=.*|APP_KEY=$KEY|" "$SHARED_PATH/.env" echo "✅ Generated APP_KEY" fi fi else # Subsequent deployment: remove uploaded .env (we use shared one) if [ -f "$RELEASE_PATH/.env" ]; then rm -f "$RELEASE_PATH/.env" echo "✅ Removed uploaded .env (using shared version)" fi fi # Set secure permissions on shared .env chmod 600 "$SHARED_PATH/.env" 2>/dev/null || true # ENHANCED: Ensure .env symlink exists with proper error handling if [ ! -L "$RELEASE_PATH/.env" ]; then echo "⚠️ .env symlink missing - creating it manually" ln -sf "$SHARED_PATH/.env" "$RELEASE_PATH/.env" echo "✅ Created .env symlink: .env -> ../../shared/.env" else echo "✅ .env symlink already exists" fi # ENHANCED: Verify .env symlink is working if [ -L ".env" ] && [ -e ".env" ]; then echo "✅ .env symlink verified and accessible" else echo "❌ .env symlink broken - attempting to fix" rm -f ".env" 2>/dev/null || true ln -sf "$SHARED_PATH/.env" ".env" if [ -L ".env" ] && [ -e ".env" ]; then echo "✅ .env symlink fixed" else echo "❌ .env symlink still broken" fi fi # B02: Security - Create/Update .htaccess files (ENHANCED VERSION) echo "=== Security Configuration ===" # Root .htaccess (redirect all to public) cat > /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/.htaccess << 'EOF' <IfModule mod_rewrite.c> RewriteEngine On RewriteRule ^(.*)$ public/$1 [L] </IfModule> # Deny access to sensitive files <FilesMatch "^\."> Order allow,deny Deny from all </FilesMatch> <Files "composer.json"> Order allow,deny Deny from all </Files> <Files "package.json"> Order allow,deny Deny from all </Files> <Files "artisan"> Order allow,deny Deny from all </Files> # Additional security headers <IfModule mod_headers.c> Header always set X-Content-Type-Options nosniff Header always set X-Frame-Options DENY Header always set X-XSS-Protection "1; mode=block" Header always set Referrer-Policy "strict-origin-when-cross-origin" </IfModule> EOF # Public .htaccess for Laravel (ENHANCED VERSION) cat > /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010/public/.htaccess << 'EOF' <IfModule mod_rewrite.c> <IfModule mod_negotiation.c> Options -MultiViews -Indexes </IfModule> RewriteEngine On # Handle Authorization Header RewriteCond %{HTTP:Authorization} . RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}] # Redirect Trailing Slashes If Not A Folder... RewriteCond %{REQUEST_FILENAME} !-d RewriteCond %{REQUEST_URI} (.+)/$ RewriteRule ^ %1 [L,R=301] # Send Requests To Front Controller... RewriteCond %{REQUEST_FILENAME} !-d RewriteCond %{REQUEST_FILENAME} !-f RewriteRule ^ index.php [L] </IfModule> # Security Headers <IfModule mod_headers.c> Header set X-Content-Type-Options "nosniff" Header set X-Frame-Options "SAMEORIGIN" Header set X-XSS-Protection "1; mode=block" Header set Referrer-Policy "strict-origin-when-cross-origin" Header set Permissions-Policy "geolocation=(), microphone=(), camera=()" </IfModule> # Disable directory browsing Options -Indexes # Block access to hidden files except .well-known <Files ".*"> <IfModule mod_authz_core.c> Require all denied </IfModule> </Files> <FilesMatch "^\.well-known"> <IfModule mod_authz_core.c> Require all granted </IfModule> </FilesMatch> # Compress text files <IfModule mod_deflate.c> AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json </IfModule> # Cache static assets <IfModule mod_expires.c> ExpiresActive On ExpiresByType image/jpg "access plus 1 month" ExpiresByType image/jpeg "access plus 1 month" ExpiresByType image/gif "access plus 1 month" ExpiresByType image/png "access plus 1 month" ExpiresByType text/css "access plus 1 week" ExpiresByType application/javascript "access plus 1 week" </IfModule> EOF echo "✅ Security configurations created" # B03: Verify Dependencies (BUILD PROCESS AWARE) echo "=== Verify Dependencies ===" # Dependencies should be pre-built by build process if [ ! -d "vendor" ] || [ ! -f "vendor/autoload.php" ]; then echo "❌ CRITICAL: No vendor directory found - build artifacts missing" echo "⚠️ This indicates a complete build process failure" echo "? Manual intervention required: Re-deploy with proper build process" echo "? DO NOT run composer install here - it will destroy the correct dependency set" exit 1 else VENDOR_SIZE=$(du -sh vendor 2>/dev/null | cut -f1) VENDOR_FILES=$(find vendor -name "*.php" 2>/dev/null | wc -l) echo "✅ Build artifacts present: $VENDOR_SIZE ($VENDOR_FILES PHP files)" echo "ℹ️ Dependencies pre-built by build process (including dev deps as needed)" fi # B04: Enhanced Inertia Detection (IMPROVED - Multiple Location Check) echo "=== Comprehensive Inertia Detection ===" INERTIA_DETECTED=false # Check 1: composer.json for inertiajs/inertia-laravel if [ -f "composer.json" ] && grep -q "inertiajs/inertia-laravel" composer.json 2>/dev/null; then echo "✅ Inertia detected in composer.json" INERTIA_DETECTED=true fi # Check 2: config/app.php for Inertia ServiceProvider if [ -f "config/app.php" ] && grep -q "Inertia\\\ServiceProvider" config/app.php 2>/dev/null; then echo "✅ Inertia ServiceProvider detected in config/app.php" INERTIA_DETECTED=true fi # Check 3: package.json for @inertiajs/ packages if [ -f "package.json" ] && grep -q "@inertiajs/" package.json 2>/dev/null; then echo "✅ Inertia frontend packages detected in package.json" INERTIA_DETECTED=true fi # Check 4: vendor directory for actual installation if [ -d "vendor/inertiajs" ] && [ -f "vendor/inertiajs/inertia-laravel/src/ServiceProvider.php" ]; then echo "✅ Inertia Laravel package found in vendor" INERTIA_DETECTED=true fi if [ "$INERTIA_DETECTED" = true ]; then echo "? Inertia detected - verifying installation..." # Verify Inertia is actually installed in vendor if [ ! -d "vendor/inertiajs" ] || [ ! -f "vendor/inertiajs/inertia-laravel/src/ServiceProvider.php" ]; then echo "⚠️ Inertia detected in config but not installed" echo "? This indicates a build process issue - Inertia should be pre-installed" echo "? Manual intervention required: Add Inertia to composer.json and re-deploy with build" echo "? DO NOT install packages here - it will conflict with build process" else echo "✅ Inertia Laravel package properly installed" fi # Additional check: Verify Inertia middleware exists if [ -f "app/Http/Kernel.php" ] && grep -q "HandleInertiaRequests" app/Http/Kernel.php 2>/dev/null; then echo "✅ Inertia middleware detected" else echo "ℹ️ Inertia middleware not found (may need manual setup)" fi else echo "ℹ️ Inertia not detected in any location (composer.json, config/app.php, package.json, vendor)" fi # B05: Set Secure Permissions (ENHANCED VERSION) echo "=== Setting Secure Permissions ===" # Default secure permissions for release files find . -type f -exec chmod 644 {} \; find . -type d -exec chmod 755 {} \; # Make artisan executable [ -f "artisan" ] && chmod 755 artisan # Make any shell scripts executable find . -name "*.sh" -type f -exec chmod 755 {} \; 2>/dev/null || true # Protect .git if exists in release [ -d ".git" ] && chmod -R 700 .git # Note: Shared directories permissions are set in Phase A # DeployHQ symlinks will inherit the shared directory permissions echo "✅ Release permissions secured" # B06: Database Migrations (ENHANCED VERSION with proper environment handling) echo "=== Database Operations ===" if [ -f "artisan" ]; then # ENHANCED: Ensure Laravel dependencies are working first echo "? Verifying Laravel framework before database operations..." # Check if Laravel can boot if php artisan --version >/dev/null 2>&1; then echo "✅ Laravel framework operational" # Now test database connection echo "? Testing database connection..." if [ -f ".env" ] && [ -e ".env" ]; then # Test database connection using Laravel's built-in method DB_TEST_RESULT=$(php artisan tinker --execute="echo 'DB connection test: '; try { DB::connection()->getPdo(); echo 'OK'; } catch(Exception \$e) { echo 'FAILED: ' . \$e->getMessage(); }" 2>/dev/null) if echo "$DB_TEST_RESULT" | grep -q "OK"; then echo "✅ Database connection successful, running migrations..." if php artisan migrate --force 2>/dev/null; then echo "✅ Migrations completed successfully" else echo "⚠️ Migration failed but continuing (may be normal for fresh install)" fi else echo "⚠️ Database not accessible - skip migrations" echo "? Database test result: $DB_TEST_RESULT" echo "ℹ️ This may be normal for first deployment or if database is not configured" fi else echo "⚠️ No .env file accessible - skip migrations" echo "? Debug: .env symlink status:" ls -la .env 2>/dev/null || echo " .env file not found" fi else echo "⚠️ Laravel framework not operational - skip database operations" echo "? Laravel debug info:" php artisan --version 2>&1 | head -3 || echo " Cannot get Laravel version" # DO NOT fix dependencies - they should be pre-built if [ -d "vendor" ]; then echo "⚠️ Laravel framework not operational despite vendor directory existing" echo "? This indicates a build process issue - dependencies may be incomplete" echo "? Manual intervention required: Check build logs and re-deploy" echo "? DO NOT run composer install - it will destroy pre-built dependencies" else echo "❌ No vendor directory - complete build failure" fi fi else echo "ℹ️ No artisan file found - not a Laravel application" fi # B07: Laravel Optimization (ENHANCED VERSION with dependency fixes) echo "=== Application Optimization ===" if [ -f "artisan" ]; then # ENHANCED: Verify Laravel is working before attempting cache operations if php artisan --version >/dev/null 2>&1; then echo "✅ Laravel framework verified - proceeding with optimization" # Clear old caches first echo "? Clearing old caches..." php artisan cache:clear 2>/dev/null && echo "✅ Cache cleared" || echo "ℹ️ Cache clear skipped" php artisan config:clear 2>/dev/null && echo "✅ Config cleared" || echo "ℹ️ Config clear skipped" php artisan route:clear 2>/dev/null && echo "✅ Route cleared" || echo "ℹ️ Route clear skipped" php artisan view:clear 2>/dev/null && echo "✅ View cleared" || echo "ℹ️ View clear skipped" # Build new caches with enhanced error handling echo "? Building new caches..." # Config cache with validation if php artisan config:cache 2>/dev/null; then echo "✅ Configuration cached successfully" # Verify cache file exists [ -f "bootstrap/cache/config.php" ] && echo " ✅ Config cache file verified" || echo " ⚠️ Config cache file missing" else echo "⚠️ Config cache failed - will retry in Phase C" echo "? Config cache debug:" php artisan config:cache 2>&1 | head -2 || echo " Cannot get error details" fi # Route cache with validation if php artisan route:cache 2>/dev/null; then echo "✅ Routes cached successfully" [ -f "bootstrap/cache/routes-v7.php" ] && echo " ✅ Route cache file verified" || echo " ⚠️ Route cache file missing" else echo "⚠️ Route cache failed - will retry in Phase C" echo "? Route cache debug:" php artisan route:cache 2>&1 | head -2 || echo " Cannot get error details" fi # View cache with validation if php artisan view:cache 2>/dev/null; then echo "✅ Views cached successfully" VIEW_COUNT=$(find storage/framework/views -name "*.php" 2>/dev/null | wc -l) echo " ✅ $VIEW_COUNT view files cached" else echo "⚠️ View cache failed - will retry in Phase C" echo "? View cache debug:" php artisan view:cache 2>&1 | head -2 || echo " Cannot get error details" fi # Optional: Event cache (if using events) if [ -f "app/Providers/EventServiceProvider.php" ]; then if php artisan event:cache 2>/dev/null; then echo "✅ Events cached successfully" else echo "ℹ️ Event cache skipped (may not be available)" fi fi else echo "⚠️ Laravel framework not operational - skipping cache optimization" echo "ℹ️ Cache building will be retried in Phase C after framework is fixed" fi # Note: Storage link will be created in Phase C after current symlink exists echo "ℹ️ Storage link will be created in Phase C" else echo "ℹ️ No artisan file - skipping Laravel optimization" fi # B09: Universal Content Symlinks (COMPREHENSIVE COVERAGE) echo "=== Creating Universal Content Symlinks ===" cd /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010 # Function to create symlink if directory exists in release create_content_symlink() { local DIR_PATH="$1" local DIR_NAME=$(basename "$DIR_PATH") if [ -d "$DIR_PATH" ] && [ ! -L "$DIR_PATH" ]; then SHARED_DIR="/home/u227177893/domains/staging.societypal.com/deploy/shared/public/$DIR_NAME" # Migrate any existing content to shared (first deployment) if [ "$(ls -A "$DIR_PATH" 2>/dev/null)" ]; then echo "? Migrating existing content: $DIR_NAME" mkdir -p "$SHARED_DIR" cp -r "$DIR_PATH"/* "$SHARED_DIR"/ 2>/dev/null || true chmod -R 775 "$SHARED_DIR" 2>/dev/null || true fi # Remove directory and create symlink rm -rf "$DIR_PATH" ln -sf "../../shared/public/$DIR_NAME" "$DIR_PATH" echo "✅ Created symlink: $DIR_NAME -> shared/public/$DIR_NAME" elif [ -L "$DIR_PATH" ]; then echo "ℹ️ Symlink already exists: $DIR_NAME" fi } # 1. User Content Variations Pattern echo "Processing user content directories..." create_content_symlink "public/upload" create_content_symlink "public/uploads" create_content_symlink "public/uploaded" create_content_symlink "public/user-upload" create_content_symlink "public/user-uploads" create_content_symlink "public/media" create_content_symlink "public/medias" create_content_symlink "public/avatar" create_content_symlink "public/avatars" create_content_symlink "public/clientAvatar" create_content_symlink "public/attachment" create_content_symlink "public/attachments" create_content_symlink "public/document" create_content_symlink "public/documents" create_content_symlink "public/file" create_content_symlink "public/files" create_content_symlink "public/images" # 2. User Generated Content echo "Processing generated content directories..." create_content_symlink "public/qrcode" create_content_symlink "public/qrcodes" create_content_symlink "public/barcode" create_content_symlink "public/barcodes" create_content_symlink "public/certificate" create_content_symlink "public/certificates" create_content_symlink "public/report" create_content_symlink "public/reports" create_content_symlink "public/temp" create_content_symlink "public/temporary" # 3. CodeCanyon Specific Patterns echo "Processing CodeCanyon-specific patterns..." # Handle favicon files (preserve custom favicons) if [ -f "public/favicon.ico" ]; then if [ ! -f "/home/u227177893/domains/staging.societypal.com/deploy/shared/public/favicon/favicon.ico" ]; then echo "? Preserving custom favicon.ico" mkdir -p "/home/u227177893/domains/staging.societypal.com/deploy/shared/public/favicon" cp "public/favicon.ico" "/home/u227177893/domains/staging.societypal.com/deploy/shared/public/favicon/" chmod 644 "/home/u227177893/domains/staging.societypal.com/deploy/shared/public/favicon/favicon.ico" fi rm -f "public/favicon.ico" ln -sf "../shared/public/favicon/favicon.ico" "public/favicon.ico" echo "✅ Created symlink: favicon.ico -> shared" fi # Handle Modules directory (root level) if [ -d "Modules" ] && [ ! -L "Modules" ]; then echo "? Preserving Modules directory" if [ "$(ls -A "Modules" 2>/dev/null)" ]; then mkdir -p "/home/u227177893/domains/staging.societypal.com/deploy/shared/Modules" cp -r "Modules"/* "/home/u227177893/domains/staging.societypal.com/deploy/shared/Modules"/ 2>/dev/null || true chmod -R 775 "/home/u227177893/domains/staging.societypal.com/deploy/shared/Modules" 2>/dev/null || true fi rm -rf "Modules" ln -sf "../shared/Modules" "Modules" echo "✅ Created symlink: Modules -> shared/Modules" elif [ -L "Modules" ]; then echo "ℹ️ Modules symlink already exists" fi # Handle modules_statuses.json (in storage/app) if [ -f "storage/app/modules_statuses.json" ]; then echo "? Preserving modules_statuses.json" mkdir -p "/home/u227177893/domains/staging.societypal.com/deploy/shared/storage/app" cp "storage/app/modules_statuses.json" "/home/u227177893/domains/staging.societypal.com/deploy/shared/storage/app/" 2>/dev/null || true chmod 644 "/home/u227177893/domains/staging.societypal.com/deploy/shared/storage/app/modules_statuses.json" 2>/dev/null || true echo "✅ Preserved modules_statuses.json in shared storage" fi echo "✅ Universal content symlinks completed" # Note: No build commands here - build pipeline is handled separately echo "ℹ️ Build pipeline handled separately - no build dependencies" echo "✅ Phase B completed successfully" ]

=== Phase B: Pre-Release Configuration (V3) ===
? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):
   Base Deploy Path: /home/u227177893/domains/staging.societypal.com/deploy
   Current Release: /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010
   Shared Path: /home/u227177893/domains/staging.societypal.com/deploy/shared
   Current Path: /home/u227177893/domains/staging.societypal.com/deploy/current
=== Environment Configuration ===
✅ Removed uploaded .env (using shared version)
⚠️ .env symlink missing - creating it manually
✅ Created .env symlink: .env -> ../../shared/.env
✅ .env symlink verified and accessible
=== Security Configuration ===
✅ Security configurations created
=== Verify Dependencies ===
✅ Build artifacts present: 205M (12036 PHP files)
ℹ️ Dependencies pre-built by build process (including dev deps as needed)
=== Comprehensive Inertia Detection ===
ℹ️ Inertia not detected in any location (composer.json, config/app.php, package.json, vendor)
=== Setting Secure Permissions ===
✅ Release permissions secured
=== Database Operations ===
? Verifying Laravel framework before database operations...
✅ Laravel framework operational
? Testing database connection...
✅ Database connection successful, running migrations...

   INFO  Running migrations.  

  2025_05_07_090600_create_society_forum_category_table .......... 3.06ms FAIL

In Connection.php line 822:
                                                                               
  SQLSTATE[42S01]: Base table or view already exists: 1050 Table 'society_for  
  um_category' already exists (Connection: mysql, SQL: create table `society_  
  forum_category` (`id` bigint unsigned not null auto_increment primary key,   
  `society_id` bigint unsigned null, `name` varchar(191) not null, `icon` tex  
  t null, `image` text null, `created_at` timestamp null, `updated_at` timest  
  amp null) default character set utf8mb4 collate 'utf8mb4_unicode_ci')        
                                                                               

In Connection.php line 568:
                                                                               
  SQLSTATE[42S01]: Base table or view already exists: 1050 Table 'society_for  
  um_category' already exists                                                  
                                                                               

⚠️ Migration failed but continuing (may be normal for fresh install)
=== Application Optimization ===
✅ Laravel framework verified - proceeding with optimization
? Clearing old caches...

   INFO  Application cache cleared successfully.  

✅ Cache cleared

   INFO  Configuration cache cleared successfully.  

✅ Config cleared

   INFO  Route cache cleared successfully.  

✅ Route cleared

   INFO  Compiled views cleared successfully.  

✅ View cleared
? Building new caches...

   INFO  Configuration cached successfully.  

✅ Configuration cached successfully
   ✅ Config cache file verified

   INFO  Routes cached successfully.  

✅ Routes cached successfully
   ✅ Route cache file verified


   INFO  Blade templates cached successfully.  

✅ Views cached successfully
   ✅ 483 view files cached
ℹ️ Storage link will be created in Phase C
=== Creating Universal Content Symlinks ===
Processing user content directories...
ℹ️ Symlink already exists: upload
ℹ️ Symlink already exists: uploads
ℹ️ Symlink already exists: uploaded
ℹ️ Symlink already exists: user-upload
ℹ️ Symlink already exists: user-uploads
ℹ️ Symlink already exists: media
ℹ️ Symlink already exists: medias
ℹ️ Symlink already exists: avatar
ℹ️ Symlink already exists: avatars
ℹ️ Symlink already exists: clientAvatar
ℹ️ Symlink already exists: attachment
ℹ️ Symlink already exists: attachments
ℹ️ Symlink already exists: document
ℹ️ Symlink already exists: documents
ℹ️ Symlink already exists: file
ℹ️ Symlink already exists: files
ℹ️ Symlink already exists: images
Processing generated content directories...
ℹ️ Symlink already exists: qrcode
ℹ️ Symlink already exists: qrcodes
ℹ️ Symlink already exists: barcode
ℹ️ Symlink already exists: barcodes
ℹ️ Symlink already exists: certificate
ℹ️ Symlink already exists: certificates
ℹ️ Symlink already exists: report
ℹ️ Symlink already exists: reports
ℹ️ Symlink already exists: temp
ℹ️ Symlink already exists: temporary
Processing CodeCanyon-specific patterns...
ℹ️ Modules symlink already exists
✅ Universal content symlinks completed
ℹ️ Build pipeline handled separately - no build dependencies
✅ Phase B completed successfully
Time taken to run 5. Phase B: Pre-Release Commands (After Upload, Before Release): 25.36 seconds


Running SSH command 5.5. Phase B-Fallback: Dependencies Recovery & Laravel Verification

Executing 5.5. Phase B-Fallback: Dependencies Recovery & Laravel Verification [#!/bin/bash set -e # Phase B-Fallback: Dependencies Recovery & Laravel Verification # Purpose: Fallback dependency recovery when Laravel framework fails # Timing: After Phase B, before release activation - CRITICAL SAFETY NET # Action: Smart dependency recovery with progressive fallback methods # Version 1 - PRODUCTION READY (Enhanced with /home/u227177893/domains/staging.societypal.com/deploy variable only) echo "=== Phase B-Fallback: Dependencies Recovery & Laravel Verification ===" # ENHANCED: Define all variables relative to /home/u227177893/domains/staging.societypal.com/deploy (only available DeployHQ variable) # /home/u227177893/domains/staging.societypal.com/deploy = Base server path we're deploying to (e.g., /home/user/domains/site.com/deploy) DEPLOY_PATH="/home/u227177893/domains/staging.societypal.com/deploy" SHARED_PATH="$DEPLOY_PATH/shared" CURRENT_PATH="$DEPLOY_PATH/current" # Detect current release directory (most recent in releases/) if [ -d "$DEPLOY_PATH/releases" ]; then LATEST_RELEASE=$(ls -1t "$DEPLOY_PATH/releases" | head -1) RELEASE_PATH="$DEPLOY_PATH/releases/$LATEST_RELEASE" else echo "❌ No releases directory found" exit 1 fi cd "$RELEASE_PATH" echo "? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):" echo " Base Deploy Path: $DEPLOY_PATH" echo " Current Release: $RELEASE_PATH" echo " Shared Path: $SHARED_PATH" echo " Current Path: $CURRENT_PATH" # B-Fallback-01: Laravel Health Verification echo "=== Laravel Framework Health Verification ===" LARAVEL_WORKING=false # Test 1: Basic artisan availability if [ -f "artisan" ]; then echo "✅ Artisan file exists" # Test 2: Laravel framework functionality if php artisan --version >/dev/null 2>&1; then LARAVEL_VERSION=$(php artisan --version 2>/dev/null | head -1) echo "✅ Laravel working: $LARAVEL_VERSION" LARAVEL_WORKING=true else echo "❌ Laravel artisan command failed" echo "? Laravel appears broken - initiating dependency recovery..." # Debug information echo "? Debug information:" echo " PHP Version: $(php -v | head -1)" echo " Working Directory: $(pwd)" echo " Vendor exists: $([ -d 'vendor' ] && echo 'Yes' || echo 'No')" echo " Autoload exists: $([ -f 'vendor/autoload.php' ] && echo 'Yes' || echo 'No')" echo " .env exists: $([ -f '.env' ] && echo 'Yes' || echo 'No')" fi else echo "❌ No artisan file found" echo "? Critical Laravel files missing - initiating recovery..." fi # B-Fallback-02: Build Artifact Recovery (BUILD PROCESS AWARE) if [ "$LARAVEL_WORKING" = false ]; then echo "=== Build Artifact Recovery ===" echo "❌ CRITICAL: Laravel framework not operational despite build artifacts" echo "⚠️ This indicates a severe build process failure or corrupted transfer" echo "? Build artifacts should contain all required dependencies (including dev deps as needed)" echo "" echo "? Recovery approach: DO NOT run composer install - it will destroy build artifacts" echo "? Instead: Check for build process issues and re-deploy with proper build" echo "" # Only provide diagnostic information, no destructive recovery echo "? Diagnostic Information:" VENDOR_SIZE=$([ -d 'vendor' ] && du -sh vendor | cut -f1 || echo 'Missing') VENDOR_FILES=$([ -d 'vendor' ] && find vendor -name "*.php" | wc -l || echo '0') echo " - Vendor directory: $VENDOR_SIZE ($VENDOR_FILES PHP files)" echo " - Autoload file: $([ -f 'vendor/autoload.php' ] && echo 'Present' || echo 'Missing')" echo " - Laravel framework: $([ -d 'vendor/laravel/framework' ] && echo 'Present' || echo 'Missing')" echo " - Faker package: $([ -d 'vendor/fakerphp/faker' ] && echo 'Present' || echo 'Missing')" # Check if this is a complete build failure vs partial corruption if [ "$VENDOR_FILES" -lt 100 ]; then echo "❌ COMPLETE BUILD FAILURE: Vendor directory empty/corrupted" echo "? This requires a complete re-deployment with proper build process" LARAVEL_WORKING=false # Ensure we don't attempt any fixes else echo "⚠️ PARTIAL BUILD CORRUPTION: Some files present but Laravel not working" echo "? This may indicate missing dev dependencies or corrupted autoloader" echo "? Re-deploy recommended to ensure proper dependency set" LARAVEL_WORKING=false # Ensure we don't attempt any fixes fi fi # B-Fallback-03: Environment Verification (if Laravel is working) if [ "$LARAVEL_WORKING" = true ]; then echo "=== Environment Configuration Verification ===" # Verify .env symlink if [ -L ".env" ] && [ -e ".env" ]; then echo "✅ .env symlink working" # Test configuration loading if php artisan tinker --execute="echo 'Config test: ' . config('app.name', 'DEFAULT');" 2>/dev/null | grep -q "Config test:"; then echo "✅ Configuration loading successfully" else echo "⚠️ Configuration loading issues detected" fi else echo "⚠️ .env symlink broken - attempting to fix" rm -f ".env" 2>/dev/null || true ln -sf "$SHARED_PATH/.env" ".env" if [ -L ".env" ] && [ -e ".env" ]; then echo "✅ .env symlink fixed" else echo "❌ .env symlink still broken" fi fi # Verify storage symlink if [ -L "storage" ] && [ -e "storage" ]; then echo "✅ Storage symlink working" else echo "⚠️ Storage symlink broken - this may cause issues" fi fi # B-Fallback-04: Final Status Report echo "=== Recovery Status Report ===" if [ "$LARAVEL_WORKING" = true ]; then echo "✅ Laravel Framework: OPERATIONAL" echo "✅ Recovery Status: SUCCESS" echo "? Application ready for release activation" # Final verification tests echo "? Final verification:" echo " ✅ Artisan commands: Working" echo " ✅ Vendor directory: $([ -d 'vendor' ] && du -sh vendor | cut -f1)" echo " ✅ Autoloader: $([ -f 'vendor/autoload.php' ] && echo 'Present' || echo 'Missing')" echo " ✅ Environment: $([ -f '.env' ] && echo 'Linked' || echo 'Missing')" else echo "❌ Laravel Framework: STILL BROKEN" echo "❌ Recovery Status: FAILED" echo "⚠️ CRITICAL: Manual intervention required" echo "" echo "? Diagnostic Information:" echo " - PHP Version: $(php -v | head -1)" echo " - Composer: $($COMPOSER_CMD --version 2>/dev/null || echo 'Failed')" echo " - Working Directory: $(pwd)" echo " - Vendor exists: $([ -d 'vendor' ] && echo 'Yes' || echo 'No')" echo " - Autoload exists: $([ -f 'vendor/autoload.php' ] && echo 'Yes' || echo 'No')" echo " - Laravel Framework: $([ -d 'vendor/laravel/framework' ] && echo 'Yes' || echo 'No')" echo " - .env symlink: $([ -L '.env' ] && echo 'Yes' || echo 'No')" echo " - Storage symlink: $([ -L 'storage' ] && echo 'Yes' || echo 'No')" echo "" echo "?️ Manual Recovery Steps:" echo " 1. SSH into server: ssh user@yourserver.com" echo " 2. Navigate: cd $RELEASE_PATH" echo " 3. Check errors: php artisan --version" echo " 4. DO NOT run composer install - it will destroy build artifacts" echo " 5. Test again: php artisan --version" echo " 6. Check .env: ls -la .env" echo " 7. Fix .env: ln -sf $SHARED_PATH/.env .env" echo "" echo "? Common Issues & Solutions:" echo " - Memory limit: Increase PHP memory_limit in hosting panel" echo " - Disk space: Clean up old files or upgrade hosting" echo " - Permissions: Check directory/file permissions" echo " - PHP extensions: Ensure required extensions are installed" echo " - Composer version: Try switching between composer/composer2" fi echo "✅ Phase B-Fallback completed" # Continue deployment even if Laravel is broken (let later phases handle it) # This prevents deployment pipeline from failing completely echo "ℹ️ Deployment will continue to allow later phases to attempt fixes" exit 0]

=== Phase B-Fallback: Dependencies Recovery & Laravel Verification ===
? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):
   Base Deploy Path: /home/u227177893/domains/staging.societypal.com/deploy
   Current Release: /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010
   Shared Path: /home/u227177893/domains/staging.societypal.com/deploy/shared
   Current Path: /home/u227177893/domains/staging.societypal.com/deploy/current
=== Laravel Framework Health Verification ===
✅ Artisan file exists
✅ Laravel working: Laravel Framework 12.17.0
=== Environment Configuration Verification ===
✅ .env symlink working
✅ Configuration loading successfully
✅ Storage symlink working
=== Recovery Status Report ===
✅ Laravel Framework: OPERATIONAL
✅ Recovery Status: SUCCESS
? Application ready for release activation
? Final verification:
   ✅ Artisan commands: Working
   ✅ Vendor directory: 205M
   ✅ Autoloader: Present
   ✅ Environment: Linked
✅ Phase B-Fallback completed
ℹ️ Deployment will continue to allow later phases to attempt fixes
Time taken to run 5.5. Phase B-Fallback: Dependencies Recovery & Laravel Verification: 2.01 seconds


Linking release directory to current

Symlinking /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010 to /home/u227177893/domains/staging.societypal.com/deploy/current


Running SSH command 6. Phase C-1: Post-Deployment Commands (After Release)

Executing 6. Phase C-1: Post-Deployment Commands (After Release) [#!/bin/bash set -e # Phase C-1: Post-Deployment Commands (After Release) # Purpose: Activate release, setup public access, exit maintenance, verify # Note: DeployHQ has already created the current symlink # Version 3 - PRODUCTION READY (Enhanced with root cause fixes) # Works for both first-time and subsequent deployments echo "=== Phase C: Post-Deployment Finalization (V3) ===" # ENHANCED: Define all variables relative to /home/u227177893/domains/staging.societypal.com/deploy (only available DeployHQ variable) # /home/u227177893/domains/staging.societypal.com/deploy = Base server path we're deploying to (e.g., /home/user/domains/site.com/deploy) DEPLOY_PATH="/home/u227177893/domains/staging.societypal.com/deploy" SHARED_PATH="$DEPLOY_PATH/shared" CURRENT_PATH="$DEPLOY_PATH/current" echo "? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):" echo " Base Deploy Path: $DEPLOY_PATH" echo " Shared Path: $SHARED_PATH" echo " Current Path: $CURRENT_PATH" # C01: Setup Public Access for All Hosting Types (UNIVERSAL VERSION) echo "=== Configure Public Access ===" # Detect hosting structure DOMAIN_ROOT=$(dirname "$DEPLOY_PATH") cd "$DOMAIN_ROOT" echo "? Analyzing hosting environment..." echo " Domain root: $DOMAIN_ROOT" echo " Deploy path: $DEPLOY_PATH" # Detect hosting type and handle accordingly HOSTING_TYPE="unknown" if [ -d "public_html" ] && [ ! -L "public_html" ]; then HOSTING_TYPE="hostinger" echo "? Detected: Hostinger-style hosting (existing public_html directory)" elif [ -L "public_html" ]; then HOSTING_TYPE="existing_symlink" echo "? Detected: Existing public_html symlink" elif [ -d "www" ] && [ ! -L "www" ]; then HOSTING_TYPE="www_based" echo "? Detected: WWW-based hosting" else HOSTING_TYPE="cpanel_secure" echo "?️ Detected: cPanel-style hosting (will create secure symlink)" fi case $HOSTING_TYPE in "hostinger") echo "? Hostinger Setup: Handling existing public_html directory..." # Check if public_html has content if [ "$(ls -A public_html 2>/dev/null | grep -v '^\.' | wc -l)" -gt 0 ]; then BACKUP_NAME="public_html.backup.$(date +%Y%m%d_%H%M%S)" echo " ? Backing up existing content to: $BACKUP_NAME" mv public_html "$BACKUP_NAME" || { echo " ⚠️ Backup failed, removing existing content..." rm -rf public_html } else echo " ?️ Removing empty public_html directory..." rm -rf public_html fi # Create symlink to Laravel public directory if ln -sf deploy/current/public public_html; then echo " ✅ Created: public_html -> deploy/current/public" else echo " ❌ Failed to create symlink - check permissions" fi ;; "existing_symlink") echo "? Existing Symlink: Verifying and updating..." CURRENT_TARGET=$(readlink public_html 2>/dev/null || echo "broken") if [ "$CURRENT_TARGET" != "deploy/current/public" ]; then echo " ? Updating symlink target from: $CURRENT_TARGET" rm -f public_html if ln -sf deploy/current/public public_html; then echo " ✅ Updated: public_html -> deploy/current/public" else echo " ❌ Failed to update symlink" fi else echo " ✅ Symlink already correct: $CURRENT_TARGET" fi ;; "www_based") echo "? WWW-based Setup: Handling www directory..." if [ "$(ls -A www 2>/dev/null | grep -v '^\.' | wc -l)" -gt 0 ]; then mv www "www.backup.$(date +%Y%m%d_%H%M%S)" echo " ? Backed up existing www directory" else rm -rf www fi if ln -sf deploy/current/public www; then echo " ✅ Created: www -> deploy/current/public" else echo " ❌ Failed to create www symlink" fi ;; "cpanel_secure") echo "? cPanel Secure Setup: Creating secure public_html symlink..." # This is the most secure approach - create symlink to Laravel public if ln -sf deploy/current/public public_html; then echo " ✅ Created secure symlink: public_html -> deploy/current/public" echo " ?️ Laravel app files remain outside web-accessible directory" else echo " ⚠️ Primary symlink failed, trying alternative approach..." # Alternative: create from within deploy directory cd deploy/current && ln -sf public ../../public_html && cd ../.. if [ -L "public_html" ]; then echo " ✅ Alternative symlink creation successful" else echo " ❌ All symlink attempts failed - manual intervention required" echo " ? Suggestion: Check directory permissions and server configuration" fi fi ;; *) echo "❓ Unknown hosting type - using default secure approach" ln -sf deploy/current/public public_html 2>/dev/null && echo "✅ Default symlink created" || echo "⚠️ Default symlink failed" ;; esac # Verify the final setup echo "? Verifying public access setup..." if [ -L "public_html" ] && [ -e "public_html" ]; then FINAL_TARGET=$(readlink public_html) echo " ✅ public_html -> $FINAL_TARGET" # Test if Laravel public files are accessible if [ -f "public_html/index.php" ]; then echo " ✅ Laravel application accessible via public_html" else echo " ⚠️ Laravel index.php not found in public_html" fi else echo " ❌ public_html symlink verification failed" echo " ? Manual setup may be required for this hosting environment" fi # C02: Create index.php fallback in domain root (security) if [ "$DOMAIN_ROOT" != "$DEPLOY_PATH" ]; then cat > "$DOMAIN_ROOT/index.php" << 'EOF' <?php // Security redirect to Laravel public directory header("Location: /public_html/"); exit(); EOF echo "✅ Created security redirect in domain root" fi # C03: Exit Maintenance Mode (ENHANCED VERSION with dependency fixes) echo "=== Exit Maintenance Mode ===" # Remove maintenance flag rm -f "$DEPLOY_PATH/.maintenance" if [ -f "$CURRENT_PATH/artisan" ]; then cd "$CURRENT_PATH" # ENHANCED: Verify Laravel is working before attempting maintenance mode exit echo "? Verifying Laravel framework before exiting maintenance mode..." if php artisan --version >/dev/null 2>&1; then echo "✅ Laravel framework operational" # Try to exit Laravel maintenance mode if php artisan up 2>/dev/null; then echo "✅ Laravel maintenance mode deactivated successfully" else echo "⚠️ Laravel maintenance mode exit failed - trying alternative methods" # Alternative method: Remove maintenance file manually if [ -f "storage/framework/down" ]; then rm -f "storage/framework/down" echo "✅ Maintenance file removed manually" fi # Check if maintenance mode is actually off if php artisan tinker --execute="echo app()->isDownForMaintenance() ? 'DOWN' : 'UP';" 2>/dev/null | grep -q "UP"; then echo "✅ Application is now live (verified)" else echo "⚠️ Application may still be in maintenance mode" fi fi else echo "⚠️ Laravel framework not operational - cannot exit maintenance mode via artisan" echo "? This indicates a build process issue - dependencies should be pre-installed" echo "? DO NOT run composer install - it will destroy build artifacts" echo "? Removing maintenance files manually as fallback..." # Manual maintenance mode exit (no composer commands) rm -f "storage/framework/down" 2>/dev/null || true echo "✅ Maintenance files removed manually" fi else echo "ℹ️ No artisan file found, maintenance flag removed only" fi echo "✅ Application is now live" # C04: Laravel Final Setup (ENHANCED VERSION) echo "=== Laravel Final Setup ===" cd "$CURRENT_PATH" if [ -f "artisan" ]; then # ENHANCED: Verify Laravel is working before final setup echo "? Verifying Laravel framework for final setup..." if php artisan --version >/dev/null 2>&1; then echo "✅ Laravel framework operational for final setup" # CRITICAL: Verify and fix storage symlinks echo "? Verifying storage symlinks..." # Check if public/storage is directory instead of symlink (common issue) if [ -d "public/storage" ] && [ ! -L "public/storage" ]; then echo "⚠️ public/storage is directory, converting to symlink..." rm -rf public/storage ln -sfn ../storage/app/public public/storage echo "✅ Converted public/storage directory to symlink" fi # Create/verify storage link echo "Creating storage link..." if php artisan storage:link --force 2>/dev/null; then echo "✅ Storage link created via artisan" else echo "⚠️ Artisan storage:link failed - likely exec() function disabled on shared hosting" echo " Attempting manual symlink creation (fallback method)..." # Fallback 1: Standard manual creation rm -f public/storage 2>/dev/null if ln -sfn ../storage/app/public public/storage; then echo "✅ Manual storage link created (fallback 1)" else echo "⚠️ Fallback 1 failed - trying exec() bypass method (fallback 2)..." # Fallback 2: Enhanced exec() bypass method (suggested improvement) STORAGE_TARGET="../storage/app/public" STORAGE_LINK="public/storage" # Remove existing if present rm -f "$STORAGE_LINK" 2>/dev/null # Create symlink manually (this doesn't use exec()) if ln -sfn "$STORAGE_TARGET" "$STORAGE_LINK"; then echo "✅ Storage link created via exec() bypass method (fallback 2)" else echo "⚠️ Fallback 2 failed - trying absolute path (fallback 3)..." # Fallback 3: Absolute path ABSOLUTE_TARGET="/home/u227177893/domains/staging.societypal.com/deploy/shared/storage/app/public" if ln -sfn "$ABSOLUTE_TARGET" "$STORAGE_LINK"; then echo "✅ Absolute path storage link created (fallback 3)" else echo "❌ All storage link attempts failed - manual intervention required" echo " Please create symlink manually: ln -sfn /home/u227177893/domains/staging.societypal.com/deploy/shared/storage/app/public public/storage" fi fi fi fi # Verify final storage symlink if [ -L "public/storage" ] && [ -e "public/storage" ]; then STORAGE_TARGET=$(readlink public/storage) echo "✅ Storage symlink verified: public/storage -> $STORAGE_TARGET" else echo "❌ Storage symlink verification failed - manual fix required" fi # Retry any caches that failed in Phase B echo "Finalizing Laravel caches..." php artisan config:cache 2>/dev/null && echo "✅ Config cache finalized" || echo "ℹ️ Config cache skipped" php artisan route:cache 2>/dev/null && echo "✅ Route cache finalized" || echo "ℹ️ Route cache skipped" php artisan view:cache 2>/dev/null && echo "✅ View cache finalized" || echo "ℹ️ View cache skipped" # Restart queue workers if needed if [ -f ".env" ]; then QUEUE_CONNECTION=$(grep "^QUEUE_CONNECTION=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'" 2>/dev/null) if [ "$QUEUE_CONNECTION" != "sync" ] && [ -n "$QUEUE_CONNECTION" ]; then if php artisan queue:restart 2>/dev/null; then echo "✅ Queue workers signaled to restart" else echo "⚠️ Queue restart failed (continuing)" fi else echo "ℹ️ Queue using sync driver (no workers)" fi else echo "⚠️ Laravel framework not operational for final setup" echo "? This indicates a build process issue - manual intervention required" echo "? DO NOT run composer install - check build logs and re-deploy" fi else echo "ℹ️ No artisan file - not a Laravel application" fi # C05: Clear Runtime Caches echo "=== Clear Runtime Caches ===" # Clear PHP OPcache if php -r "echo function_exists('opcache_reset') ? 'yes' : 'no';" 2>/dev/null | grep -q "yes"; then php -r "opcache_reset();" 2>/dev/null || true echo "✅ OPcache cleared" else echo "ℹ️ OpCache not available" fi # Clear composer cache (use composer command from Phase A) ${COMPOSER_CMD:-composer} clear-cache 2>/dev/null || true # C06: Security Verification (ENHANCED VERSION) echo "=== Security Verification ===" cd /home/u227177893/domains/staging.societypal.com/deploy/current # Check for exposed sensitive files EXPOSED_FILES=0 for FILE in .env .env.example composer.json package.json .git; do if [ -e "public/$FILE" ]; then echo "❌ SECURITY WARNING: $FILE exposed in public!" EXPOSED_FILES=$((EXPOSED_FILES + 1)) fi done if [ $EXPOSED_FILES -eq 0 ]; then echo "✅ No sensitive files exposed" fi # Verify .htaccess files exist [ -f ".htaccess" ] && echo "✅ Root .htaccess present" || echo "⚠️ Root .htaccess missing" [ -f "public/.htaccess" ] && echo "✅ Public .htaccess present" || echo "⚠️ Public .htaccess missing" # Check critical permissions [ -r "/home/u227177893/domains/staging.societypal.com/deploy/shared/.env" ] && [ ! -w "/home/u227177893/domains/staging.societypal.com/deploy/shared/.env" ] || echo "⚠️ .env file should not be world-writable" # C07: Health Checks (ENHANCED VERSION with better error handling) echo "=== Application Health Checks ===" HEALTH_PASSED=true # Check Laravel installation if [ -f "artisan" ]; then if php artisan --version >/dev/null 2>&1; then echo "✅ Laravel framework operational" LARAVEL_VERSION=$(php artisan --version 2>/dev/null | head -1) echo " Version: $LARAVEL_VERSION" else echo "❌ Laravel framework error" HEALTH_PASSED=false # Try to identify the issue echo " Debug info:" php artisan --version 2>&1 | head -3 echo " This may be due to:" echo " - Missing dependencies (check Phase B completion)" echo " - exec() function disabled on shared hosting" echo " - PHP configuration issues" fi else echo "⚠️ No artisan file found in current release" fi # Check critical paths echo "=== Critical Path Verification ===" [ -L "storage" ] && echo "✅ Storage symlink valid" || echo "❌ Storage symlink broken" [ -f ".env" ] && echo "✅ Environment configured" || echo "❌ Environment missing" [ -d "vendor" ] && echo "✅ Dependencies installed" || echo "❌ Dependencies missing" # Test database connection (ENHANCED from deployment report) if [ -f ".env" ]; then echo "Testing database connection..." if php artisan tinker --execute="echo 'DB connection test: '; try { DB::connection()->getPdo(); echo 'OK'; } catch(Exception \$e) { echo 'FAILED: ' . \$e->getMessage(); }" 2>/dev/null | grep -q "OK"; then echo "✅ Database connection working" else echo "⚠️ Database connection failed" echo "ℹ️ This may be due to:" echo " - Database credentials incorrect" echo " - Database server not ready" echo " - exec() function disabled (preventing artisan tinker)" echo " - Network connectivity issues" fi fi # Test HTTP response (ENHANCED with better error handling) if [ -f ".env" ]; then APP_URL=$(grep "^APP_URL=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'") if [ -n "$APP_URL" ] && command -v curl &> /dev/null; then echo "Testing application response..." HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL" --max-time 5 2>/dev/null || echo "000") case $HTTP_CODE in 200|201|301|302) echo "✅ Application responding (HTTP $HTTP_CODE)" ;; 503) echo "⚠️ Application in maintenance mode" ;; 000) echo "⚠️ Application not reachable" ;; *) echo "⚠️ Application returned HTTP $HTTP_CODE" ;; esac else echo "ℹ️ Cannot test web accessibility (no APP_URL or curl)" fi fi # C08: Cleanup Old Releases (ENHANCED VERSION) echo "=== Cleanup Old Releases ===" cd "$DEPLOY_PATH/releases" KEEP_RELEASES=3 TOTAL=$(ls -1t 2>/dev/null | wc -l) if [ "$TOTAL" -gt "$KEEP_RELEASES" ]; then echo "Cleaning old releases (keeping $KEEP_RELEASES)..." RELEASES_TO_DELETE=$((TOTAL - KEEP_RELEASES)) echo "Will delete $RELEASES_TO_DELETE old releases" ls -1t | tail -n +$((KEEP_RELEASES + 1)) | while read OLD; do if [ -n "$OLD" ] && [ -d "$OLD" ]; then echo "Removing: $OLD" rm -rf "$OLD" 2>/dev/null || echo "⚠️ Failed to remove $OLD" fi done echo "✅ Old releases cleanup completed" else echo "ℹ️ Only $TOTAL releases found, no cleanup needed" fi # C09: Final Report (ENHANCED VERSION) echo "=== Deployment Summary ===" echo "? Release: $RELEASE_PATH" echo "? Current: $CURRENT_PATH" echo "? Commit: f6adbf02b5c35c2e49b10683bcdd8c493e6546dc" echo "? Deployed by: Zaj Apps" echo "? Environment: staging" echo "? Status: $( [ "$HEALTH_PASSED" = true ] && echo '✅ Healthy' || echo '⚠️ Check warnings above' )" # Log deployment echo "[$(date '+%Y-%m-%d %H:%M:%S')] staging deployment - Release: $RELEASE_PATH - Commit: f6adbf02b5c35c2e49b10683bcdd8c493e6546dc - Status: Success" >> "$SHARED_PATH/deployments.log" echo "✅ Deployment completed successfully!" exit 0 ]

=== Phase C: Post-Deployment Finalization (V3) ===
? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):
   Base Deploy Path: /home/u227177893/domains/staging.societypal.com/deploy
   Shared Path: /home/u227177893/domains/staging.societypal.com/deploy/shared
   Current Path: /home/u227177893/domains/staging.societypal.com/deploy/current
=== Configure Public Access ===
? Analyzing hosting environment...
   Domain root: /home/u227177893/domains/staging.societypal.com
   Deploy path: /home/u227177893/domains/staging.societypal.com/deploy
? Detected: Existing public_html symlink
? Existing Symlink: Verifying and updating...
   ✅ Symlink already correct: deploy/current/public
? Verifying public access setup...
   ✅ public_html -> deploy/current/public
   ✅ Laravel application accessible via public_html
✅ Created security redirect in domain root
=== Exit Maintenance Mode ===
? Verifying Laravel framework before exiting maintenance mode...
✅ Laravel framework operational

   INFO  Application is now live.  

✅ Laravel maintenance mode deactivated successfully
✅ Application is now live
=== Laravel Final Setup ===
bash: -c: line 456: syntax error: unexpected end of file
Time taken to run 6. Phase C-1: Post-Deployment Commands (After Release): 1.36 seconds


Running SSH command 7. Phase C-2: Comprehensive Deployment Verification & Reporting

Executing 7. Phase C-2: Comprehensive Deployment Verification & Reporting [#!/bin/bash set -e # Phase C-2: Comprehensive Deployment Verification & Reporting # Purpose: Complete post-deployment analysis, verification, and detailed reporting # Run after Phase C - provides comprehensive deployment health check and documentation # Version 2.1 - PRODUCTION READY with Directory Validation # Working Directory: Expected to run from deploy/ directory (e.g., domains/xxx/deploy) echo "=== Phase C-2: Comprehensive Deployment Verification & Reporting ===" # C2-00: Initialize DeployHQ Path Variables (Same as Phases A, B, C) # These variables match DeployHQ's standard path structure # When running in DeployHQ, these will be replaced with actual paths # When testing manually, we detect the current directory structure if [[ "/home/u227177893/domains/staging.societypal.com/deploy" == *"%"* ]]; then # We're running manually for testing - detect paths from current directory CURRENT_DIR="$(pwd)" if [[ "$CURRENT_DIR" =~ .*/domains/[^/]+/deploy$ ]] && [[ -d "releases" ]] && [[ -d "shared" ]]; then export DEPLOY_PATH="$(pwd)" export SHARED_PATH="$(pwd)/shared" # Find current release if [ -L "current" ]; then CURRENT_RELEASE=$(readlink current | sed 's|^./releases/||') export CURRENT_PATH="$(pwd)/current" export RELEASE_PATH="$(pwd)/releases/$CURRENT_RELEASE" else export CURRENT_PATH="" export RELEASE_PATH="" fi echo "? TESTING MODE: Detected paths from current directory" else echo "❌ ERROR: Not in a valid deployment directory for testing" echo " Expected: domains/xxx/deploy (containing 'releases' and 'shared' directories)" echo " Current: $CURRENT_DIR" exit 1 fi else # We're running in DeployHQ - use the provided variables export DEPLOY_PATH="/home/u227177893/domains/staging.societypal.com/deploy" export RELEASE_PATH="/home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010" export SHARED_PATH="/home/u227177893/domains/staging.societypal.com/deploy/shared" export CURRENT_PATH="/home/u227177893/domains/staging.societypal.com/deploy/current" echo "? DEPLOYHQ MODE: Using DeployHQ path variables" fi echo "? Path Variables:" echo " Deploy Path: $DEPLOY_PATH" echo " Release Path: $RELEASE_PATH" echo " Shared Path: $SHARED_PATH" echo " Current Path: $CURRENT_PATH" # C2-01: Initialize Report Structure TIMESTAMP=$(date +"%Y%m%d_%H%M%S") DOMAIN_ROOT=$(dirname "$DEPLOY_PATH") DOMAIN_NAME=$(basename "$DOMAIN_ROOT") REPORT_DIR="$DOMAIN_ROOT/deployment-reports" REPORT_FILE="$REPORT_DIR/deployment-report-$TIMESTAMP.md" echo "? Starting comprehensive deployment verification..." echo " Domain: $DOMAIN_NAME" echo " Deploy Path: $DEPLOY_PATH" echo " Report: $REPORT_FILE" # Create report directory mkdir -p "$REPORT_DIR" # Start report file cat > "$REPORT_FILE" << EOF # ? Deployment Verification Report **Domain:** $DOMAIN_NAME **Timestamp:** $(date '+%Y-%m-%d %H:%M:%S') **Deploy Path:** \`$DEPLOY_PATH\` **Generated By:** Phase C-2 Verification Script --- ## ? TL;DR - QUICK SUMMARY EOF # C2-02: Environment Detection and Basic Info echo "=== Environment Detection ===" cd "$DEPLOY_PATH" # Detect current release if [ -L "current" ]; then CURRENT_RELEASE=$(readlink current | sed 's|^./releases/||') echo "✅ Current release detected: $CURRENT_RELEASE" else echo "❌ No current symlink found" CURRENT_RELEASE="NONE" fi # Count releases RELEASE_COUNT=$(ls -1 releases/ 2>/dev/null | wc -l) echo "? Total releases: $RELEASE_COUNT" # Check shared directory SHARED_SIZE=$(du -sh "$SHARED_PATH" 2>/dev/null | cut -f1 || echo "0") echo "? Shared directory size: $SHARED_SIZE" # Add initial report structure (TLDR will be updated later) cat >> "$REPORT_FILE" << EOF <!-- TLDR_PLACEHOLDER --> --- ## ? DETAILED ANALYSIS ### ?️ Infrastructure Status ### Directory Structure \`\`\` $DOMAIN_NAME/ ├── deploy/ │ ├── current -> releases/$CURRENT_RELEASE │ ├── releases/ ($RELEASE_COUNT releases) │ └── shared/ ($SHARED_SIZE) ├── public_html -> $([ -L "$DOMAIN_ROOT/public_html" ] && readlink "$DOMAIN_ROOT/public_html" || echo "NOT FOUND") └── deployment-reports/ ($(ls -1 "$REPORT_DIR" 2>/dev/null | wc -l) reports) \`\`\` EOF # C2-03: Critical Symlink Verification echo "=== Critical Symlink Verification ===" SYMLINK_STATUS="HEALTHY" # Function to check symlink check_symlink() { local LINK_PATH="$1" local DESCRIPTION="$2" local EXPECTED_TARGET="$3" if [ -L "$LINK_PATH" ]; then local TARGET=$(readlink "$LINK_PATH") local RESOLVED=$(readlink -f "$LINK_PATH" 2>/dev/null || echo "BROKEN") if [ -e "$LINK_PATH" ]; then echo "✅ $DESCRIPTION: $TARGET" echo " → $DESCRIPTION | ✅ VALID | $TARGET | $RESOLVED" >> /tmp/symlink_report else echo "❌ $DESCRIPTION: BROKEN ($TARGET)" echo " → $DESCRIPTION | ❌ BROKEN | $TARGET | BROKEN" >> /tmp/symlink_report SYMLINK_STATUS="ISSUES_FOUND" fi else echo "❌ $DESCRIPTION: NOT A SYMLINK" echo " → $DESCRIPTION | ❌ NOT_SYMLINK | N/A | N/A" >> /tmp/symlink_report SYMLINK_STATUS="ISSUES_FOUND" fi } # Initialize symlink report echo "" > /tmp/symlink_report # Check public_html (web root) cd "$DOMAIN_ROOT" check_symlink "public_html" "Web Root (public_html)" "deploy/current/public" # Check current release symlink cd "$DEPLOY_PATH" check_symlink "current" "Current Release" "releases/$CURRENT_RELEASE" # Check Laravel symlinks (if current exists) if [ -n "$CURRENT_RELEASE" ] && [ "$CURRENT_RELEASE" != "NONE" ] && [ -d "$CURRENT_PATH" ]; then cd "$CURRENT_PATH" check_symlink ".env" "Environment File" "$SHARED_PATH/.env" check_symlink "storage" "Storage Directory" "$SHARED_PATH/storage" check_symlink "bootstrap/cache" "Bootstrap Cache" "$SHARED_PATH/bootstrap/cache" check_symlink "public/storage" "Public Storage" "../storage/app/public" fi # Add symlink report to main report cat >> "$REPORT_FILE" << EOF ### ? Symlink Health Check EOF # Convert technical symlink report to user-friendly format while IFS='|' read -r component status target resolved; do if [[ "$component" =~ "Web Root" ]]; then if [[ "$status" =~ "VALID" ]]; then echo "✅ **Website Access**: Working correctly" >> "$REPORT_FILE" else echo "❌ **Website Access**: BROKEN - visitors cannot reach your site!" >> "$REPORT_FILE" fi elif [[ "$component" =~ "Current Release" ]]; then if [[ "$status" =~ "VALID" ]]; then echo "✅ **Active Version**: Properly linked" >> "$REPORT_FILE" else echo "❌ **Active Version**: BROKEN - no active deployment!" >> "$REPORT_FILE" fi elif [[ "$component" =~ "Environment File" ]]; then if [[ "$status" =~ "VALID" ]]; then echo "✅ **Configuration**: Database & settings connected" >> "$REPORT_FILE" else echo "❌ **Configuration**: MISSING - app cannot start!" >> "$REPORT_FILE" fi elif [[ "$component" =~ "Storage Directory" ]]; then if [[ "$status" =~ "VALID" ]]; then echo "✅ **File Storage**: User uploads preserved" >> "$REPORT_FILE" else echo "❌ **File Storage**: BROKEN - user files may be lost!" >> "$REPORT_FILE" fi elif [[ "$component" =~ "Public Storage" ]]; then if [[ "$status" =~ "VALID" ]]; then echo "✅ **Public Files**: Images & uploads accessible" >> "$REPORT_FILE" else echo "❌ **Public Files**: BROKEN - images won't display!" >> "$REPORT_FILE" fi fi done < /tmp/symlink_report cat >> "$REPORT_FILE" << EOF **? Overall Status:** $([ "$SYMLINK_STATUS" = "HEALTHY" ] && echo "✅ ALL SYSTEMS WORKING" || echo "⚠️ CRITICAL ISSUES FOUND") EOF # C2-04: Shared Directory Analysis echo "=== Shared Directory Analysis ===" cd "$DEPLOY_PATH" # Function to analyze shared directory analyze_shared_dir() { local DIR_PATH="$1" local DESCRIPTION="$2" if [ -d "$SHARED_PATH/$DIR_PATH" ]; then local SIZE=$(du -sh "$SHARED_PATH/$DIR_PATH" 2>/dev/null | cut -f1) local COUNT=$(find "$SHARED_PATH/$DIR_PATH" -type f 2>/dev/null | wc -l) echo "✅ $DESCRIPTION: $SIZE ($COUNT files)" echo "| $DESCRIPTION | ✅ EXISTS | $SIZE | $COUNT files |" >> /tmp/shared_report else echo "⚠️ $DESCRIPTION: NOT FOUND" echo "| $DESCRIPTION | ⚠️ MISSING | N/A | N/A |" >> /tmp/shared_report fi } # Initialize shared report echo "" > /tmp/shared_report # Analyze core shared directories analyze_shared_dir "storage" "Laravel Storage" analyze_shared_dir "bootstrap/cache" "Bootstrap Cache" # Check .env file separately since it's a file, not a directory if [ -f "$SHARED_PATH/.env" ]; then ENV_SIZE=$(du -sh "$SHARED_PATH/.env" 2>/dev/null | cut -f1) echo "✅ Environment File: $ENV_SIZE (1 file)" echo "| Environment File | ✅ EXISTS | $ENV_SIZE | 1 file |" >> /tmp/shared_report else echo "⚠️ Environment File: NOT FOUND" echo "| Environment File | ⚠️ MISSING | N/A | N/A |" >> /tmp/shared_report fi # Analyze user content directories (universal patterns) USER_CONTENT_DIRS=("public/uploads" "public/user-uploads" "public/media" "public/avatars" "public/attachments" "public/documents" "public/files" "public/images") USER_CONTENT_FOUND=0 for DIR in "${USER_CONTENT_DIRS[@]}"; do if [ -d "$SHARED_PATH/$DIR" ]; then analyze_shared_dir "$DIR" "User Content: $(basename "$DIR")" USER_CONTENT_FOUND=$((USER_CONTENT_FOUND + 1)) fi done # Analyze generated content directories GENERATED_DIRS=("public/qrcodes" "public/barcodes" "public/certificates" "public/reports") GENERATED_FOUND=0 for DIR in "${GENERATED_DIRS[@]}"; do if [ -d "$SHARED_PATH/$DIR" ]; then analyze_shared_dir "$DIR" "Generated: $(basename "$DIR")" GENERATED_FOUND=$((GENERATED_FOUND + 1)) fi done # CodeCanyon specific analyze_shared_dir "Modules" "CodeCanyon Modules" # Add shared analysis to report cat >> "$REPORT_FILE" << EOF ### ? Data Protection Status EOF # Convert technical shared report to user-friendly format PROTECTED_DATA_COUNT=0 while IFS='|' read -r description status size content; do if [[ "$description" =~ "Laravel Storage" ]]; then if [[ "$status" =~ "EXISTS" ]]; then echo "✅ **App Data**: $size safely stored ($content)" >> "$REPORT_FILE" PROTECTED_DATA_COUNT=$((PROTECTED_DATA_COUNT + 1)) else echo "❌ **App Data**: MISSING - application files not preserved!" >> "$REPORT_FILE" fi elif [[ "$description" =~ "User Content:" ]]; then CONTENT_TYPE=$(echo "$description" | sed 's/User Content: //') if [[ "$status" =~ "EXISTS" ]]; then echo "✅ **User $CONTENT_TYPE**: $size preserved ($content)" >> "$REPORT_FILE" PROTECTED_DATA_COUNT=$((PROTECTED_DATA_COUNT + 1)) fi elif [[ "$description" =~ "Generated:" ]]; then CONTENT_TYPE=$(echo "$description" | sed 's/Generated: //') if [[ "$status" =~ "EXISTS" ]]; then echo "✅ **Generated $CONTENT_TYPE**: $size preserved ($content)" >> "$REPORT_FILE" PROTECTED_DATA_COUNT=$((PROTECTED_DATA_COUNT + 1)) fi elif [[ "$description" =~ "CodeCanyon" ]]; then if [[ "$status" =~ "EXISTS" ]]; then echo "✅ **App Modules**: $size preserved ($content)" >> "$REPORT_FILE" PROTECTED_DATA_COUNT=$((PROTECTED_DATA_COUNT + 1)) fi fi done < /tmp/shared_report cat >> "$REPORT_FILE" << EOF **? Data Protection Summary:** - **Protected Data Types**: $PROTECTED_DATA_COUNT found - **User Uploads**: $([ $USER_CONTENT_FOUND -gt 0 ] && echo "$USER_CONTENT_FOUND types preserved" || echo "None found") - **Generated Files**: $([ $GENERATED_FOUND -gt 0 ] && echo "$GENERATED_FOUND types preserved" || echo "None found") $([ $PROTECTED_DATA_COUNT -gt 0 ] && echo "✅ **Zero Data Loss**: All user content survives deployments" || echo "ℹ️ **Clean Install**: No user data found (normal for new apps)") EOF # C2-05: Laravel Application Health Check echo "=== Laravel Application Health Check ===" LARAVEL_STATUS="UNKNOWN" PHP_VERSION="UNKNOWN" COMPOSER_VERSION="UNKNOWN" if [ -n "$CURRENT_RELEASE" ] && [ "$CURRENT_RELEASE" != "NONE" ] && [ -d "$CURRENT_PATH" ]; then cd "$CURRENT_PATH" # Check PHP version PHP_VERSION=$(php -v 2>/dev/null | head -1 | cut -d' ' -f2 || echo "ERROR") echo "? PHP Version: $PHP_VERSION" # Check Composer version if command -v composer2 &> /dev/null; then COMPOSER_VERSION=$(composer2 --version 2>/dev/null | cut -d' ' -f3 || echo "ERROR") COMPOSER_CMD="composer2" elif composer --version 2>/dev/null | grep -q "version 2\."; then COMPOSER_VERSION=$(composer --version 2>/dev/null | cut -d' ' -f3 || echo "ERROR") COMPOSER_CMD="composer" else COMPOSER_VERSION=$(composer --version 2>/dev/null | cut -d' ' -f3 || echo "ERROR") COMPOSER_CMD="composer (1.x)" fi echo "? Composer: $COMPOSER_VERSION ($COMPOSER_CMD)" # Check exec() function availability (critical for shared hosting) EXEC_STATUS=$(php -r "echo function_exists('exec') ? 'AVAILABLE' : 'DISABLED';" 2>/dev/null || echo "ERROR") echo "⚙️ exec() Function: $EXEC_STATUS" if [ "$EXEC_STATUS" = "DISABLED" ]; then echo " ⚠️ exec() disabled - some artisan commands may fail (common on shared hosting)" echo " ℹ️ Our scripts use manual fallbacks to bypass exec() limitations" fi # Check Laravel if [ -f "artisan" ]; then LARAVEL_VERSION=$(php artisan --version 2>/dev/null | head -1 || echo "ERROR") echo "? Laravel: $LARAVEL_VERSION" LARAVEL_STATUS="DETECTED" # Test database connection DB_STATUS="UNKNOWN" MIGRATION_STATUS="UNKNOWN" SCHEMA_STATUS="UNKNOWN" if php artisan tinker --execute="try { DB::connection()->getPdo(); echo 'OK'; } catch(Exception \$e) { echo 'FAILED'; }" 2>/dev/null | grep -q "OK"; then DB_STATUS="✅ CONNECTED" echo "?️ Database: Connected" # ENHANCED: Test migration status and schema integrity echo "? Testing database schema integrity..." # Check if migrations table exists and has recent entries MIGRATION_CHECK=$(php artisan tinker --execute=" try { \$migrations = DB::table('migrations')->count(); \$recent = DB::table('migrations')->where('batch', '>', 0)->count(); echo \"MIGRATIONS_OK:\$migrations:\$recent\"; } catch(Exception \$e) { echo 'MIGRATIONS_FAILED: ' . \$e->getMessage(); } " 2>/dev/null) if echo "$MIGRATION_CHECK" | grep -q "MIGRATIONS_OK"; then MIGRATION_COUNT=$(echo "$MIGRATION_CHECK" | cut -d':' -f2) RECENT_COUNT=$(echo "$MIGRATION_CHECK" | cut -d':' -f3) MIGRATION_STATUS="✅ HEALTHY ($MIGRATION_COUNT migrations, $RECENT_COUNT batched)" echo "? Migrations: $MIGRATION_STATUS" # Test critical Laravel tables exist SCHEMA_CHECK=$(php artisan tinker --execute=" try { \$tables = ['users', 'password_resets', 'failed_jobs']; \$existing = []; foreach(\$tables as \$table) { if(Schema::hasTable(\$table)) \$existing[] = \$table; } echo 'SCHEMA_OK:' . count(\$existing) . '/' . count(\$tables); } catch(Exception \$e) { echo 'SCHEMA_FAILED: ' . \$e->getMessage(); } " 2>/dev/null) if echo "$SCHEMA_CHECK" | grep -q "SCHEMA_OK"; then SCHEMA_RATIO=$(echo "$SCHEMA_CHECK" | cut -d':' -f2) SCHEMA_STATUS="✅ CORE TABLES ($SCHEMA_RATIO)" echo "?️ Schema: $SCHEMA_STATUS" else SCHEMA_STATUS="❌ INCOMPLETE" echo "?️ Schema: $SCHEMA_STATUS - Core tables missing or inaccessible" fi else MIGRATION_STATUS="❌ FAILED" SCHEMA_STATUS="❌ UNKNOWN" echo "? Migrations: $MIGRATION_STATUS - Cannot access migrations table" echo "?️ Schema: $SCHEMA_STATUS - Cannot verify due to migration issues" fi else DB_STATUS="❌ FAILED" MIGRATION_STATUS="❌ NO_CONNECTION" SCHEMA_STATUS="❌ NO_CONNECTION" echo "?️ Database: Connection Failed" echo "? Migrations: Cannot test (no database connection)" echo "?️ Schema: Cannot test (no database connection)" fi # Test cache driver CACHE_STATUS="UNKNOWN" CACHE_DRIVER=$(grep "^CACHE_DRIVER=" "$SHARED_PATH/.env" | cut -d'=' -f2 || echo "file") echo "?️ Cache Driver: $CACHE_DRIVER" if php artisan tinker --execute="try { Cache::put('test_key', 'test_value', 60); Cache::get('test_key'); echo 'OK'; } catch(Exception \$e) { echo 'FAILED: ' . \$e->getMessage(); }" 2>/dev/null | grep -q "OK"; then CACHE_STATUS="✅ WORKING" echo "✅ Cache: Working ($CACHE_DRIVER)" else CACHE_STATUS="❌ FAILED" CACHE_ERROR=$(php artisan tinker --execute="try { Cache::put('test_key', 'test_value', 60); echo 'OK'; } catch(Exception \$e) { echo \$e->getMessage(); }" 2>/dev/null | grep -v "OK" | head -1) echo "❌ Cache: Failed ($CACHE_DRIVER) - $CACHE_ERROR" fi # Test session driver SESSION_STATUS="UNKNOWN" SESSION_DRIVER=$(grep "^SESSION_DRIVER=" "$SHARED_PATH/.env" | cut -d'=' -f2 || echo "file") echo "? Session Driver: $SESSION_DRIVER" if php artisan tinker --execute="try { session(['test_session' => 'test_value']); session('test_session'); echo 'OK'; } catch(Exception \$e) { echo 'FAILED'; }" 2>/dev/null | grep -q "OK"; then SESSION_STATUS="✅ WORKING" echo "✅ Sessions: Working ($SESSION_DRIVER)" else SESSION_STATUS="❌ FAILED" SESSION_ERROR=$(php artisan tinker --execute="try { session(['test_session' => 'test_value']); echo 'OK'; } catch(Exception \$e) { echo \$e->getMessage(); }" 2>/dev/null | grep -v "OK" | head -1) echo "❌ Sessions: Failed ($SESSION_DRIVER) - $SESSION_ERROR" fi # Check critical Laravel directories VENDOR_STATUS=$([ -d "vendor" ] && echo "✅ EXISTS" || echo "❌ MISSING") STORAGE_STATUS=$([ -L "storage" ] && echo "✅ SYMLINKED" || echo "❌ NOT_SYMLINKED") ENV_STATUS=$([ -L ".env" ] && echo "✅ SYMLINKED" || echo "❌ NOT_SYMLINKED") echo "? Vendor: $VENDOR_STATUS" echo "? Storage: $STORAGE_STATUS" echo "⚙️ Environment: $ENV_STATUS" else echo "⚠️ No artisan file found - not a Laravel application" LARAVEL_STATUS="NOT_LARAVEL" fi else echo "⚠️ No current release to analyze" fi # Add Laravel analysis to report cat >> "$REPORT_FILE" << EOF ### ? Laravel Application Health EOF # Add user-friendly Laravel status if [ "$LARAVEL_STATUS" = "DETECTED" ]; then cat >> "$REPORT_FILE" << EOF ✅ **Laravel Framework**: $LARAVEL_VERSION running on PHP $PHP_VERSION ✅ **Dependencies**: Composer $COMPOSER_VERSION with vendor directory intact ✅ **Environment**: Configuration properly symlinked and accessible $([ "$EXEC_STATUS" = "DISABLED" ] && echo "⚠️ **exec() Function**: Disabled (shared hosting) - using manual fallbacks" || echo "✅ **exec() Function**: Available for full artisan support") **Core System Tests:** - **Database**: $([ "$DB_STATUS" = "✅ CONNECTED" ] && echo "✅ Connected and responding" || echo "❌ Connection failed") - **Migrations**: $([ "$MIGRATION_STATUS" = "✅ HEALTHY"* ] && echo "✅ Schema up-to-date" || echo "❌ Migration issues detected") - **Schema Integrity**: $([ "$SCHEMA_STATUS" = "✅ CORE TABLES"* ] && echo "✅ Core tables verified" || echo "❌ Schema incomplete or missing") - **Cache System**: $([ "$CACHE_STATUS" = "✅ WORKING" ] && echo "✅ $CACHE_DRIVER driver working" || echo "❌ $CACHE_DRIVER driver failed - $CACHE_ERROR") - **Session System**: $([ "$SESSION_STATUS" = "✅ WORKING" ] && echo "✅ $SESSION_DRIVER driver working" || echo "❌ $SESSION_DRIVER driver failed - $SESSION_ERROR") - **File Storage**: $([ "$STORAGE_STATUS" = "✅ SYMLINKED" ] && echo "✅ Properly symlinked for zero-downtime" || echo "❌ Not symlinked - data loss risk") **Infrastructure:** - **Dependencies**: $([ "$VENDOR_STATUS" = "✅ EXISTS" ] && echo "$(find "$CURRENT_PATH/vendor" -name "*.php" 2>/dev/null | wc -l) PHP files loaded" || echo "❌ Missing vendor directory") - **Configuration**: $([ "$ENV_STATUS" = "✅ SYMLINKED" ] && echo "✅ Environment shared across deployments" || echo "❌ Not properly configured") EOF else cat >> "$REPORT_FILE" << EOF ⚠️ **Laravel Framework**: Not detected or not working properly - **Status**: $LARAVEL_STATUS - **PHP**: $PHP_VERSION - **Composer**: $COMPOSER_VERSION EOF fi cat >> "$REPORT_FILE" << EOF EOF # C2-06: Security Verification echo "=== Security Verification ===" SECURITY_ISSUES=0 cd "$DOMAIN_ROOT" # Check public_html security if [ -L "public_html" ]; then PUBLIC_TARGET=$(readlink "public_html") if [[ "$PUBLIC_TARGET" == *"/public" ]]; then echo "✅ Web root correctly points to Laravel public directory" else echo "⚠️ Web root does not point to Laravel public directory" SECURITY_ISSUES=$((SECURITY_ISSUES + 1)) fi else echo "❌ Web root is not a symlink - potential security risk" SECURITY_ISSUES=$((SECURITY_ISSUES + 1)) fi # Check for exposed sensitive files in public_html if [ -d "public_html" ]; then cd "public_html" EXPOSED_FILES=() for FILE in .env .env.example composer.json composer.lock package.json .git; do if [ -e "$FILE" ]; then EXPOSED_FILES+=("$FILE") SECURITY_ISSUES=$((SECURITY_ISSUES + 1)) fi done if [ ${#EXPOSED_FILES[@]} -eq 0 ]; then echo "✅ No sensitive files exposed in web root" else echo "❌ Exposed sensitive files: ${EXPOSED_FILES[*]}" fi fi # Check .env permissions cd "$DEPLOY_PATH" if [ -f "$SHARED_PATH/.env" ]; then ENV_PERMS=$(stat -c "%a" "$SHARED_PATH/.env" 2>/dev/null || echo "000") if [ "$ENV_PERMS" = "600" ] || [ "$ENV_PERMS" = "644" ]; then echo "✅ .env file has secure permissions ($ENV_PERMS)" else echo "⚠️ .env file permissions may be too open ($ENV_PERMS)" SECURITY_ISSUES=$((SECURITY_ISSUES + 1)) fi else echo "❌ .env file not found in shared directory" SECURITY_ISSUES=$((SECURITY_ISSUES + 1)) fi # Add security analysis to report cat >> "$REPORT_FILE" << EOF ### Security Analysis | Check | Status | Details | |-------|--------|---------| | Web Root Symlink | $([ -L "$DOMAIN_ROOT/public_html" ] && echo "✅ SECURE" || echo "❌ INSECURE") | Points to: $([ -L "$DOMAIN_ROOT/public_html" ] && readlink "$DOMAIN_ROOT/public_html" || echo "NOT_SYMLINK") | | Exposed Sensitive Files | $([ ${#EXPOSED_FILES[@]} -eq 0 ] && echo "✅ NONE" || echo "❌ FOUND") | $([ ${#EXPOSED_FILES[@]} -gt 0 ] && echo "${EXPOSED_FILES[*]}" || echo "Clean") | | .env Permissions | $([ -f "$SHARED_PATH/.env" ] && echo "✅ $(stat -c "%a" "$SHARED_PATH/.env")" || echo "❌ MISSING") | $([ -f "$SHARED_PATH/.env" ] && echo "File secured" || echo "Environment file not found") | **Security Issues Found:** $SECURITY_ISSUES EOF # C2-07: Performance & Optimization Check echo "=== Performance & Optimization Check ===" OPTIMIZATION_STATUS="UNKNOWN" if [ -n "$CURRENT_RELEASE" ] && [ "$CURRENT_RELEASE" != "NONE" ] && [ -d "$CURRENT_PATH" ]; then cd "$CURRENT_PATH" # Check Laravel caches CONFIG_CACHE=$([ -f "bootstrap/cache/config.php" ] && echo "✅ CACHED" || echo "⚠️ NOT_CACHED") ROUTE_CACHE=$([ -f "bootstrap/cache/routes-v7.php" ] && echo "✅ CACHED" || echo "⚠️ NOT_CACHED") VIEW_CACHE=$(find "storage/framework/views" -name "*.php" 2>/dev/null | wc -l) VIEW_STATUS=$([ $VIEW_CACHE -gt 0 ] && echo "✅ CACHED ($VIEW_CACHE files)" || echo "⚠️ NO_CACHE") echo "⚙️ Config Cache: $CONFIG_CACHE" echo "?️ Route Cache: $ROUTE_CACHE" echo "?️ View Cache: $VIEW_STATUS" # Check Composer optimization if [ -f "vendor/composer/autoload_classmap.php" ]; then CLASSMAP_COUNT=$(wc -l < "vendor/composer/autoload_classmap.php") COMPOSER_OPT=$([ $CLASSMAP_COUNT -gt 100 ] && echo "✅ OPTIMIZED ($CLASSMAP_COUNT classes)" || echo "⚠️ NOT_OPTIMIZED") else COMPOSER_OPT="❌ NO_CLASSMAP" fi echo "? Composer Autoload: $COMPOSER_OPT" # Check OPcache OPCACHE_STATUS=$(php -r "echo function_exists('opcache_get_status') ? 'AVAILABLE' : 'NOT_AVAILABLE';" 2>/dev/null || echo "ERROR") echo "? OPcache: $OPCACHE_STATUS" fi # Add performance analysis to report cat >> "$REPORT_FILE" << EOF ### Performance & Optimization | Component | Status | Details | |-----------|--------|---------| | Config Cache | $([ -n "$CONFIG_CACHE" ] && echo "$CONFIG_CACHE" || echo "⚠️ NOT_CHECKED") | $([ -f "$CURRENT_PATH/bootstrap/cache/config.php" ] && echo "Cached configuration loaded" || echo "No config cache") | | Route Cache | $([ -n "$ROUTE_CACHE" ] && echo "$ROUTE_CACHE" || echo "⚠️ NOT_CHECKED") | $([ -f "$CURRENT_PATH/bootstrap/cache/routes-v7.php" ] && echo "Cached routes loaded" || echo "No route cache") | | View Cache | $([ -n "$VIEW_STATUS" ] && echo "$VIEW_STATUS" || echo "⚠️ NOT_CHECKED") | Compiled view templates | | Composer Autoload | $([ -n "$COMPOSER_OPT" ] && echo "$COMPOSER_OPT" || echo "⚠️ NOT_CHECKED") | Class mapping optimization | | OPcache | $([ "$OPCACHE_STATUS" = "AVAILABLE" ] && echo "✅ $OPCACHE_STATUS" || echo "⚠️ $OPCACHE_STATUS") | PHP bytecode caching | EOF # C2-08: Release Management Analysis echo "=== Release Management Analysis ===" cd "$DEPLOY_PATH" # Analyze releases if [ -d "releases" ]; then RELEASES=($(ls -1t releases/ 2>/dev/null)) TOTAL_RELEASES=${#RELEASES[@]} echo "? Total releases: $TOTAL_RELEASES" if [ $TOTAL_RELEASES -gt 0 ]; then LATEST_RELEASE=${RELEASES[0]} echo "? Latest release: $LATEST_RELEASE" # Calculate release sizes for i in "${!RELEASES[@]}"; do if [ $i -lt 5 ]; then # Only show last 5 releases RELEASE=${RELEASES[$i]} SIZE=$(du -sh "releases/$RELEASE" 2>/dev/null | cut -f1) AGE=$(stat -c %Y "releases/$RELEASE" 2>/dev/null) CURRENT_TIME=$(date +%s) AGE_HOURS=$(( (CURRENT_TIME - AGE) / 3600 )) if [ "$RELEASE" = "$CURRENT_RELEASE" ]; then echo "? $RELEASE: $SIZE (${AGE_HOURS}h ago) [CURRENT]" else echo " $RELEASE: $SIZE (${AGE_HOURS}h ago)" fi fi done # Check for old releases OLD_RELEASES=$(( TOTAL_RELEASES - 3 )) if [ $OLD_RELEASES -gt 0 ]; then echo "?️ Old releases to cleanup: $OLD_RELEASES" fi fi fi # Add release analysis to report cat >> "$REPORT_FILE" << EOF ### Release Management | Metric | Value | Details | |--------|-------|---------| | Total Releases | $TOTAL_RELEASES | Stored in releases/ directory | | Current Release | $CURRENT_RELEASE | $([ -n "$CURRENT_RELEASE" ] && echo "Active deployment" || echo "No active deployment") | | Latest Release | $([ $TOTAL_RELEASES -gt 0 ] && echo "$LATEST_RELEASE" || echo "None") | Most recent in releases/ | | Cleanup Needed | $([ $OLD_RELEASES -gt 0 ] && echo "$OLD_RELEASES releases" || echo "None") | Releases beyond keep limit (3) | #### Recent Releases \`\`\` EOF if [ $TOTAL_RELEASES -gt 0 ]; then for i in "${!RELEASES[@]}"; do if [ $i -lt 5 ]; then RELEASE=${RELEASES[$i]} SIZE=$(du -sh "releases/$RELEASE" 2>/dev/null | cut -f1) AGE=$(stat -c %Y "releases/$RELEASE" 2>/dev/null) CURRENT_TIME=$(date +%s) AGE_HOURS=$(( (CURRENT_TIME - AGE) / 3600 )) if [ "$RELEASE" = "$CURRENT_RELEASE" ]; then echo "$RELEASE: $SIZE (${AGE_HOURS}h ago) [CURRENT]" >> "$REPORT_FILE" else echo "$RELEASE: $SIZE (${AGE_HOURS}h ago)" >> "$REPORT_FILE" fi fi done else echo "No releases found" >> "$REPORT_FILE" fi cat >> "$REPORT_FILE" << EOF \`\`\` EOF # C2-09: HTTP Health Check echo "=== HTTP Health Check ===" HTTP_STATUS="UNKNOWN" RESPONSE_TIME="UNKNOWN" if [ -n "$CURRENT_RELEASE" ] && [ "$CURRENT_RELEASE" != "NONE" ] && [ -f "$SHARED_PATH/.env" ]; then APP_URL=$(grep "^APP_URL=" "$SHARED_PATH/.env" | cut -d'=' -f2 | tr -d '"' | tr -d "'") if [ -n "$APP_URL" ] && command -v curl &> /dev/null; then echo "? Testing: $APP_URL" # Test main page START_TIME=$(date +%s.%N) HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL" --max-time 10 2>/dev/null || echo "000") END_TIME=$(date +%s.%N) RESPONSE_TIME=$(echo "$END_TIME - $START_TIME" | bc 2>/dev/null || echo "unknown") # Test install page first (for fresh deployments) INSTALL_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/install" --max-time 10 2>/dev/null || echo "000") case $HTTP_CODE in 200|201|301|302) HTTP_STATUS="✅ HEALTHY ($HTTP_CODE)" echo "✅ Application responding: HTTP $HTTP_CODE (${RESPONSE_TIME}s)" ;; 503) HTTP_STATUS="⚠️ MAINTENANCE ($HTTP_CODE)" echo "⚠️ Application in maintenance mode: HTTP $HTTP_CODE" ;; 500) if [ "$INSTALL_CODE" = "200" ]; then HTTP_STATUS="✅ PENDING_INSTALL ($HTTP_CODE)" echo "✅ Fresh deployment detected: Main site HTTP $HTTP_CODE, Install page accessible" echo "ℹ️ This is EXPECTED - complete installation at: $APP_URL/install" else HTTP_STATUS="❌ ERROR ($HTTP_CODE)" echo "❌ Application error: HTTP $HTTP_CODE (install page also failed)" fi ;; 000) HTTP_STATUS="❌ UNREACHABLE" echo "❌ Application unreachable (timeout/connection error)" ;; *) HTTP_STATUS="⚠️ ERROR ($HTTP_CODE)" echo "⚠️ Application returned: HTTP $HTTP_CODE" if [ "$INSTALL_CODE" = "200" ]; then echo "ℹ️ Install page accessible: HTTP $INSTALL_CODE" fi ;; esac else echo "⚠️ Cannot test HTTP (no APP_URL or curl unavailable)" fi else echo "⚠️ Cannot determine APP_URL" fi # Add HTTP analysis to report cat >> "$REPORT_FILE" << EOF ### ? Website Status EOF # Add user-friendly HTTP status if [[ "$HTTP_STATUS" =~ "PENDING_INSTALL" ]]; then cat >> "$REPORT_FILE" << EOF ✅ **Fresh Deployment Ready**: Your app is deployed correctly and ready for setup - **Main Site**: Shows setup screen (HTTP $HTTP_CODE) - This is EXPECTED - **Install Page**: \`$APP_URL/install\` is accessible (HTTP $INSTALL_CODE) - **Next Step**: Complete installation wizard at \`$APP_URL/install\` ? **Status**: Ready for first-time setup EOF elif [[ "$HTTP_STATUS" =~ "HEALTHY" ]]; then cat >> "$REPORT_FILE" << EOF ✅ **Website Online**: Your application is running properly - **Main Site**: \`$APP_URL\` responding (HTTP $HTTP_CODE) - **Response Time**: ${RESPONSE_TIME}s - **Status**: Fully operational ? **Status**: Production ready EOF elif [[ "$HTTP_STATUS" =~ "MAINTENANCE" ]]; then cat >> "$REPORT_FILE" << EOF ⚠️ **Maintenance Mode**: Site temporarily offline for updates - **Main Site**: \`$APP_URL\` in maintenance (HTTP $HTTP_CODE) - **Status**: Planned downtime ? **Status**: Maintenance in progress EOF else cat >> "$REPORT_FILE" << EOF ❌ **Website Issues**: Problems detected with site access - **Main Site**: \`$APP_URL\` error (HTTP $HTTP_CODE) - **Install Page**: $([ "$INSTALL_CODE" = "200" ] && echo "Accessible (HTTP $INSTALL_CODE)" || echo "Also failed (HTTP $INSTALL_CODE)") ? **Status**: Needs troubleshooting EOF fi cat >> "$REPORT_FILE" << EOF EOF # C2-10: Final Summary and Recommendations echo "=== Generating Final Summary ===" # Calculate overall health score TOTAL_CHECKS=14 PASSED_CHECKS=0 [ "$SYMLINK_STATUS" = "HEALTHY" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [ "$LARAVEL_STATUS" = "DETECTED" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [ "$DB_STATUS" = "✅ CONNECTED" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [[ "$MIGRATION_STATUS" =~ "✅ HEALTHY" ]] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [[ "$SCHEMA_STATUS" =~ "✅ CORE TABLES" ]] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [ "$CACHE_STATUS" = "✅ WORKING" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [ "$SESSION_STATUS" = "✅ WORKING" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [ "$VENDOR_STATUS" = "✅ EXISTS" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [ "$STORAGE_STATUS" = "✅ SYMLINKED" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [ "$ENV_STATUS" = "✅ SYMLINKED" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [ $SECURITY_ISSUES -eq 0 ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [ "$CONFIG_CACHE" = "✅ CACHED" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) # HTTP check passes if: working (200/301/302), pending install (500 + install accessible), or maintenance (503) ([ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "503" ] || [[ "$HTTP_STATUS" =~ "PENDING_INSTALL" ]]) && PASSED_CHECKS=$((PASSED_CHECKS + 1)) [ $TOTAL_RELEASES -gt 0 ] && PASSED_CHECKS=$((PASSED_CHECKS + 1)) HEALTH_PERCENTAGE=$(( (PASSED_CHECKS * 100) / TOTAL_CHECKS )) # Determine overall status if [ $HEALTH_PERCENTAGE -ge 90 ]; then OVERALL_STATUS="? EXCELLENT" elif [ $HEALTH_PERCENTAGE -ge 75 ]; then OVERALL_STATUS="? GOOD" elif [ $HEALTH_PERCENTAGE -ge 50 ]; then OVERALL_STATUS="? NEEDS_ATTENTION" else OVERALL_STATUS="? CRITICAL" fi echo "? Overall Health: $HEALTH_PERCENTAGE% ($PASSED_CHECKS/$TOTAL_CHECKS checks passed)" echo "? Status: $OVERALL_STATUS" # Add final summary to report cat >> "$REPORT_FILE" << EOF --- ## ? FINAL ASSESSMENT ### Overall Health Score: $HEALTH_PERCENTAGE% ($PASSED_CHECKS/$TOTAL_CHECKS) ### Status: $OVERALL_STATUS ### Summary by Category: - **Infrastructure:** $([ "$SYMLINK_STATUS" = "HEALTHY" ] && echo "✅ Healthy" || echo "⚠️ Issues") - **Laravel Application:** $([ "$LARAVEL_STATUS" = "DETECTED" ] && echo "✅ Detected" || echo "⚠️ Issues") - **Database:** $([ "$DB_STATUS" = "✅ CONNECTED" ] && echo "✅ Connected" || echo "⚠️ Issues") - **Database Migrations:** $([[ "$MIGRATION_STATUS" =~ "✅ HEALTHY" ]] && echo "✅ Schema Current" || echo "⚠️ Migration Issues") - **Schema Integrity:** $([[ "$SCHEMA_STATUS" =~ "✅ CORE TABLES" ]] && echo "✅ Tables Verified" || echo "⚠️ Schema Problems") - **Cache System:** $([ "$CACHE_STATUS" = "✅ WORKING" ] && echo "✅ Working ($CACHE_DRIVER)" || echo "⚠️ Failed ($CACHE_DRIVER)") - **Session System:** $([ "$SESSION_STATUS" = "✅ WORKING" ] && echo "✅ Working ($SESSION_DRIVER)" || echo "⚠️ Failed ($SESSION_DRIVER)") - **Security:** $([ $SECURITY_ISSUES -eq 0 ] && echo "✅ Secure" || echo "⚠️ $SECURITY_ISSUES issues") - **Performance:** $([ "$CONFIG_CACHE" = "✅ CACHED" ] && echo "✅ Optimized" || echo "⚠️ Not optimized") - **HTTP Response:** $(if [[ "$HTTP_STATUS" =~ "HEALTHY" ]]; then echo "✅ Healthy"; elif [[ "$HTTP_STATUS" =~ "PENDING_INSTALL" ]]; then echo "✅ Ready for setup"; elif [[ "$HTTP_STATUS" =~ "MAINTENANCE" ]]; then echo "⚠️ Maintenance"; else echo "⚠️ Issues"; fi) ### Recommendations: EOF # Generate recommendations if [ "$SYMLINK_STATUS" != "HEALTHY" ]; then echo "- ? **Fix symlink issues** - Critical for zero-downtime deployment" >> "$REPORT_FILE" fi if [ $SECURITY_ISSUES -gt 0 ]; then echo "- ? **Address security issues** - $SECURITY_ISSUES problems found" >> "$REPORT_FILE" fi if [ "$CACHE_STATUS" = "❌ FAILED" ]; then echo "- ?️ **Fix Cache System** - $CACHE_DRIVER driver failed. Consider switching to \`file\` driver in .env" >> "$REPORT_FILE" fi if [ "$SESSION_STATUS" = "❌ FAILED" ]; then echo "- ? **Fix Session System** - $SESSION_DRIVER driver failed. Consider switching to \`file\` driver in .env" >> "$REPORT_FILE" fi if [ "$CONFIG_CACHE" != "✅ CACHED" ]; then echo "- ⚡ **Enable Laravel caching** - Run \`php artisan config:cache\` and \`php artisan route:cache\`" >> "$REPORT_FILE" fi if [ $OLD_RELEASES -gt 0 ]; then echo "- ?️ **Cleanup old releases** - Remove $OLD_RELEASES old releases to save disk space" >> "$REPORT_FILE" fi if [[ "$HTTP_STATUS" =~ "PENDING_INSTALL" ]]; then echo "- ? **Complete Installation** - Visit \`$APP_URL/install\` to finish setup" >> "$REPORT_FILE" elif [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "301" ] && [ "$HTTP_CODE" != "302" ] && [ "$HTTP_CODE" != "503" ]; then echo "- ? **Fix HTTP issues** - Application not responding correctly (HTTP $HTTP_CODE)" >> "$REPORT_FILE" fi if [ "$DB_STATUS" != "✅ CONNECTED" ]; then echo "- ?️ **Fix database connection** - Application cannot connect to database" >> "$REPORT_FILE" fi if [[ ! "$MIGRATION_STATUS" =~ "✅ HEALTHY" ]]; then echo "- ? **Fix migration issues** - Database schema may be incomplete or corrupted" >> "$REPORT_FILE" echo " - Run: \`php artisan migrate --force\` to update schema" >> "$REPORT_FILE" echo " - Check: \`php artisan migrate:status\` for pending migrations" >> "$REPORT_FILE" fi if [[ ! "$SCHEMA_STATUS" =~ "✅ CORE TABLES" ]]; then echo "- ? **Verify database schema** - Core Laravel tables missing or inaccessible" >> "$REPORT_FILE" echo " - This often indicates failed migrations or Faker dependency issues" >> "$REPORT_FILE" echo " - Check migration logs and ensure build artifacts contain all dependencies" >> "$REPORT_FILE" fi # Add no issues message if everything is good if [ $HEALTH_PERCENTAGE -ge 90 ]; then echo "- ✅ **No critical issues found** - Deployment is healthy and ready for production" >> "$REPORT_FILE" {{ ... }} cat >> "$REPORT_FILE" << EOF --- ## ? DETAILED LOGS ### Environment Variables \`\`\`bash DOMAIN_NAME=$DOMAIN_NAME DEPLOY_PATH=$DEPLOY_PATH CURRENT_RELEASE=$CURRENT_RELEASE TOTAL_RELEASES=$TOTAL_RELEASES SHARED_SIZE=$SHARED_SIZE PHP_VERSION=$PHP_VERSION COMPOSER_VERSION=$COMPOSER_VERSION \`\`\` ### File Permissions \`\`\`bash EOF # Add file permissions if [ -f "$SHARED_PATH/.env" ]; then echo "shared/.env: $(stat -c "%a %U:%G" "$SHARED_PATH/.env" 2>/dev/null)" >> "$REPORT_FILE" fi if [ -d "$SHARED_PATH/storage" ]; then echo "shared/storage: $(stat -c "%a %U:%G" "$SHARED_PATH/storage" 2>/dev/null)" >> "$REPORT_FILE" fi cat >> "$REPORT_FILE" << EOF \`\`\` ### Disk Usage \`\`\`bash EOF du -sh releases/* 2>/dev/null | tail -5 >> "$REPORT_FILE" || echo "No releases found" >> "$REPORT_FILE" cat >> "$REPORT_FILE" << EOF \`\`\` --- **Report Generated:** $(date '+%Y-%m-%d %H:%M:%S') **Script Version:** Phase C-2 v2.0 **Next Report:** Run Phase C-2 after next deployment EOF # C2-11: Cleanup and Final Output echo "=== Finalizing Report ===" # Clean up temporary files rm -f /tmp/symlink_report /tmp/shared_report # Set proper permissions on report chmod 644 "$REPORT_FILE" # Create latest report symlink cd "$REPORT_DIR" rm -f latest-report.md ln -sf "$(basename "$REPORT_FILE")" latest-report.md echo "✅ Comprehensive verification completed" echo "? Report saved: $REPORT_FILE" echo "? Latest report: $REPORT_DIR/latest-report.md" echo "? Overall Health: $HEALTH_PERCENTAGE% - $OVERALL_STATUS" # Return to original directory cd "$DEPLOY_PATH" echo "? Phase C-2 completed successfully" exit 0 ]

=== Phase C-2: Comprehensive Deployment Verification & Reporting ===
? DEPLOYHQ MODE: Using DeployHQ path variables
? Path Variables:
   Deploy Path: /home/u227177893/domains/staging.societypal.com/deploy
   Release Path: /home/u227177893/domains/staging.societypal.com/deploy/releases/20250820030010
   Shared Path: /home/u227177893/domains/staging.societypal.com/deploy/shared
   Current Path: /home/u227177893/domains/staging.societypal.com/deploy/current
? Starting comprehensive deployment verification...
   Domain: staging.societypal.com
   Deploy Path: /home/u227177893/domains/staging.societypal.com/deploy
   Report: /home/u227177893/domains/staging.societypal.com/deployment-reports/deployment-report-20250820_030248.md
=== Environment Detection ===
✅ Current release detected: 20250820030010
? Total releases: 4
? Shared directory size: 16M
=== Critical Symlink Verification ===
✅ Web Root (public_html): deploy/current/public
✅ Current Release: ./releases/20250820030010
✅ Environment File: /home/u227177893/domains/staging.societypal.com/deploy/shared/.env
✅ Storage Directory: ../../shared/storage
✅ Bootstrap Cache: ../../../shared/bootstrap/cache
✅ Public Storage: ../storage/app/public
=== Shared Directory Analysis ===
✅ Laravel Storage: 13M (512 files)
✅ Bootstrap Cache: 588K (5 files)
✅ Environment File: 8.0K (1 file)
✅ User Content: uploads: 4.0K (0 files)
✅ User Content: user-uploads: 4.0K (0 files)
✅ User Content: media: 4.0K (0 files)
✅ User Content: avatars: 4.0K (0 files)
✅ User Content: attachments: 4.0K (0 files)
✅ User Content: documents: 4.0K (0 files)
✅ User Content: files: 4.0K (0 files)
✅ User Content: images: 4.0K (0 files)
✅ Generated: qrcodes: 4.0K (0 files)
✅ Generated: barcodes: 4.0K (0 files)
✅ Generated: certificates: 4.0K (0 files)
✅ Generated: reports: 4.0K (0 files)
✅ CodeCanyon Modules: 4.0K (0 files)
=== Laravel Application Health Check ===
? PHP Version: 8.2.28
? Composer: 2.5.5 (composer2)
⚙️ exec() Function: DISABLED
   ⚠️ exec() disabled - some artisan commands may fail (common on shared hosting)
   ℹ️ Our scripts use manual fallbacks to bypass exec() limitations
? Laravel: Laravel Framework 12.17.0
?️ Database: Connected
? Testing database schema integrity...
? Migrations: ✅ HEALTHY (104 migrations, 104 batched)
?️ Schema: ✅ CORE TABLES (2/3)
?️ Cache Driver: file
✅ Cache: Working (file)
? Session Driver: file
✅ Sessions: Working (file)
? Vendor: ✅ EXISTS
? Storage: ✅ SYMLINKED
⚙️ Environment: ✅ SYMLINKED
=== Security Verification ===
✅ Web root correctly points to Laravel public directory
✅ No sensitive files exposed in web root
✅ .env file has secure permissions (600)
=== Performance & Optimization Check ===
⚙️ Config Cache: ✅ CACHED
?️ Route Cache: ✅ CACHED
?️ View Cache: ✅ CACHED (483 files)
? Composer Autoload: ✅ OPTIMIZED (9430 classes)
? OPcache: AVAILABLE
=== Release Management Analysis ===
? Total releases: 4
? Latest release: 20250820030010
? 20250820030010: 243M (0h ago) [CURRENT]
   20250820000841: 243M (2h ago)
   20250820004609: 243M (2h ago)
   20250819214954: 243M (5h ago)
?️ Old releases to cleanup: 1
=== HTTP Health Check ===
? Testing: https://staging.societypal.com
❌ Application error: HTTP 500 (install page also failed)
=== Generating Final Summary ===
? Overall Health: 92% (13/14 checks passed)
? Status: ? EXCELLENT
bash: -c: line 1015: syntax error: unexpected end of file
Time taken to run 7. Phase C-2: Comprehensive Deployment Verification & Reporting: 6.62 seconds


Running SSH command 8. Phase C-3: Comprehensive Health Check & Auto-Fix - V2

Executing 8. Phase C-3: Comprehensive Health Check & Auto-Fix - V2 [#!/bin/bash set -e # Phase C-3: Comprehensive Health Check & Auto-Fix # Purpose: Debug HTTP 500, ensure app functionality, auto-fix common issues # Version 3.0 - PRODUCTION READY (Enhanced with /home/u227177893/domains/staging.societypal.com/deploy variable only) # Run after Phase C to verify deployment health and auto-fix issues echo "=== Phase C-3: Comprehensive Health Check & Auto-Fix ===" # ENHANCED: Define all variables relative to /home/u227177893/domains/staging.societypal.com/deploy (only available DeployHQ variable) # /home/u227177893/domains/staging.societypal.com/deploy = Base server path we're deploying to (e.g., /home/user/domains/site.com/deploy) DEPLOY_PATH="/home/u227177893/domains/staging.societypal.com/deploy" SHARED_PATH="$DEPLOY_PATH/shared" CURRENT_PATH="$DEPLOY_PATH/current" cd "$CURRENT_PATH" echo "? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):" echo " Base Deploy Path: $DEPLOY_PATH" echo " Current Path: $CURRENT_PATH" echo " Shared Path: $SHARED_PATH" # Initialize counters and tracking TOTAL_CHECKS=0 PASSED_CHECKS=0 ISSUES_FOUND=0 FIXES_APPLIED=0 # Initialize issue tracking files echo "" > /tmp/c3_issues_log echo "" > /tmp/c3_fixes_log echo "" > /tmp/c3_detailed_issues echo "" > /tmp/c3_action_items # Helper function to log results with enhanced tracking log_check() { local CHECK_NAME="$1" local STATUS="$2" local DETAILS="$3" local CATEGORY="${4:-General}" local IMPACT="${5:-Medium}" TOTAL_CHECKS=$((TOTAL_CHECKS + 1)) if [ "$STATUS" = "PASS" ]; then echo "✅ $CHECK_NAME: $DETAILS" PASSED_CHECKS=$((PASSED_CHECKS + 1)) elif [ "$STATUS" = "WARN" ]; then echo "⚠️ $CHECK_NAME: $DETAILS" ISSUES_FOUND=$((ISSUES_FOUND + 1)) # Log issue for report with enhanced details echo "- ⚠️ **$CHECK_NAME**: $DETAILS" >> /tmp/c3_issues_log echo "$CATEGORY|WARNING|$CHECK_NAME|$DETAILS|$IMPACT" >> /tmp/c3_detailed_issues else echo "❌ $CHECK_NAME: $DETAILS" ISSUES_FOUND=$((ISSUES_FOUND + 1)) # Log issue for report with enhanced details echo "- ❌ **$CHECK_NAME**: $DETAILS" >> /tmp/c3_issues_log echo "$CATEGORY|ERROR|$CHECK_NAME|$DETAILS|$IMPACT" >> /tmp/c3_detailed_issues fi } # Helper function to apply fixes with enhanced logging apply_fix() { local FIX_NAME="$1" local COMMAND="$2" local DESCRIPTION="${3:-Auto-fix applied}" echo "? Applying fix: $FIX_NAME" if eval "$COMMAND"; then echo "✅ Fix applied: $FIX_NAME" FIXES_APPLIED=$((FIXES_APPLIED + 1)) # Log fix for report with description echo "- ✅ **$FIX_NAME**: Successfully applied" >> /tmp/c3_fixes_log echo "SUCCESS|$FIX_NAME|$DESCRIPTION" >> /tmp/c3_action_items return 0 else echo "❌ Fix failed: $FIX_NAME" # Log failed fix for report echo "- ❌ **$FIX_NAME**: Failed to apply" >> /tmp/c3_fixes_log echo "FAILED|$FIX_NAME|$DESCRIPTION" >> /tmp/c3_action_items return 1 fi } # Helper function to add action items add_action_item() { local PRIORITY="$1" local TITLE="$2" local DESCRIPTION="$3" local COMMAND="${4:-N/A}" echo "ACTION|$PRIORITY|$TITLE|$DESCRIPTION|$COMMAND" >> /tmp/c3_action_items } echo "? Starting comprehensive health checks..." # C3-01: Basic Laravel Health Check echo "=== Laravel Framework Health ===" if [ -f "artisan" ]; then if php artisan --version >/dev/null 2>&1; then LARAVEL_VERSION=$(php artisan --version 2>/dev/null | head -1) log_check "Laravel Framework" "PASS" "$LARAVEL_VERSION" "Core" "High" else log_check "Laravel Framework" "FAIL" "Artisan command failed" "Core" "Critical" # Try to get more info echo " ? Debug: $(php artisan --version 2>&1 | head -1)" add_action_item "HIGH" "Fix Laravel Framework" "Artisan command failing - check PHP configuration and dependencies" "php artisan --version" # Auto-fix: Try to reinstall dependencies echo "? Attempting to fix Laravel dependencies..." COMPOSER_CMD="composer" if command -v composer2 &> /dev/null; then COMPOSER_CMD="composer2" fi # CRITICAL: DO NOT run composer install - it destroys build artifacts echo "❌ Laravel framework broken - this indicates a build process failure" echo "? Build artifacts should contain all required dependencies (including dev deps)" echo "? DO NOT run composer install here - it will destroy the correct dependency set" echo "? Manual intervention required: Re-deploy with proper build process" add_action_item "CRITICAL" "Re-deploy with Build Process" "Laravel framework not operational - build artifacts may be corrupted" "Re-deploy from build server with complete dependency set" # Skip the composer install and retest logic if false; then # Retest Laravel after fix if php artisan --version >/dev/null 2>&1; then LARAVEL_VERSION=$(php artisan --version 2>/dev/null | head -1) echo "✅ Laravel Framework now working: $LARAVEL_VERSION" # Update the log to reflect the fix PASSED_CHECKS=$((PASSED_CHECKS + 1)) ISSUES_FOUND=$((ISSUES_FOUND - 1)) fi fi fi else log_check "Laravel Framework" "FAIL" "No artisan file found" "Core" "Critical" add_action_item "CRITICAL" "Laravel Installation Missing" "No artisan file found - Laravel may not be properly installed" "Check deployment and ensure Laravel files are present" fi # C3-02: Environment Configuration Check echo "=== Environment Configuration ===" if [ -f ".env" ]; then log_check "Environment File" "PASS" ".env file exists and readable" "Configuration" "High" # Check required variables with enhanced logging REQUIRED_VARS=("APP_KEY" "DB_DATABASE" "DB_USERNAME" "DB_PASSWORD") MISSING_VARS=() for VAR in "${REQUIRED_VARS[@]}"; do VALUE=$(grep "^${VAR}=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'" 2>/dev/null) if [ -n "$VALUE" ]; then log_check "Required Var: $VAR" "PASS" "Set" "Configuration" "Medium" else log_check "Required Var: $VAR" "FAIL" "Missing or empty" "Configuration" "High" MISSING_VARS+=("$VAR") fi done # Add action item for missing variables if [ ${#MISSING_VARS[@]} -gt 0 ]; then add_action_item "HIGH" "Configure Missing Environment Variables" "Missing: ${MISSING_VARS[*]}" "Edit .env file and set: ${MISSING_VARS[*]}" fi else log_check "Environment File" "FAIL" ".env file missing" "Configuration" "Critical" add_action_item "CRITICAL" "Create Environment File" "No .env file found - application cannot start" "cp .env.example .env && php artisan key:generate" fi # C3-03: Database Connection Test echo "=== Database Connection ===" if [ -f "artisan" ] && [ -f ".env" ]; then DB_TEST_RESULT=$(php artisan tinker --execute="try { DB::connection()->getPdo(); echo 'OK'; } catch(Exception \$e) { echo 'FAILED: ' . \$e->getMessage(); }" 2>/dev/null) if echo "$DB_TEST_RESULT" | grep -q "OK"; then log_check "Database Connection" "PASS" "Connected successfully" "Database" "High" else log_check "Database Connection" "FAIL" "Connection failed" "Database" "Critical" echo " ? Debug: $DB_TEST_RESULT" add_action_item "CRITICAL" "Fix Database Connection" "Cannot connect to database - check credentials and server" "Verify DB_HOST, DB_DATABASE, DB_USERNAME, DB_PASSWORD in .env" fi else log_check "Database Connection" "WARN" "Cannot test (missing artisan or .env)" "Database" "Medium" fi # C3-04: Cache System Health Check echo "=== Cache System Health ===" if [ -f ".env" ]; then CACHE_DRIVER=$(grep "^CACHE_DRIVER=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'" 2>/dev/null) CACHE_DRIVER=${CACHE_DRIVER:-file} echo "? Cache driver: $CACHE_DRIVER" # Test cache functionality CACHE_TEST_SCRIPT=' <?php require_once "vendor/autoload.php"; $app = require_once "bootstrap/app.php"; try { Cache::put("health_check", "test_value", 60); $value = Cache::get("health_check"); if ($value === "test_value") { Cache::forget("health_check"); echo "CACHE_OK"; } else { echo "CACHE_FAILED"; } } catch (Exception $e) { echo "CACHE_ERROR: " . $e->getMessage(); } ' CACHE_RESULT=$(echo "$CACHE_TEST_SCRIPT" | php 2>/dev/null) if echo "$CACHE_RESULT" | grep -q "CACHE_OK"; then log_check "Cache System" "PASS" "$CACHE_DRIVER driver working" "Performance" "Medium" elif echo "$CACHE_RESULT" | grep -q "CACHE_ERROR.*Redis"; then log_check "Cache System" "FAIL" "Redis cache configured but not available" "Performance" "High" # Auto-fix: Switch to file cache if apply_fix "Switch cache driver to file" "sed -i 's/CACHE_DRIVER=redis/CACHE_DRIVER=file/' .env" "Switch from Redis to file-based cache"; then # Clear config cache to apply changes apply_fix "Clear config cache" "php artisan config:clear 2>/dev/null" "Clear cached configuration" fi else log_check "Cache System" "WARN" "Cache test inconclusive: $CACHE_RESULT" "Performance" "Medium" add_action_item "MEDIUM" "Investigate Cache System" "Cache test returned unexpected result" "Check cache configuration and test manually" fi else log_check "Cache System" "WARN" "Cannot test (missing .env)" "Performance" "Low" fi # C3-05: Session System Health Check echo "=== Session System Health ===" if [ -f ".env" ]; then SESSION_DRIVER=$(grep "^SESSION_DRIVER=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'" 2>/dev/null) SESSION_DRIVER=${SESSION_DRIVER:-file} echo "? Session driver: $SESSION_DRIVER" if [ "$SESSION_DRIVER" = "redis" ]; then # Test Redis session REDIS_SESSION_TEST=' <?php require_once "vendor/autoload.php"; $app = require_once "bootstrap/app.php"; try { $redis = app("redis"); $redis->ping(); echo "REDIS_SESSION_OK"; } catch (Exception $e) { echo "REDIS_SESSION_ERROR: " . $e->getMessage(); } ' REDIS_RESULT=$(echo "$REDIS_SESSION_TEST" | php 2>/dev/null) if echo "$REDIS_RESULT" | grep -q "REDIS_SESSION_OK"; then log_check "Session System" "PASS" "Redis session working" "Security" "Medium" else log_check "Session System" "FAIL" "Redis session configured but not available" "Security" "High" # Auto-fix: Switch to file sessions if apply_fix "Switch session driver to file" "sed -i 's/SESSION_DRIVER=redis/SESSION_DRIVER=file/' .env" "Switch from Redis to file-based sessions"; then apply_fix "Clear config cache" "php artisan config:clear 2>/dev/null" "Clear cached configuration" fi fi else log_check "Session System" "PASS" "$SESSION_DRIVER driver configured" "Security" "Medium" fi else log_check "Session System" "WARN" "Cannot test (missing .env)" "Security" "Low" fi # C3-06: Queue System Health Check echo "=== Queue System Health ===" if [ -f ".env" ]; then QUEUE_CONNECTION=$(grep "^QUEUE_CONNECTION=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'" 2>/dev/null) QUEUE_CONNECTION=${QUEUE_CONNECTION:-sync} echo "? Queue connection: $QUEUE_CONNECTION" if [ "$QUEUE_CONNECTION" = "redis" ]; then # Test Redis queue REDIS_QUEUE_TEST=' <?php require_once "vendor/autoload.php"; $app = require_once "bootstrap/app.php"; try { Queue::connection("redis")->size(); echo "REDIS_QUEUE_OK"; } catch (Exception $e) { echo "REDIS_QUEUE_ERROR: " . $e->getMessage(); } ' QUEUE_RESULT=$(echo "$REDIS_QUEUE_TEST" | php 2>/dev/null) if echo "$QUEUE_RESULT" | grep -q "REDIS_QUEUE_OK"; then log_check "Queue System" "PASS" "Redis queue working" "Performance" "Low" else log_check "Queue System" "FAIL" "Redis queue configured but not available" "Performance" "Medium" # Auto-fix: Switch to sync queue if apply_fix "Switch queue to sync" "sed -i 's/QUEUE_CONNECTION=redis/QUEUE_CONNECTION=sync/' .env" "Switch from Redis to sync queue"; then apply_fix "Clear config cache" "php artisan config:clear 2>/dev/null" "Clear cached configuration" fi fi else log_check "Queue System" "PASS" "$QUEUE_CONNECTION driver configured" "Performance" "Low" fi else log_check "Queue System" "WARN" "Cannot test (missing .env)" "Performance" "Low" fi # C3-07: PHP Extensions Check echo "=== PHP Extensions Health ===" REQUIRED_EXTENSIONS=("openssl" "pdo" "mbstring" "tokenizer" "xml" "ctype" "json" "bcmath" "fileinfo") MISSING_EXTENSIONS=() for EXT in "${REQUIRED_EXTENSIONS[@]}"; do if php -m | grep -q "$EXT"; then log_check "PHP Extension: $EXT" "PASS" "Loaded" "Environment" "Medium" else log_check "PHP Extension: $EXT" "FAIL" "Missing - contact hosting provider" "Environment" "High" MISSING_EXTENSIONS+=("$EXT") fi done # Add action item for missing extensions if [ ${#MISSING_EXTENSIONS[@]} -gt 0 ]; then add_action_item "HIGH" "Install Missing PHP Extensions" "Missing: ${MISSING_EXTENSIONS[*]}" "Contact hosting provider to install: ${MISSING_EXTENSIONS[*]}" fi # C3-08: Disabled Functions Check echo "=== PHP Functions Health ===" DISABLED_FUNCTIONS=$(php -r "echo ini_get('disable_functions');" 2>/dev/null) PROBLEMATIC_DISABLED=() if [ -n "$DISABLED_FUNCTIONS" ]; then echo "? Disabled PHP functions: $DISABLED_FUNCTIONS" # Check for commonly problematic functions PROBLEMATIC_FUNCTIONS=("exec" "shell_exec" "proc_open" "system" "passthru") for FUNC in "${PROBLEMATIC_FUNCTIONS[@]}"; do if echo "$DISABLED_FUNCTIONS" | grep -q "$FUNC"; then log_check "PHP Function: $FUNC" "WARN" "Disabled by hosting provider" "Environment" "Medium" PROBLEMATIC_DISABLED+=("$FUNC") else log_check "PHP Function: $FUNC" "PASS" "Available" "Environment" "Low" fi done # Add action item if critical functions are disabled if [ ${#PROBLEMATIC_DISABLED[@]} -gt 0 ]; then add_action_item "MEDIUM" "PHP Functions Disabled" "Functions disabled: ${PROBLEMATIC_DISABLED[*]} - Some Laravel features may be limited" "This is normal for shared hosting. Use manual alternatives when needed." fi else log_check "PHP Functions" "PASS" "No functions disabled" "Environment" "Low" fi # C3-09: Storage and Permissions Check echo "=== Storage & Permissions Health ===" # Check critical directories CRITICAL_DIRS=("storage" "bootstrap/cache" "public/storage") BROKEN_DIRS=() for DIR in "${CRITICAL_DIRS[@]}"; do if [ -e "$DIR" ]; then if [ -w "$DIR" ]; then log_check "Directory: $DIR" "PASS" "Exists and writable" "Security" "High" else log_check "Directory: $DIR" "FAIL" "Not writable" "Security" "High" BROKEN_DIRS+=("$DIR") # Auto-fix: Set permissions apply_fix "Fix permissions for $DIR" "chmod -R 775 '$DIR' 2>/dev/null" "Set proper write permissions" fi else log_check "Directory: $DIR" "FAIL" "Missing" "Security" "High" BROKEN_DIRS+=("$DIR") # Auto-fix: Create directory if [ "$DIR" = "public/storage" ]; then apply_fix "Create storage symlink" "ln -sfn ../storage/app/public public/storage" "Create symlink for public file access" else apply_fix "Create directory $DIR" "mkdir -p '$DIR' && chmod 775 '$DIR'" "Create missing directory with proper permissions" fi fi done # Add action item for broken directories if [ ${#BROKEN_DIRS[@]} -gt 0 ]; then add_action_item "HIGH" "Fix Directory Issues" "Problems with: ${BROKEN_DIRS[*]}" "Check and fix permissions/symlinks for: ${BROKEN_DIRS[*]}" fi # C3-10: Configuration Cache Health echo "=== Configuration Cache Health ===" if [ -f "bootstrap/cache/config.php" ]; then log_check "Config Cache" "PASS" "Configuration cached" "Performance" "Medium" # Check if cached config has Redis references when Redis is broken if grep -q "redis" bootstrap/cache/config.php && echo "$CACHE_RESULT $REDIS_RESULT $QUEUE_RESULT" | grep -q "ERROR"; then log_check "Config Cache Content" "WARN" "Cached config references broken Redis" "Performance" "High" # Auto-fix: Clear and rebuild config cache apply_fix "Rebuild config cache" "php artisan config:clear && php artisan config:cache 2>/dev/null" "Rebuild config cache with current settings" else log_check "Config Cache Content" "PASS" "No conflicts detected" "Performance" "Low" fi else log_check "Config Cache" "WARN" "Configuration not cached (performance impact)" "Performance" "Medium" # Auto-fix: Create config cache apply_fix "Create config cache" "php artisan config:cache 2>/dev/null" "Cache configuration for better performance" fi # C3-11: HTTP Response Test echo "=== HTTP Response Health ===" if [ -f ".env" ]; then APP_URL=$(grep "^APP_URL=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'") if [ -n "$APP_URL" ] && command -v curl &> /dev/null; then echo "? Testing: $APP_URL" HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL" --max-time 10 2>/dev/null || echo "000") case $HTTP_CODE in 200|201|301|302) log_check "HTTP Response" "PASS" "Application responding (HTTP $HTTP_CODE)" "Core" "Critical" ;; 500) log_check "HTTP Response" "FAIL" "HTTP 500 - Internal Server Error" "Core" "Critical" # Try to get more details from Laravel logs if [ -f "storage/logs/laravel.log" ]; then echo " ? Latest Laravel error:" LATEST_ERROR=$(tail -3 storage/logs/laravel.log | grep -E "(ERROR|Exception|Fatal)" | tail -1 | sed 's/^/ /') echo "$LATEST_ERROR" add_action_item "CRITICAL" "Fix HTTP 500 Error" "Website returning server error: $LATEST_ERROR" "Check storage/logs/laravel.log for full error details" else add_action_item "CRITICAL" "Fix HTTP 500 Error" "Website returning server error" "Check application logs and configuration" fi ;; 503) log_check "HTTP Response" "WARN" "HTTP 503 - Service Unavailable (maintenance mode?)" "Core" "Medium" add_action_item "MEDIUM" "Check Maintenance Mode" "Site may be in maintenance mode" "Run: php artisan up" # Auto-fix: Try to exit maintenance mode if [ -f "artisan" ]; then apply_fix "Exit maintenance mode" "php artisan up 2>/dev/null" "Exit Laravel maintenance mode" fi ;; 000) log_check "HTTP Response" "FAIL" "Connection timeout or unreachable" "Core" "Critical" add_action_item "CRITICAL" "Website Unreachable" "Cannot connect to website" "Check server status and DNS configuration" ;; *) log_check "HTTP Response" "WARN" "HTTP $HTTP_CODE - Unexpected response" "Core" "High" add_action_item "HIGH" "Investigate HTTP Response" "Unexpected HTTP code: $HTTP_CODE" "Check web server configuration and application status" ;; esac # Test install page if main page fails if [ "$HTTP_CODE" = "500" ]; then INSTALL_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/install" --max-time 10 2>/dev/null || echo "000") if [ "$INSTALL_CODE" = "200" ]; then log_check "Install Page" "PASS" "Install page accessible (HTTP $INSTALL_CODE)" "Core" "Medium" echo " ? This may be a fresh deployment needing installation" add_action_item "MEDIUM" "Complete Installation" "Fresh deployment detected - installation needed" "Visit: $APP_URL/install" fi fi else log_check "HTTP Response" "WARN" "Cannot test (no APP_URL or curl unavailable)" "Core" "Medium" add_action_item "MEDIUM" "Configure APP_URL" "Cannot test website - APP_URL missing or curl unavailable" "Set APP_URL in .env file" fi else log_check "HTTP Response" "WARN" "Cannot test (missing .env)" "Core" "High" fi # C3-12: Laravel Error Log Analysis echo "=== Error Log Analysis ===" if [ -f "storage/logs/laravel.log" ]; then LOG_SIZE=$(du -sh storage/logs/laravel.log | cut -f1) log_check "Laravel Log File" "PASS" "Exists ($LOG_SIZE)" "Monitoring" "Low" # Check for recent critical errors RECENT_ERRORS=$(tail -100 storage/logs/laravel.log | grep -c -E "(ERROR|CRITICAL|EMERGENCY)" 2>/dev/null || echo "0") if [ "$RECENT_ERRORS" -gt 0 ]; then log_check "Recent Critical Errors" "WARN" "$RECENT_ERRORS errors found in last 100 lines" "Monitoring" "High" RECENT_ERROR=$(tail -100 storage/logs/laravel.log | grep -E "(ERROR|CRITICAL|EMERGENCY)" | tail -1 | sed 's/^/ /') echo " ? Most recent critical error:" echo "$RECENT_ERROR" add_action_item "HIGH" "Investigate Error Log" "$RECENT_ERRORS recent errors found" "Check: tail -20 storage/logs/laravel.log" else log_check "Recent Critical Errors" "PASS" "No critical errors in recent logs" "Monitoring" "Low" fi else log_check "Laravel Log File" "WARN" "No log file found" "Monitoring" "Medium" add_action_item "MEDIUM" "Check Logging Configuration" "No Laravel log file found" "Verify logging is properly configured in config/logging.php" fi # C3-13: Generate Health Summary echo "=== Health Check Summary ===" HEALTH_PERCENTAGE=$(( (PASSED_CHECKS * 100) / TOTAL_CHECKS )) echo "? Overall Health Score: $HEALTH_PERCENTAGE% ($PASSED_CHECKS/$TOTAL_CHECKS checks passed)" echo "? Auto-fixes Applied: $FIXES_APPLIED" echo "⚠️ Issues Found: $ISSUES_FOUND" # Determine overall status if [ $HEALTH_PERCENTAGE -ge 90 ]; then OVERALL_STATUS="? EXCELLENT" echo "✅ Your application is healthy and ready for production!" elif [ $HEALTH_PERCENTAGE -ge 75 ]; then OVERALL_STATUS="? GOOD" echo "✅ Your application is mostly healthy with minor issues." elif [ $HEALTH_PERCENTAGE -ge 50 ]; then OVERALL_STATUS="⚠️ NEEDS ATTENTION" echo "⚠️ Your application has issues that should be addressed." else OVERALL_STATUS="? CRITICAL" echo "❌ Your application has critical issues requiring immediate attention." fi echo "? Status: $OVERALL_STATUS" # C3-14: Create Health Summary Report echo "=== Creating Centralized Health Reports ===" # ENHANCED: Centralized reporting with timestamp folders and latest symlinks TIMESTAMP=$(date +"%Y%m%d_%H%M%S") DOMAIN_ROOT=$(dirname "$DEPLOY_PATH") DOMAIN_NAME=$(basename "$DOMAIN_ROOT") # Create centralized report structure REPORTS_BASE="$DOMAIN_ROOT/deployment-reports" DEPLOYMENT_FOLDER="$REPORTS_BASE/deployments/$TIMESTAMP" LATEST_FOLDER="$REPORTS_BASE/latest" GENERAL_FOLDER="$REPORTS_BASE/general" # Create all report directories mkdir -p "$DEPLOYMENT_FOLDER" mkdir -p "$LATEST_FOLDER" mkdir -p "$GENERAL_FOLDER" echo "? Centralized Report Structure:" echo " Reports Base: $REPORTS_BASE" echo " This Deployment: $DEPLOYMENT_FOLDER" echo " Latest Symlinks: $LATEST_FOLDER" echo " General Reports: $GENERAL_FOLDER" # Define report files for this deployment HEALTH_REPORT="$DEPLOYMENT_FOLDER/health-check.md" ISSUES_REPORT="$DEPLOYMENT_FOLDER/issues-summary.md" VARIABLES_REPORT="$DEPLOYMENT_FOLDER/deployment-variables.md" # C3-15a: Create Deployment Variables Report (integrating variables-definitons.md) echo "? Creating deployment variables report..." cat > "$VARIABLES_REPORT" << EOF # ? Deployment Variables Report **Domain:** $DOMAIN_NAME **Timestamp:** $(date '+%Y-%m-%d %H:%M:%S') **Deployment:** $TIMESTAMP --- ## ? DeployHQ Variables Used Based on **variables-definitons.md**, here are the variables available and used in this deployment: ### **Server / Environment Variables** - **staging** → staging (Server environment) - **/home/u227177893/domains/staging.societypal.com/deploy** → $DEPLOY_PATH (Base server path we're deploying to) ### **Deployment Variables** - **main** → main (The branch of the deployment) - **33** → 33 (Number of deployments in the project) - **Zaj Apps** → Zaj Apps (User who started the deployment) - **Running** → Running (Current deployment status) - **2025-08-20T03:00:10Z** → 2025-08-20T03:00:10Z (Start time) - **** → (Completion time) ### **Revision Variables** - **f6adbf02b5c35c2e49b10683bcdd8c493e6546dc** → f6adbf02b5c35c2e49b10683bcdd8c493e6546dc (Start revision ref) - **f6adbf02b5c35c2e49b10683bcdd8c493e6546dc** → f6adbf02b5c35c2e49b10683bcdd8c493e6546dc (End revision ref) - **f6adbf02b5c35c2e49b10683bcdd8c493e6546dc - f6adbf02b5c35c2e49b10683bcdd8c493e6546dc** → f6adbf02b5c35c2e49b10683bcdd8c493e6546dc - f6adbf02b5c35c2e49b10683bcdd8c493e6546dc (Start and end commit range) ### **Project Variables** - **SocietyPal** → SocietyPal (Project name in DeployHQ) - **https://rovony.deployhq.com/projects/societypal** → https://rovony.deployhq.com/projects/societypal (Project address in DeployHQ) - **https://rovony.deployhq.com/projects/societypal/deployments/ea823b34-89fa-4bc2-9ef8-30ddcb831a2a** → https://rovony.deployhq.com/projects/societypal/deployments/ea823b34-89fa-4bc2-9ef8-30ddcb831a2a (This deployment's address) --- ## ?️ Derived Path Variables All paths derived from **/home/u227177893/domains/staging.societypal.com/deploy** = $DEPLOY_PATH - **DEPLOY_PATH** = $DEPLOY_PATH - **SHARED_PATH** = $SHARED_PATH - **CURRENT_PATH** = $CURRENT_PATH - **DOMAIN_ROOT** = $DOMAIN_ROOT --- ## ? Report Structure - **Base Reports:** $REPORTS_BASE - **This Deployment:** $DEPLOYMENT_FOLDER - **Latest Symlinks:** $LATEST_FOLDER - **General Reports:** $GENERAL_FOLDER --- **Generated:** $(date '+%Y-%m-%d %H:%M:%S') **Reference:** variables-definitons.md EOF echo "✅ Variables report created: $VARIABLES_REPORT" # Start the issues report cat > "$ISSUES_REPORT" << EOF # ? Health Check Issues Summary **Domain:** $DOMAIN_NAME **Timestamp:** $(date '+%Y-%m-%d %H:%M:%S') **Health Score:** $HEALTH_PERCENTAGE% ($PASSED_CHECKS/$TOTAL_CHECKS checks passed) **Status:** $OVERALL_STATUS **Issues Found:** $ISSUES_FOUND **Auto-Fixes Applied:** $FIXES_APPLIED --- EOF # Add TL;DR section if [ $ISSUES_FOUND -eq 0 ]; then cat >> "$ISSUES_REPORT" << EOF ## ? TL;DR - ALL GOOD! ✅ **No issues detected** - Your deployment is healthy and ready for production! All $TOTAL_CHECKS health checks passed successfully. No manual intervention required. EOF else cat >> "$ISSUES_REPORT" << EOF ## ⚠️ TL;DR - ISSUES DETECTED ❌ **$ISSUES_FOUND issues found** that need your attention ? **$FIXES_APPLIED auto-fixes** have been applied automatically ? **Health Score:** $HEALTH_PERCENTAGE% ($([ $HEALTH_PERCENTAGE -ge 75 ] && echo "Good" || echo "Needs Attention")) $([ $FIXES_APPLIED -gt 0 ] && echo "✅ Most common issues have been **automatically fixed**" || echo "⚠️ Manual intervention may be required") EOF fi # Add detailed issues if any found if [ $ISSUES_FOUND -gt 0 ]; then cat >> "$ISSUES_REPORT" << EOF --- ## ? ISSUES BY CATEGORY EOF # Process detailed issues by category if [ -f "/tmp/c3_detailed_issues" ] && [ -s "/tmp/c3_detailed_issues" ]; then # Group issues by category CATEGORIES=($(cut -d'|' -f1 /tmp/c3_detailed_issues | sort -u)) for CATEGORY in "${CATEGORIES[@]}"; do if [ -n "$CATEGORY" ]; then cat >> "$ISSUES_REPORT" << EOF ### $CATEGORY Issues EOF # Add issues for this category grep "^$CATEGORY|" /tmp/c3_detailed_issues | while IFS='|' read -r cat status check details impact; do ICON="⚠️" [ "$status" = "ERROR" ] && ICON="❌" echo "- $ICON **$check** ($impact Impact): $details" >> "$ISSUES_REPORT" done fi done fi # Add auto-fixes applied cat >> "$ISSUES_REPORT" << EOF --- ## ? AUTO-FIXES APPLIED EOF if [ -f "/tmp/c3_fixes_log" ] && [ -s "/tmp/c3_fixes_log" ]; then cat "/tmp/c3_fixes_log" >> "$ISSUES_REPORT" fi if [ $FIXES_APPLIED -eq 0 ]; then echo "- No auto-fixes were applied" >> "$ISSUES_REPORT" fi cat >> "$ISSUES_REPORT" << EOF --- ## ? ACTION ITEMS EOF # Generate prioritized action items if [ -f "/tmp/c3_action_items" ] && [ -s "/tmp/c3_action_items" ]; then # Process action items by priority PRIORITIES=("CRITICAL" "HIGH" "MEDIUM" "LOW") ACTION_COUNT=0 for PRIORITY in "${PRIORITIES[@]}"; do PRIORITY_ITEMS=$(grep "^ACTION|$PRIORITY|" /tmp/c3_action_items 2>/dev/null || true) if [ -n "$PRIORITY_ITEMS" ]; then cat >> "$ISSUES_REPORT" << EOF ### $PRIORITY Priority EOF echo "$PRIORITY_ITEMS" | while IFS='|' read -r type priority title description command; do ACTION_COUNT=$((ACTION_COUNT + 1)) PRIORITY_ICON="?" [ "$priority" = "CRITICAL" ] && PRIORITY_ICON="?" [ "$priority" = "HIGH" ] && PRIORITY_ICON="⚠️" [ "$priority" = "MEDIUM" ] && PRIORITY_ICON="?" cat >> "$ISSUES_REPORT" << EOF $ACTION_COUNT. $PRIORITY_ICON **$title** - **Problem:** $description - **Action:** $command EOF done fi done fi if [ ! -f "/tmp/c3_action_items" ] || [ ! -s "/tmp/c3_action_items" ]; then echo "- All detected issues have been automatically resolved" >> "$ISSUES_REPORT" echo "- Monitor the application for any remaining issues" >> "$ISSUES_REPORT" fi fi # Add quick reference commands cat >> "$ISSUES_REPORT" << EOF --- ## ⚡ QUICK REFERENCE COMMANDS ### Check Current Status: \`\`\`bash # Test website curl -I https://$DOMAIN_NAME # Check Laravel health cd $CURRENT_PATH php artisan about # View latest errors tail -10 storage/logs/laravel.log \`\`\` ### Common Fixes: \`\`\`bash # Fix Redis issues (if applicable) cd $CURRENT_PATH sed -i 's/CACHE_DRIVER=redis/CACHE_DRIVER=file/' .env sed -i 's/SESSION_DRIVER=redis/SESSION_DRIVER=file/' .env php artisan config:clear # Clear all caches php artisan cache:clear php artisan config:clear php artisan route:clear php artisan view:clear # Rebuild caches php artisan config:cache php artisan route:cache php artisan view:cache # Fix dependencies (WARNING: Only run this if build artifacts are completely missing) # composer2 install --no-dev --optimize-autoloader # IMPORTANT: This destroys build artifacts - only use if vendor directory is completely empty \`\`\` ### Get Help: - **Full Report:** \`cat $DOMAIN_ROOT/deployment-reports/latest-report.md\` - **Error Logs:** \`tail -20 $CURRENT_PATH/storage/logs/laravel.log\` - **Health History:** \`cat $SHARED_PATH/health-checks.log\` --- **Next Steps:** 1. Address the action items above (if any) 2. Test your website: https://$DOMAIN_NAME 3. Monitor error logs: \`tail -f $CURRENT_PATH/storage/logs/laravel.log\` **Report Generated:** $(date '+%Y-%m-%d %H:%M:%S') **Complement to:** Phase C-2 Comprehensive Report (\`latest-report.md\`) EOF # C3-17: Enhanced Logging with Centralized Structure echo "=== Enhanced Logging ===" # Log health check results to shared directory HEALTH_LOG="$SHARED_PATH/health-checks.log" echo "[$(date '+%Y-%m-%d %H:%M:%S')] Health Check - Score: $HEALTH_PERCENTAGE% - Status: $OVERALL_STATUS - Issues: $ISSUES_FOUND - Fixes: $FIXES_APPLIED" >> "$HEALTH_LOG" # Log to centralized deployment reports DEPLOYMENT_LOG="$GENERAL_FOLDER/health-history.log" echo "[$(date '+%Y-%m-%d %H:%M:%S')] Health: $HEALTH_PERCENTAGE% | Status: $OVERALL_STATUS | Issues: $ISSUES_FOUND | Fixes: $FIXES_APPLIED | Deployment: $TIMESTAMP" >> "$DEPLOYMENT_LOG" # Create deployment-specific log DEPLOYMENT_SPECIFIC_LOG="$DEPLOYMENT_FOLDER/deployment.log" cat > "$DEPLOYMENT_SPECIFIC_LOG" << EOF # ? Deployment $TIMESTAMP Log **Health Score:** $HEALTH_PERCENTAGE% **Status:** $OVERALL_STATUS **Issues Found:** $ISSUES_FOUND **Auto-Fixes Applied:** $FIXES_APPLIED **Total Checks:** $TOTAL_CHECKS **Passed Checks:** $PASSED_CHECKS **Environment:** staging **Branch:** main **Commit:** f6adbf02b5c35c2e49b10683bcdd8c493e6546dc **Deployer:** Zaj Apps **Deployment Started:** 2025-08-20T03:00:10Z **Deployment Completed:** --- **Reports Generated:** - Health Check: health-check.md - Issues Summary: issues-summary.md - Variables Used: deployment-variables.md **Reference:** variables-definitons.md EOF log_check "Health Check Logging" "PASS" "Results logged to centralized structure" "Monitoring" "Low" # C3-16: Create Centralized Symlinks and Access Points echo "=== Creating Centralized Access Points ===" # Set permissions on all reports chmod 644 "$HEALTH_REPORT" "$ISSUES_REPORT" "$VARIABLES_REPORT" # Create latest symlinks in latest folder cd "$LATEST_FOLDER" rm -f health-check.md issues-summary.md deployment-variables.md ln -sf "../deployments/$TIMESTAMP/health-check.md" health-check.md ln -sf "../deployments/$TIMESTAMP/issues-summary.md" issues-summary.md ln -sf "../deployments/$TIMESTAMP/deployment-variables.md" deployment-variables.md # Create general access points cd "$GENERAL_FOLDER" rm -f latest-health.md latest-issues.md latest-variables.md ln -sf "../latest/health-check.md" latest-health.md ln -sf "../latest/issues-summary.md" latest-issues.md ln -sf "../latest/deployment-variables.md" latest-variables.md # Create deployment index DEPLOYMENT_INDEX="$GENERAL_FOLDER/deployment-index.md" echo "? Creating deployment index..." cat > "$DEPLOYMENT_INDEX" << EOF # ? Deployment Reports Index **Domain:** $DOMAIN_NAME **Last Updated:** $(date '+%Y-%m-%d %H:%M:%S') --- ## ? Quick Access ### **Latest Reports** - **Health Check:** [latest-health.md](latest-health.md) - **Issues Summary:** [latest-issues.md](latest-issues.md) - **Variables Used:** [latest-variables.md](latest-variables.md) ### **This Deployment ($TIMESTAMP)** - **Health Check:** [deployments/$TIMESTAMP/health-check.md](deployments/$TIMESTAMP/health-check.md) - **Issues Summary:** [deployments/$TIMESTAMP/issues-summary.md](deployments/$TIMESTAMP/issues-summary.md) - **Variables Used:** [deployments/$TIMESTAMP/deployment-variables.md](deployments/$TIMESTAMP/deployment-variables.md) --- ## ? Report Structure \`\`\` deployment-reports/ ├── deployments/ │ └── $TIMESTAMP/ # This deployment │ ├── health-check.md │ ├── issues-summary.md │ └── deployment-variables.md ├── latest/ # Symlinks to latest deployment │ ├── health-check.md → ../deployments/$TIMESTAMP/health-check.md │ ├── issues-summary.md → ../deployments/$TIMESTAMP/issues-summary.md │ └── deployment-variables.md → ../deployments/$TIMESTAMP/deployment-variables.md └── general/ # General access points ├── latest-health.md → ../latest/health-check.md ├── latest-issues.md → ../latest/issues-summary.md ├── latest-variables.md → ../latest/deployment-variables.md └── deployment-index.md (this file) \`\`\` --- ## ? Recent Deployments EOF # Add recent deployments to index if [ -d "$REPORTS_BASE/deployments" ]; then echo "Recent deployments:" >> "$DEPLOYMENT_INDEX" echo "\`\`\`" >> "$DEPLOYMENT_INDEX" ls -1t "$REPORTS_BASE/deployments" 2>/dev/null | head -10 | while read deploy_dir; do if [ -d "$REPORTS_BASE/deployments/$deploy_dir" ]; then DEPLOY_TIME=$(echo "$deploy_dir" | sed 's/\([0-9]\{8\}\)_\([0-9]\{6\}\)/\1 \2/' | sed 's/\([0-9]\{4\}\)\([0-9]\{2\}\)\([0-9]\{2\}\) \([0-9]\{2\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)/\1-\2-\3 \4:\5:\6/') echo "$deploy_dir → $DEPLOY_TIME" >> "$DEPLOYMENT_INDEX" fi done echo "\`\`\`" >> "$DEPLOYMENT_INDEX" fi cat >> "$DEPLOYMENT_INDEX" << EOF --- **Generated:** $(date '+%Y-%m-%d %H:%M:%S') **Reference:** variables-definitons.md EOF echo "✅ Centralized reports created:" echo " ? Health Report: $HEALTH_REPORT" echo " ? Issues Report: $ISSUES_REPORT" echo " ? Variables Report: $VARIABLES_REPORT" echo " ? Deployment Index: $DEPLOYMENT_INDEX" echo "" echo "? Quick Access Points:" echo " ? Latest Health: $GENERAL_FOLDER/latest-health.md" echo " ? Latest Issues: $GENERAL_FOLDER/latest-issues.md" echo " ? Latest Variables: $GENERAL_FOLDER/latest-variables.md" echo " ? All Deployments: $DEPLOYMENT_INDEX" # Display final summary echo "" echo "? ===============================================" echo "? PHASE C-3 COMPREHENSIVE HEALTH CHECK COMPLETE" echo "? ===============================================" echo "" echo "? Final Health Score: $HEALTH_PERCENTAGE% - $OVERALL_STATUS" echo "? Auto-Fixes Applied: $FIXES_APPLIED" echo "⚠️ Issues Found: $ISSUES_FOUND" echo "" if [ $ISSUES_FOUND -eq 0 ]; then echo "? No issues detected - deployment is healthy!" echo "✅ Your application is ready for production!" else echo "⚠️ $ISSUES_FOUND issues found - check the centralized reports for details" echo "? $FIXES_APPLIED auto-fixes have been applied automatically" echo "" echo "? Quick Issues Summary:" if [ -f "/tmp/c3_issues_log" ] && [ -s "/tmp/c3_issues_log" ]; then head -3 /tmp/c3_issues_log | sed 's/^/ /' if [ $(wc -l < /tmp/c3_issues_log) -gt 3 ]; then echo " ... and $(($(wc -l < /tmp/c3_issues_log) - 3)) more (see centralized reports)" fi fi fi echo "" echo "? CENTRALIZED REPORTS CREATED:" echo " ? Quick Access: $GENERAL_FOLDER/deployment-index.md" echo " ? Latest Health: $GENERAL_FOLDER/latest-health.md" echo " ? Latest Issues: $GENERAL_FOLDER/latest-issues.md" echo " ? Variables Used: $GENERAL_FOLDER/latest-variables.md" echo "" # C3-16: Cleanup temporary files echo "=== Cleanup ===" rm -f /tmp/c3_issues_log /tmp/c3_fixes_log /tmp/c3_detailed_issues /tmp/c3_action_items echo "✅ Temporary files cleaned up" # Exit with appropriate code (but don't fail deployment) if [ $HEALTH_PERCENTAGE -ge 50 ]; then echo "✅ Phase C-3 completed successfully" exit 0 else echo "⚠️ Critical issues detected but deployment continues" echo "✅ Phase C-3 completed with warnings" exit 0 # Don't fail deployment, just warn fi]

=== Phase C-3: Comprehensive Health Check & Auto-Fix ===
? Path Variables (derived from /home/u227177893/domains/staging.societypal.com/deploy):
   Base Deploy Path: /home/u227177893/domains/staging.societypal.com/deploy
   Current Path: /home/u227177893/domains/staging.societypal.com/deploy/current
   Shared Path: /home/u227177893/domains/staging.societypal.com/deploy/shared
? Starting comprehensive health checks...
=== Laravel Framework Health ===
✅ Laravel Framework: Laravel Framework 12.17.0
=== Environment Configuration ===
✅ Environment File: .env file exists and readable
✅ Required Var: APP_KEY: Set
✅ Required Var: DB_DATABASE: Set
✅ Required Var: DB_USERNAME: Set
✅ Required Var: DB_PASSWORD: Set
=== Database Connection ===
✅ Database Connection: Connected successfully
=== Cache System Health ===
? Cache driver: file
Time taken to run 8. Phase C-3: Comprehensive Health Check & Auto-Fix - V2: 2.09 seconds


Cleaning up old releases

Removed old release at /home/u227177893/domains/staging.societypal.com/deploy/releases/20250819214954

