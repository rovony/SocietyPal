## EXPERT 2 Ideas:
---
# Universal, Conditional Build Pipeline for Any Laravel Application

The following Bash script implements a **self‐configuring**, **multi‐stage** build pipeline that detects and installs only the necessary dev-dependencies (PHP or JavaScript) for **any** Laravel project—regardless of version or whether it has a frontend. After building, it prunes out dev-only packages to produce a minimal production artifact.

```bash
#!/usr/bin/env bash
set -euo pipefail

###############################################################################
# Stage 0: Environment Sanity Checks
###############################################################################
echo "=== Stage 0: Environment Sanity Checks ==="
# Prevent running as root
if [ "$EUID" -eq 0 ]; then
  echo "❌ Do not run as root"; exit 1
fi

# Ensure in project root (must contain composer.json)
if [ ! -f composer.json ]; then
  echo "❌ composer.json not found—run from Laravel project root"; exit 1
fi

###############################################################################
# Stage 1: Inspect Code for Dev-Dependency Needs
###############################################################################
echo -e "\n=== Stage 1: Inspecting for dev-dependency needs ==="
# 1A: PHP dev-deps?
#   If composer.json has non-empty require-dev, we may need them.
NEEDS_PHP_DEV=$(jq -r '.["require-dev"] | keys | length' composer.json)
echo "PHP dev-dependencies declared? $([[ $NEEDS_PHP_DEV -gt 0 ]] && echo yes || echo no)"

# 1B: Faker usage in migrations/seeders?
if grep -R "Faker\\" database/migrations database/seeders &>/dev/null; then
  echo "Faker detected in migrations/seeders → will install PHP dev-deps"
  NEEDS_PHP_DEV=1
fi

# 1C: JavaScript dev-deps?
NEEDS_JS_DEV=false
if [ -f package.json ]; then
  # Has any devDependencies?
  if jq -e '.["devDependencies"] | length > 0' package.json &>/dev/null; then
    NEEDS_JS_DEV=true
  fi

  # Has build scripts?
  if jq -e '.scripts | has("build") or has("production") or has("prod")' package.json &>/dev/null; then
    echo "JS build scripts found → will install JS dev-deps"
    NEEDS_JS_DEV=true
  fi
fi
echo "JS dev-dependencies needed? $NEEDS_JS_DEV"

###############################################################################
# Stage 2: Install PHP Dependencies
###############################################################################
echo -e "\n=== Stage 2: Installing PHP dependencies ==="
export COMPOSER_MEMORY_LIMIT=-1
if [ "$NEEDS_PHP_DEV" -gt 0 ]; then
  composer install --prefer-dist --no-interaction --optimize-autoloader --no-progress
else
  composer install --prefer-dist --no-dev --optimize-autoloader --no-interaction --no-progress
fi

###############################################################################
# Stage 3: Install JavaScript Dependencies (if any)
###############################################################################
if [ -f package.json ]; then
  echo -e "\n=== Stage 3: Installing Node.js dependencies ==="
  if [ "$NEEDS_JS_DEV" = true ]; then
    npm ci --no-audit --no-fund
  else
    npm ci --production --no-audit --no-fund
  fi
else
  echo -e "\n=== Stage 3: No package.json—skipping JS dependencies ==="
fi

###############################################################################
# Stage 4: Build & Optimize
###############################################################################
echo -e "\n=== Stage 4A: Optimizing PHP autoloader ==="
composer dump-autoload --optimize --classmap-authoritative

echo -e "\n=== Stage 4B: Building frontend assets (if applicable) ==="
if [ -f package.json ] && [ "$NEEDS_JS_DEV" = true ]; then
  # Try common Laravel frontend build commands
  if npm run build   2>/dev/null; then
    echo "✅ Built with npm run build"
  elif npm run production 2>/dev/null; then
    echo "✅ Built with npm run production"
  elif npm run prod 2>/dev/null; then
    echo "✅ Built with npm run prod"
  else
    echo "ℹ️ No build script—skipping asset compilation"
  fi

  # Prune dev-deps for production artifact
  echo -e "\nCleaning up dev-dependencies and reinstalling production JS packages..."
  rm -rf node_modules
  npm ci --production --no-audit --no-fund
fi

###############################################################################
# Stage 5: Prepare Directories & Permissions
###############################################################################
echo -e "\n=== Stage 5: Creating Laravel directories & setting permissions ==="
mkdir -p bootstrap/cache storage/{app/public,framework/{cache/data,sessions,views},logs} public/storage
chmod -R 755 bootstrap/cache
find storage -type d -exec chmod 775 {} \;
find storage -type f -exec chmod 664 {} \;

###############################################################################
# Stage 6: Package Artifact
###############################################################################
echo -e "\n=== Stage 6: Packaging production artifact ==="
tar czf artifact.tgz \
  vendor \
  composer.json composer.lock \
  public/build public/dist public/js public/css public/assets \
  bootstrap/cache \
  storage \
  app resources/views routes

echo "✅ Artifact created: artifact.tgz"

###############################################################################
# Summary
###############################################################################
echo -e "\n=== Build Summary ==="
echo "• PHP dev-deps installed?  $( [ $NEEDS_PHP_DEV -gt 0 ] && echo yes || echo no )"
echo "• JS dev-deps installed?   $NEEDS_JS_DEV"
echo "• Built frontend assets?    $( [ -d public/build ] && echo yes || echo no )"
echo "• Production artifact:      artifact.tgz"
```

***

### How It Works

- **Stage 1** scans `composer.json` and your migrations/seeders for any dev-only requirements, and inspects `package.json` for JS build needs.
- **Stages 2 & 3** install **only** runtime dependencies by default, adding dev-packages **only** if flagged.
- **Stage 4** builds PHP autoload and, if JS build is needed, compiles assets, then prunes dev-deps for a lean runtime footprint.
- **Stage 5** ensures your Laravel directory structure and permissions are correct.
- **Stage 6** packages everything that Laravel needs at runtime (no dev-deps left) into a single tarball ready for deployment.

This single script adapts to any Laravel application—**no per-project customization needed**—and ensures your production servers receive only the minimal, optimized artifact.
